// Sir Trevor, v0.0.1

(function(a,b){function g(a){var c={};return b.each(a,function(d,e){c[b.isArray(a)?d:e]=!0}),c}function h(a){a.preventDefault(),a.stopPropagation()}function i(a){return a.which==17||a.which==224}function j(a,b,c){var d=a.offset().left-b,e=a.offset().top-b,f=d+a.width()+2*b,g=e+a.height()+2*b,h=c.pageX,i=c.pageY;return h>d&&h<f&&i>e&&i<g}function n(a){return a.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}var c=this,d;d=c.SirTrevor={},d.DEFAULTS={baseCSSClass:"sir-trevor",blockStore:{data:[]},defaultType:"Text",spinner:{className:"spinner",lines:9,length:6,width:2,radius:5,color:"#000",speed:1.4,trail:57,shadow:!1},marker:{baseCSSClass:"marker",buttonClass:"button",addText:"Click to add:",dropText:"Drop to place content"},formatBar:{baseCSSClass:"formatting-control"},blockLimit:0,blockTypeLimits:{},uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/"},d.BlockTypes={},d.Formatters={},d.instances=[];var e=!1,f={bound:[],_bindFunctions:function(){var a=[];a.push(this),a.join(this.bound),b.bindAll.apply(this,a)}};(function(a){function b(b){return a(b.target).addClass("dragOver"),h(b),!1}function c(a){return a.originalEvent.dataTransfer.dropEffect="copy",h(a),!1}function d(b){return a(b.target).removeClass("dragOver"),h(b),!1}a.fn.dropArea=function(){return this.bind("dragenter",b).bind("dragover",c).bind("dragleave",d),this}})(jQuery);var k=function(a,b){return m(this,a,b)},l=function(){},m=function(a,c,d){var e;return c&&c.hasOwnProperty("constructor")?e=c.constructor:e=function(){a.apply(this,arguments)},b.extend(e,a),l.prototype=a.prototype,e.prototype=new l,c&&b.extend(e.prototype,c),d&&b.extend(e,d),e.prototype.constructor=e,e.__super__=a.prototype,e},o=a({});a.subscribe=function(){o.on.apply(o,arguments)},a.unsubscribe=function(){o.off.apply(o,arguments)},a.publish=function(){o.trigger.apply(o,arguments)},function(a,b,c){function d(a){var b={x:a.offsetLeft,y:a.offsetTop};while(a=a.offsetParent)b.x+=a.offsetLeft,b.y+=a.offsetTop;return b}function e(a){for(var b=1;b<arguments.length;b++){var d=arguments[b];for(var e in d)a[e]===c&&(a[e]=d[e])}return a}function f(a,b){for(var c in b)a.style[g(a,c)||c]=b[c];return a}function g(a,b){var d=a.style,e,f;if(d[b]!==c)return b;b=b.charAt(0).toUpperCase()+b.slice(1);for(f=0;f<k.length;f++){e=k[f]+b;if(d[e]!==c)return e}}function h(a,b,c,d){var e=["opacity",b,~~(a*100),c,d].join("-"),f=.01+c/d*100,g=Math.max(1-(1-a)/b*(100-f),a),h=m.substring(0,m.indexOf("Animation")).toLowerCase(),i=h&&"-"+h+"-"||"";return l[e]||(n.insertRule("@"+i+"keyframes "+e+"{"+"0%{opacity:"+g+"}"+f+"%{opacity:"+a+"}"+(f+.01)+"%{opacity:1}"+(f+b)%100+"%{opacity:"+a+"}"+"100%{opacity:"+g+"}"+"}",0),l[e]=1),e}function i(a,b,c){return c&&!c.parentNode&&i(a,c),a.insertBefore(b,c||null),a}function j(a,c){var d=b.createElement(a||"div"),e;for(e in c)d[e]=c[e];return d}var k=["webkit","Moz","ms","O"],l={},m,n=function(){var a=j("style");return i(b.getElementsByTagName("head")[0],a),a.sheet||a.styleSheet}(),o=function r(a){if(!this.spin)return new r(a);this.opts=e(a||{},r.defaults,p)},p=o.defaults={lines:12,length:7,width:5,radius:10,color:"#000",speed:1,trail:100,opacity:.25,fps:20},q=o.prototype={spin:function(a){this.stop();var b=this,c=b.el=f(j(),{position:"relative"}),e,g;a&&(g=d(i(a,c,a.firstChild)),e=d(c),f(c,{left:(a.offsetWidth>>1)-e.x+g.x+"px",top:(a.offsetHeight>>1)-e.y+g.y+"px"})),c.setAttribute("aria-role","progressbar"),b.lines(c,b.opts);if(!m){var h=b.opts,k=0,l=h.fps,n=l/h.speed,o=(1-h.opacity)/(n*h.trail/100),p=n/h.lines;(function q(){k++;for(var a=h.lines;a;a--){var d=Math.max(1-(k+a*p)%n*o,h.opacity);b.opacity(c,h.lines-a,d,h)}b.timeout=b.el&&setTimeout(q,~~(1e3/l))})()}return b},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=c),this}};q.lines=function(a,b){function c(a,c){return f(j(),{position:"absolute",width:b.length+b.width+"px",height:b.width+"px",background:a,boxShadow:c,transformOrigin:"left",transform:"rotate("+~~(360/b.lines*d)+"deg) translate("+b.radius+"px"+",0)",borderRadius:(b.width>>1)+"px"})}var d=0,e;for(;d<b.lines;d++)e=f(j(),{position:"absolute",top:1+~(b.width/2)+"px",transform:"translate3d(0,0,0)",opacity:b.opacity,animation:m&&h(b.opacity,b.trail,d,b.lines)+" "+1/b.speed+"s linear infinite"}),b.shadow&&i(e,f(c("#000","0 0 4px #000"),{top:"2px"})),i(a,i(e,c(b.color,"0 0 1px rgba(0,0,0,.1)")));return a},q.opacity=function(a,b,c){b<a.childNodes.length&&(a.childNodes[b].style.opacity=c)},function(){var a=f(j("group"),{behavior:"url(#default#VML)"}),b;if(!g(a,"transform")&&a.adj){for(b=4;b--;)n.addRule(["group","roundrect","fill","stroke"][b],"behavior:url(#default#VML)");q.lines=function(a,b){function c(a,c,g){i(h,i(f(d(),{rotation:360/b.lines*a+"deg",left:~~c}),i(f(j("roundrect",{arcsize:1}),{width:e,height:b.width,left:b.radius,top:-b.width>>1,filter:g}),j("fill",{color:b.color,opacity:b.opacity}),j("stroke",{opacity:0}))))}function d(){return f(j("group",{coordsize:g+" "+g,coordorigin:-e+" "+ -e}),{width:g,height:g})}var e=b.length+b.width,g=2*e,h=d(),k=~(b.length+b.radius+b.width)+"px",l;if(b.shadow)for(l=1;l<=b.lines;l++)c(l,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(l=1;l<=b.lines;l++)c(l);return i(f(a,{margin:k+" 0 0 "+k,zoom:1}),h)},q.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&b+d<e.childNodes.length&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}}else m=g(a,"animation")}(),a.Spinner=o}(window,document);if(!p)var p={};(function(b,c){var d=function(a,b){this.config=b||{},this.prepareImageFromFile(a)};d.prototype={init:function(c){var d=this.config,e=d.preview||b.querySelector("#preview"),f=this.editorWidth=d.editorWidth||580,g=this.transmitWidth=d.maxWidth||1e3;if(c.width<g||c.height<~~(.5625*g)){a.publish("/editor/notice",["The image is too small - it will be scaled up and will appear pixelated.",this.config.id]);var h=this.scale(g,c,!1,!1);c.width=h.width,c.height=h.height}this.letterboxHeight=40;var i=g/c.width*100;this.cropRatio=g/f,this.isPanning=!1;var j=this.cropCanvas=this.createCanvas(this.transmitWidth,c);this.canvas=this.createCanvas(this.editorWidth,c),this.maxWidth=Math.round(f*100/i),this.img=c,this.origin={x:0,y:0},this.scaleImg=this.cacheScale=this.canvas.scale;var k=this.canvas;this.resizeAmt=this.maxWidth*5/100;var l=b.createElement("div");l.className="crop-parent",l.style.width=f+"px",k.parent=l,this.start(k),l.appendChild(k.canvas),e.appendChild(l),this.createUIElement(k,"zoomin","+","top"),this.createUIElement(k,"zoomout","-","top"),this.createUIElement(k,"crop","crop","bottom"),this.createUIElement(k,"reset","reset","bottom"),this.createUIElement(k,"change","change image","bottom"),l=null,k=null,e=null,d=null,a.publish("/editor/cropready",this.config.id)},handleEvent:function(a){a.preventDefault();switch(a.type){case"mousedown":this.mousedown(a);break;case"mousemove":this.mousemove(a);break;case"mouseup":case"mouseleave":case"mouseout":this.mouseup(a);break;case"load":break;case"click":switch(a.target.dataset.ui){case"crop":this.crop();break;case"change":this.change();break;case"reset":this.reset();break;default:this.zoom(a,this.resizeAmt)}}},scale:function(a,b,c,d){var e=b.width,f=b.height,g=Math.min(a/e,f),h=~~(.5625*a);return g=c&&g>1?1:g,e=parseInt(e*g,10),f=parseInt(f*g,10),!d&&f<h&&(e=h/f*e,f=h),{width:Math.round(e),height:Math.round(f)}},createCanvas:function(a,c){var d=b.createElement("canvas"),e=Math.round(.5625*a),f=this.scale(a,c,!1,!1),g=(f.height-e)/2,h=this.letterboxHeight;return g=g<0?0:g,d.width=a,d.height=f.height,g>h&&(g=h,d.height=e+h*2),{width:a,height:d.height,canvas:d,ctx:d.getContext("2d"),scale:f,maskHeight:g,maskOffset:e+g,ratioHeight:e}},start:function(a){var b=a.canvas,d=this.origin;a.parent.classList.add("active"),b.addEventListener("mousedown",this,!1),b.addEventListener("mousemove",this,!1),b.addEventListener("mouseup",this,!1),b.addEventListener("mouseleave",this,!1),c.addEventListener("mouseup",this,!1),this.draw(d),a.ctx.translate(d.x,d.y)},end:function(a){var b=a.canvas;a.parent&&a.parent.classList.remove("active"),b.removeEventListener("mousedown",this,!1),b.removeEventListener("mousemove",this,!1),b.removeEventListener("mouseup",this,!1),b.removeEventListener("mouseleave",this,!1),c.removeEventListener("mouseup",this,!1)},letterBox:function(a){var b=this.canvas,c=b.width,d=b.maskHeight;a.save(),a.setTransform(1,0,0,1,0,0),a.fillStyle="rgba(0,0,0,0.6)",a.fillRect(0,0,c,d),a.fillRect(0,b.maskOffset,c,d),a.restore()},position:function(a){return{x:a.layerX,y:a.layerY}},createUIElement:function(a,c,d,e){var f=b.createElement("a");f.textContent=d,f.dataset.ui=c,f.className=c+" crop-ui",f.addEventListener("click",this,!1),f.style[e]=(c==="zoomout"?a.maskHeight+30:a.maskHeight+10)+"px",a.parent.insertBefore(f,a.canvas)},zoom:function(b,c){c=c||1;var d=b.target,e=this.scaleImg,f=e.width,g=b.wheelDeltaY||!1;f+=d.dataset.ui==="zoomin"?c:-c,f>this.maxWidth?a.publish("/editor/notice",["The image will appear pixelated if you continue to increase the size.",this.config.id]):a.publish("/editor/clearnotice",[this.config.id]),f<this.editorWidth&&(f=this.editorWidth);var h=this.scale(f,e,!1,!0);h.height<Math.round(.5625*this.editorWidth)&&(h=this.cacheScale),this.scaleImg=h,this.move={x:~~((h.width-e.width)/2*-1),y:~~((h.height-e.height)/2*-1)},this.draw(this.move),this.checkBounds()},mousedown:function(a){this.isPanning=!0,this.postStart=this.position(a)},mousemove:function(a){if(!this.isPanning)return;var b=this.position(a),c=this.postStart,d=this.move={x:b.x-c.x,y:b.y-c.y};this.draw(d)},mouseup:function(a){if(!this.isPanning)return;this.isPanning=!1,this.checkBounds()},checkBounds:function(){var a=this.move,b=this.origin,c=this.scaleImg,d=this.canvas,e=d.maskHeight,f={x:0,y:0},g=d.ctx;b.x+=a.x,b.y+=a.y,g.translate(a.x,a.y);var h=c.width+b.x;h>=c.width&&(f.x=-b.x),h<=d.width&&(f.x=d.width-h);var i=c.height+b.y,j=d.maskOffset;i>=c.height+e&&(f.y=-b.y+e),i<=j&&(f.y=j-i);if(f.y===0&&f.x===0)return;this.draw(f),g.translate(f.x,f.y),b.x+=f.x,b.y+=f.y},draw:function(a){a=a||{};var b=this.scaleImg,c=this.canvas,d=c.ctx;this.fillBackground(d,c.width,c.height),d.drawImage(this.img,a.x||0,a.y||0,b.width,b.height),this.letterBox(d)},destroy:function(){var a=this.canvas,b=a.parent;b&&(b.parentNode.removeChild(b),b=null),this.end(a),this.canvas=null,this.cropCanvas=null},change:function(){this.destroy(),a.publish("/editor/change",[this.config.id])},reset:function(){var a=this.canvas;this.origin={x:0,y:0},this.scaleImg=this.cacheScale,a.canvas.height=a.height,this.start(a)},fillBackground:function(a,b,c){a.save(),a.setTransform(1,0,0,1,0,0),a.fillStyle="rgba(255,255,255,1)",a.fillRect(0,0,b,c),a.restore()},crop:function(){var b=this.canvas,c=b.maskHeight,d=this.scaleImg,e=b.ctx,f=this.origin;b.canvas.height-=c*2,e.drawImage(this.img,f.x,f.y-c,d.width,d.height);var g=this.cropCanvas,h=g.ctx;g.canvas.height=g.ratioHeight,this.fillBackground(h,g.canvas.width,g.canvas.height);var i=Math.round(d.height*this.cropRatio),j=Math.round(d.width*this.cropRatio);i=i<g.ratioHeight?g.ratioHeight:i,j=j<g.ratioWidth?g.width:j,h.drawImage(this.img,f.x*this.cropRatio,(f.y-g.maskHeight)*this.cropRatio,j,i),this.end(b),a.publish("/editor/crop",[g.canvas.toDataURL("image/jpeg"),this.config.id])},prepareImageFromFile:function(){return!1}};var e=typeof URL!="undefined"?URL:typeof webkitURL!="undefined"?webkitURL:null;if(e&&typeof e.createObjectURL=="function")d.prototype.prepareImageFromFile=function(a){var c=this,d=b.createElement("img");d.src=e.createObjectURL(a),d.onload=function(){e.revokeObjectURL(this.src),c.init(this)}};else if(typeof FileReader!="undefined"&&typeof FileReader.prototype.readAsDataURL=="function")d.prototype.handleImage=function(a){function e(){c.init(this)}var c=this,d=new FileReader;d.readAsDataURL(a),d.onload=function(a){var c=b.createElement("img");c.src=a.target.result,c.onload=e}};else throw"Browser does not support createObjectUrl or fileReader - cannot continue";p.CroppingTool=d})(document,window),function(a){var b={init:function(b){return this.each(function(){a(this).parents(".image_block").length==0&&a(this).wrap(a("<div>",{"class":"image_block"})),a(this).parents(".dropzone").length==0&&a(this).wrap(a("<div>",{"class":"dropzone",dropzone:"move copy"})),a(this).parents(".dropzone").siblings(".image_editor").length==0&&a(this).parents(".dropzone").before(a("<div>",{"class":"image_editor"})),a(this).data("image_editor",{block:a(this).parents(".image_block"),dropzone:a(this).parents(".dropzone"),editor:a(this).parents(".dropzone").siblings(".image_editor")}),dom=a(this).data("image_editor"),dom.editor.prepend('<span class="image_preview"></span>'),dom.dropzone.append("<button>...or choose file</button>"),dom.dropzone.prepend(dom.dropzone.siblings("label")),dom.preview=dom.editor.find(".image_preview"),a.isEmptyObject(a(this).data("json"))?dom.editor.hide():(dom.dropzone.hide(),dom.editor.show(),dom.preview.append(a("<img>",{src:a(this).data("json").post.url})),dom.preview.append('<a class="change non_canvas crop-ui">change image</a>'),dom.preview.find(".change").on("click",function(b){input=a(this).parents(".image_block").find('input[type="file"]'),dom=a(input).data("image_editor"),dom.dropzone.show(),dom.editor.hide()})),a(this).bind("click",function(a){a.stopPropagation()}),dom.dropzone.find("button").bind("click",function(a){a.preventDefault()}),a(this).on("change",function(b){b.currentTarget.files[0].type.match(/image.*/)&&a(this).image_editor("load_editor",b.currentTarget.files[0])}),dom.block.not(".sedit_block").on("drop",function(b){typeof editor!="undefined"&&editor.hide_marker(),a(".image_block").removeClass("dragover"),input=a(this).find('input[type="file"]'),b.preventDefault(),b.stopPropagation(),b=b.originalEvent.dataTransfer,a.inArray("Files",b.types)!=-1&&(b.files[0].type.match(/image.*/)?a(input).image_editor("load_editor",b.files[0]):a(input).preview_error("Image format not recognised."))}),dom.dropzone.parents(".image_block").not(".sedit_block").bind("dragover",function(b){target=a(b.target),target.hasClass(".image_block")||(target=a(target.parents(".image_block")[0])),target.length>0&&target.addClass("dragover"),b.preventDefault()}.bind(this)).bind("dragleave",function(b){a(".image_block").removeClass("dragover")}),a.unsubscribe("/editor/crop"),a.subscribe("/editor/crop",function(b,c,d){a(d).image_editor("clear_errors"),a(d).parents("form").find('[type="submit"]').each(function(b,c){a(c).is(":disabled")||a(c).attr("disabled","disabled").data("label",a(c).val()).val("Please wait...")}),a.ajax({type:"POST",url:"/images",data:{image:c},dataType:"json",context:a(d),success:function(b,c,d){b.file!==undefined&&a.isArray(b.file)?a(this).image_editor("show_error","Image could not be saved: "+b.file[0]):b.file!==undefined&&b.id!==undefined&&(b.file.id=b.id,a(this).data("json",b.file))},error:function(){a(this).image_editor("show_error","Image could not be saved.")},complete:function(){a(this).parents("form").find('[type="submit"]').each(function(b,c){a(c).is(":disabled")&&a(c).removeAttr("disabled").val(a(c).data("label"))})}})}),a.unsubscribe("/editor/cropready"),a.subscribe("/editor/cropready",function(b,c){dom=a(c).data("image_editor"),dom.dropzone.hide(),dom.editor.show()}),a.unsubscribe("/editor/change"),a.subscribe("/editor/change",function(b,c){dom=a(c).data("image_editor"),a(c).image_editor("clear_errors"),dom.dropzone.show(),dom.editor.hide()}),a.unsubscribe("/editor/notice"),a.subscribe("/editor/notice",function(b,c,d){a(d).image_editor("show_error",c)}),a.unsubscribe("/editor/clearnotice"),a.subscribe("/editor/clearnotice",function(b,c){a(c).image_editor("clear_errors")})})},load_editor:function(b){return this.each(function(){dom=a(this).data("image_editor"),a(this).image_editor("clear_errors"),dom.preview.html(""),new p.CroppingTool(b,{preview:dom.preview[0],editorWidth:dom.preview.width(),maxWidth:1e3,id:a(this)})})},show_error:function(b){return this.each(function(){dom=a(this).data("image_editor"),dom.block.addClass("field_with_errors"),dom.block.find(".error").remove(),dom.block.prepend('<p class="error">'+b+"</p>")})},clear_errors:function(){return this.each(function(){dom=a(this).data("image_editor"),dom.block.removeClass("field_with_errors"),dom.block.find(".sedit_block_editor").removeClass("field_with_errors"),dom.block.find(".error").remove()})}};a.fn.image_editor=function(c){if(b[c])return b[c].apply(this,Array.prototype.slice.call(arguments,1));if(typeof c=="object"||!c)return b.init.apply(this,arguments);a.error("Method "+c+" does not exist on jQuery.image_preview")}}(jQuery);var q=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;b.mixin({isURI:function(a){return q.test(a)},capitalize:function(a){return a.charAt(0).toUpperCase()+a.substring(1).toLowerCase()}});var r=d.BlockType=function(a){this.instances={},this.instanceCount=0,this._configure(a||{}),this.blockTypeID=b.uniqueId(this.className+"-"),this.initialize.apply(this,arguments)},s=["className","toolbarEnabled","dropEnabled","title","limit","editorHTML","dropzoneHTML","validate","loadData","toData","onDrop","onContentPasted","onBlockRender","beforeBlockRender","onBlockActivated","toMarkdown","toHTML"];b.extend(r.prototype,{className:"",title:"",limit:0,editorHTML:"<div></div>",dropzoneHTML:'<div class="dropzone"><p>Drop content here</p></div>',toolbarEnabled:!0,dropEnabled:!1,initialize:function(){},loadData:function(a){},onBlockRender:function(){},beforeBlockRender:function(){},onBlockActivated:function(){},onDrop:function(a){},toMarkdown:function(a){return a},toHTML:function(a){return a},toData:function(){var c=this.$el,d=c.data("block"),e;this.$(".text-block").length>0&&(e=this.$(".text-block").html(),e.length>0&&(d.data.text=this.instance._toMarkdown(e,this.type)));var f=!b.isUndefined(d.data.text)||this.$(".text-block").length===0;this.$('input[type="text"]').not(".paste-block").length>0&&this.$('input[type="text"]').each(function(b,c){c=a(c),c.val().length>0&&f&&(d.data[c.attr("name")]=c.val())}),this.$("select").each(function(b,c){c=a(c),c.val().length>0&&f&&(d.data[c.attr("name")]=c.val())}),this.$('input[type="file"]').each(function(b,c){c=a(c),d.data.file=c.data("json")})},validate:function(){var c=this.$(".required"),d=0;return b.each(c,b.bind(function(b){b=a(b);var c=b.attr("contenteditable")?b.text():b.val();c.length===0&&(b.addClass("error").before(a("<div>",{"class":"error-marker",html:"!"})),d++)},this)),d===0},onContentPasted:function(a){var b=this.$(".text-block");b.length>0&&b.html(this.instance._toHTML(this.instance._toMarkdown(b.html(),this.type)))},blockType:function(){var a="";for(var b in d.BlockTypes)d.BlockTypes[b]==this&&(a=b);return a},_configure:function(a){this.options&&(a=b.extend({},this.options,a));for(var c=0,d=s.length;c<d;c++){var e=s[c];a[e]&&(this[e]=a[e])}this.options=a}}),r.extend=k;var t=d.Block=function(a,c,d){this.blockID=b.uniqueId(c.blockTypeID+"_block-"),this.uploadsCount=0,this.instance=a,this.blockType=c,this.data=d,this.type=this.blockType.blockType(),this.errors=[],this._setElement(),this._bindFunctions(),this.render()};b.extend(t.prototype,f,{bound:["onDeleteClick","onContentPasted","onBlockFocus","onDrop","onDragStart","onDragEnd"],$:function(a){return this.$el.find(a)},render:function(){this._super("beforeBlockRender"),this.$block=block=a("<div>",{"class":this.instance.options.baseCSSClass+"-block",id:this.blockID,"data-type":this.type,html:this.el}),this.instance.formatBar.hide(),this.instance.marker.hide(),this.instance.marker.$el.before(block),this.blockType.dropEnabled&&(this.$dropzone=a("<div>",{html:this.blockType.dropzoneHTML,"class":"dropzone "+this.blockType.className+"-block"}),this.$block.append(this.$dropzone),this.$el.hide()),!b.isUndefined(this.data)&&!b.isEmpty(this.data)&&this.loadData(),this.save(),block.append(a("<span>",{"class":"handle",draggable:!0})),block.append(a("<span>",{"class":"delete block-delete"})),block.bind("drop",h).bind("mouseover",h).bind("mouseout",h).bind("mouseover",function(b){a(this).siblings().removeClass("active"),a(this).addClass("active")}).bind("mouseout",function(b){a(this).removeClass("active")});var c;for(var e in this.instance.formatters)this.instance.formatters.hasOwnProperty(e)&&(c=d.Formatters[e],b.isUndefined(c.keyCode)||c._bindToBlock(block));block.find(".paste-block").bind("click",function(){a(this).select()}).bind("paste",this.onContentPasted).bind("submit",this.onContentPasted),block.find(".delete.block-delete").bind("click",this.onDeleteClick),block.find(".text-block").length>0&&(document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBrOnReturn",!1,!0),block.find(".text-block").focus(this.onBlockFocus),block.find(".text-block").bind("paste",this.onContentPasted)),this.blockType.dropEnabled&&(this.$dropzone.dropArea(),this.$dropzone.bind("drop",this.onDrop));if(b.isEmpty(this.data)){var f=block.find('[contenteditable="true"], input');f.length>0&&!this.blockType.dropEnabled&&f[0].focus()}block.find(".handle").dropArea().bind("dragstart",this.onDragStart).bind("drag",this.instance.marker.show).bind("dragend",this.onDragEnd).bind("dragleave",function(){}),block.addClass("sir-trevor-item-ready"),this._super("onBlockRender")},remove:function(){this.$el.parent().remove()},loadData:function(){this._super("loadData",this.data)},validate:function(){return this.errors=[],this.$(".error").removeClass("error"),this.$(".error-marker").remove(),this._super("validate")},showErrors:function(){b.each(this.errors,b.bind(function(a){},this))},save:function(){var a=this.$el.data("block");return b.isUndefined(a)?this.$el.data("block",this.to_json(this.data)):this._super("toData"),this.$el.data("block")},to_json:function(a){return{type:this.type.toLowerCase(),data:a}},loading:function(){this.spinner=new Spinner(this.instance.options.spinner),this.spinner.spin(this.$block[0]),this.$block.addClass("loading")},ready:function(){this.$block.removeClass("loading"),b.isUndefined(this.spinner)||(this.spinner.stop(),delete this.spinner)},onDragStart:function(b){var c=a(b.target);b.originalEvent.dataTransfer.setData("Text",c.parent().attr("id")),b.originalEvent.dataTransfer.setDragImage(c.parent()[0],13,25),c.parent().addClass("dragging"),this.instance.formatBar.hide()},onDragEnd:function(b){var c=a(b.target);c.parent().removeClass("dragging"),this.instance.marker.hide()},onBlockFocus:function(a){this.instance.formatBar.show(this.$block)},onDeleteClick:function(a){confirm("Are you sure you wish to delete this content?")&&(this.instance.removeBlock(this),h(a))},onContentPasted:function(a){var c=function(a){this._super("onContentPasted",a)};b.delay(b.bind(c,this,a),100)},onDrop:function(c){c.preventDefault(),c=c.originalEvent;var d=a(c.target),e=c.dataTransfer.types,f,g=[];this.$dropzone.removeClass("dragOver"),b.isUndefined(e)||(b.include(e,"Files")||b.include(e,"text/plain")||b.include(e,"text/uri-list"))&&this._super("onDrop",c.dataTransfer)},uploadAttachment:function(c,d){var e=[this.instance.ID,(new Date).getTime(),"raw"].join("-"),f=new FormData;f.append("attachment[name]",c.name),f.append("attachment[file]",c),f.append("attachment[uid]",e);var g=function(a){!b.isUndefined(d)&&b.isFunction(d)&&b.bind(d,this)(a)};a.ajax({url:this.instance.options.uploadUrl,data:f,cache:!1,contentType:!1,processData:!1,type:"POST",success:b.bind(g,this)})},parseUrlInput:function(a){var b=a.match(this.regexs.url)},_setElement:function(){var c=b.isFunction(this.blockType.editorHTML)?this.blockType.editorHTML():this.blockType.editorHTML,d=a("<div>",{"class":"block-editor "+this.blockType.className+"-block",html:c});this.$el=d,this.el=this.$el[0]},_super:function(a,c){if(!b.isUndefined(this.blockType[a]))return b.bind(this.blockType[a],this,c)()}});var u=d.Formatter=function(a){this.formatId=b.uniqueId("format-"),this._configure(a||{}),this.className=d.DEFAULTS.baseCSSClass+"-format-"+this.options.className,this.initialize.apply(this,arguments)},v=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];b.extend(u.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(a){return a},toHTML:function(a){return a},initialize:function(){},_configure:function(a){this.options&&(a=b.extend({},this.options,a));for(var c=0,d=v.length;c<d;c++){var e=v[c];a[e]&&(this[e]=a[e])}this.options=a},_bindToBlock:function(a){var b=this,c=!1;a.on("keyup",".text-block",function(a){if(a.which==17||a.which==224)c=!1}).on("keydown",".text-block",{formatter:b},function(a){if(a.which==17||a.which==224)c=!0;a.which==a.data.formatter.keyCode&&c===!0&&(document.execCommand(a.data.formatter.cmd,!1,!0),a.preventDefault())})}}),u.extend=k;var w=d.BlockType.extend({title:"Quote",className:"block-quote",limit:0,editorHTML:function(){return b.template('<blockquote class="required text-block <%= className %>" contenteditable="true"></blockquote><div class="input text"><label>Credit</label><input data-maxlength="140" name="cite" class="input-string required" type="text" /></div>',this)},loadData:function(a){this.$(".text-block").html(this.instance._toHTML(a.text,this.type)),this.$("input").val(a.cite)},toMarkdown:function(a){return a.replace(/^(.+)$/mg,"> $1")}});d.BlockTypes.Quote=new w;var x='<p>Drop images here</p><div class="input submit"><input type="file" multiple="multiple" /></div><button>...or choose file(s)</button>',y=d.BlockType.extend({title:"Gallery",className:"gallery",dropEnabled:!0,editorHTML:'<div class="gallery-items"><p>Gallery contents: </p><ul></ul></div>',dropzoneHTML:x,loadData:function(a){this.loading(),b.isArray(a)&&(b.each(a,b.bind(function(a){this._super("renderGalleryThumb",a)},this)),this.$el.show(),this.$dropzone.show(),this.ready())},renderGalleryThumb:function(c){if(b.isUndefined(c.data.file))return!1;var d=a("<img>",{src:c.data.file.thumb.url}),e=a("<li>",{id:b.uniqueId("gallery-item"),"class":"gallery-item",html:d});e.append(a("<span>",{"class":"delete",click:b.bind(function(c){h(c);if(confirm("Are you sure you wish to delete this image?")){a(c.target).parent().remove();var d=this.$el.data("block");d.data=[],b.each(this.$("li.gallery-item"),function(b){b=a(b),d.data.push(b.data("block"))})}},this)})),e.data("block",c),this.$el.find("ul").append(e),e.dropArea().bind("dragstart",b.bind(function(b){var c=a(b.target);b.originalEvent.dataTransfer.setData("Text",c.parent().attr("id")),c.parent().addClass("dragging")},this)).bind("drag",b.bind(function(a){},this)).bind("dragend",b.bind(function(b){var c=a(b.target);c.parent().removeClass("dragging")},this)).bind("dragover",b.bind(function(b){var c=a(b.target);c.parents("li").addClass("dragover")},this)).bind("dragleave",b.bind(function(b){var c=a(b.target);c.parents("li").removeClass("dragover")},this)).bind("drop",b.bind(function(c){var d=a(c.target),e=d.parent();d=d.hasClass("gallery-item")?d:e,this.$el.find("ul li.dragover").removeClass("dragover");var f=a("#"+c.originalEvent.dataTransfer.getData("text/plain"));if(f.attr("id")===d.attr("id"))return!1;f.length>0&&f.hasClass("gallery-item")&&d.before(f);var g=this.$el.data("block");g.data=[],b.each(this.$("li.gallery-item"),function(b){b=a(b),g.data.push(b.data("block"))})},this))},onBlockRender:function(){this.$dropzone.find("button").bind("click",h),this.$dropzone.find("input").on("change",b.bind(function(a){this._super("onDrop",a.currentTarget)},this))},onDrop:function(a){if(a.files.length>0){var c=a.files.length,d,e=typeof URL!="undefined"?URL:typeof webkitURL!="undefined"?webkitURL:null;this.loading();while(c--)d=a.files[c],/image/.test(d.type)&&(this.uploadsCount+=1,this.$el.show(),this.uploadAttachment(d,function(a){this.uploadsCount-=1;var c=this.$el.data("block");a={type:"image",data:a},b.isArray(c.data)||(c.data=[]),c.data.push(a),this._super("renderGalleryThumb",a),this.uploadsCount===0&&this.ready()}))}},onGalleryItemDrop:function(a){}});d.BlockTypes.Gallery=new y;var x='<p>Drop image here</p><div class="input submit"><input type="file" /></div><button>...or choose a file</button>',z=d.BlockType.extend({title:"Image",className:"image",dropEnabled:!0,dropzoneHTML:x,loadData:function(b){this.loading(),this.$dropzone.hide(),this.$el.html(a("<img>",{src:b.file.url})),this.$el.show(),this.ready()},onBlockRender:function(){this.$dropzone.find("button").bind("click",h),this.$dropzone.find("input").on("change",b.bind(function(a){this._super("onDrop",a.currentTarget)},this))},onDrop:function(b){var c=b.files[0],d=typeof URL!="undefined"?URL:typeof webkitURL!="undefined"?webkitURL:null;/image/.test(c.type)&&(this.loading(),this.$dropzone.hide(),this.$el.html(a("<img>",{src:d.createObjectURL(c)})),this.$el.show(),this.uploadAttachment(c,function(a){var b=this.$el.data("block");b.data=a,this.ready()}))}});d.BlockTypes.Image=new z;var A='<div class="required text-block" contenteditable="true"></div>',B=d.BlockType.extend({title:"Text",className:"text",editorHTML:function(){return b.template(A,this)},loadData:function(a){this.$(".text-block").html(this.instance._toHTML(a.text,this.type))}});d.BlockTypes.Text=new B;var C='<p>Drop tweet link here</p><div class="input text"><label>or paste URL:</label><input type="text" class="paste-block"></div>',D='<div class="tweet media"><div class="img"><img src="<%= user.profile_image_url %>" class="tweet-avatar"></div><div class="bd tweet-body"><p><a href="http://twitter.com/#!/<%= user.screen_name %>">@<%= user.screen_name %></a>: <%= text %></p><time><%= created_at %></time></div></div>',E=d.BlockType.extend({title:"Tweet",className:"tweet",dropEnabled:!0,dropzoneHTML:C,loadData:function(a){this.$block.find(".dropzone").hide(),this.$el.show(),this.$el.html(b.template(D,a))},onContentPasted:function(b){var c=a(b.target),d=c.val();this._super("handleTwitterDropPaste",d)},handleTwitterDropPaste:function(c){if(b.isURI(c)&&c.indexOf("twitter")!=-1&&c.indexOf("status")!=-1){var d=c.match(/[^\/]+$/);if(!b.isEmpty(d)){this.loading(),d=d[0];var e=function(a){var d={user:{profile_image_url:a.user.profile_image_url,profile_image_url_https:a.user.profile_image_url_https,screen_name:a.user.screen_name,name:a.user.name},text:a.text,created_at:a.created_at,status_url:c},e=this.$el.data("block");e.data=d,this.$el.html(b.template(D,d)),this.$dropzone.hide(),this.$el.show(),this.ready()},f=function(){this.ready()};a.ajax({url:"http://api.twitter.com/1/statuses/show/"+d+".json",dataType:"JSONP",success:b.bind(e,this),error:b.bind(f,this)})}}},onDrop:function(a){var b=a.getData("text/plain");this._super("handleTwitterDropPaste",b)}});d.BlockTypes.Tweet=new E;var F='<div class="text-block <%= className %>" contenteditable="true"></div>';UnorderedList=d.BlockType.extend({title:"List",className:"list",editorHTML:function(){return b.template(F,this)},onBlockRender:function(){this.$(".text-block").bind("click",function(){a(this).html().length===0&&document.execCommand("insertUnorderedList",!1,!1)}),b.isEmpty(this.data)&&this.$(".text-block").focus().click()},loadData:function(a){this.$(".text-block").html("<ul>"+this.instance._toHTML(a.text,this.type)+"</ul>")},toMarkdown:function(a){return a.replace(/<\/li>/mg,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/mg," - $1")},toHTML:function(a){return a.replace(/^ - (.+)$/mg,"<li>$1</li>")}}),d.BlockTypes.Ul=new UnorderedList;var G='<p>Drop video link here</p><div class="input text"><label>or paste URL:</label><input type="text" class="paste-block"></div>',H=/http[s]?:\/\/(?:www.)?(?:(vimeo).com\/(.*))|(?:(youtu(?:be)?).(?:be|com)\/(?:watch\?v=)?([^&]*)(?:&(?:.))?)/,I=d.BlockType.extend({title:"Video",className:"video",dropEnabled:!0,dropzoneHTML:G,loadData:function(a){this.$block.find(".dropzone").hide(),this.$el.show(),a.source=="youtube"||a.source=="youtu"?this.$el.html('<iframe src="'+window.location.protocol+"//www.youtube.com/embed/"+a.remote_id+'" width="580" height="320" frameborder="0" allowfullscreen></iframe>'):a.source=="vimeo"&&this.$el.html('<iframe src="'+window.location.protocol+"//player.vimeo.com/video/"+a.remote_id+'?title=0&byline=0" width="580" height="320" frameborder="0"></iframe>')},onContentPasted:function(b){var c=a(b.target),d=c.val();this._super("handleDropPaste",d)},handleDropPaste:function(a){if(b.isURI(a))if(a.indexOf("youtu")!=-1||a.indexOf("vimeo")!=-1){var c={},d=a.match(H);d[3]!==undefined?(c.source=d[3],c.remote_id=d[4]):d[1]!==undefined&&(c.source=d[1],c.remote_id=d[2]),c.source=="youtu"&&(c.source="youtube");var e=this.$el.data("block");e.data=c,this._super("loadData",c)}},onDrop:function(a){var b=a.getData("text/plain");this._super("handleDropPaste",b)}});d.BlockTypes.Video=new I;var J=d.Formatter.extend({title:"B",className:"bold",cmd:"bold",keyCode:66}),K=d.Formatter.extend({title:"I",className:"italic",cmd:"italic",keyCode:73}),L=d.Formatter.extend({title:"U",className:"underline",cmd:"underline"}),M=d.Formatter.extend({title:"Link",className:"link",cmd:"CreateLink",onClick:function(){var a=prompt("Enter a link"),b=/(ftp|http|https):\/\/./;a&&a.length>0&&(b.test(a)||(a="http://"+a),document.execCommand(this.cmd,!1,a))}}),N=d.Formatter.extend({title:"Unlink",className:"link",cmd:"unlink"}),O=d.Formatter.extend({title:"H1",className:"heading h1",cmd:"formatBlock",param:"H1",toMarkdown:function(a){return a.replace(/<h1>([^*|_]+)<\/h1>/mg,"#$1#\n")},toHTML:function(a){return a.replace(/(?:#)([^*|_]+)(?:#)/mg,"<h1>$1</h1>")}}),P=d.Formatter.extend({title:"H2",className:"heading h2",cmd:"formatBlock",param:"H2",toMarkdown:function(a){return a.replace(/<h2>([^*|_]+)<\/h2>/mg,"##$1##\n")},toHTML:function(a){return a.replace(/(?:##)([^*|_]+)(?:##)/mg,"<h2>$1</h2>")}});d.Formatters.Bold=new J,d.Formatters.Italic=new K,d.Formatters.Link=new M,d.Formatters.Unlink=new N;var Q=d.Marker=function(a,c){this.instance=c,this.options=b.extend({},d.DEFAULTS.marker,a||{}),this._bindFunctions()};b.extend(Q.prototype,f,{bound:["onButtonClick","show","hide","onDrop"],render:function(){var b=a("<span>",{"class":this.instance.options.baseCSSClass+"-"+this.options.baseCSSClass,html:"<p>"+this.options.addText+'</p><div class="buttons"></div>'});this.instance.$wrapper.append(b),this.$el=b,this.$btns=this.$el.find(".buttons"),this.$p=this.$el.find("p");var c,e;for(c in this.instance.blockTypes)d.BlockTypes.hasOwnProperty(c)&&(e=d.BlockTypes[c],e.toolbarEnabled&&this.$btns.append(a("<a>",{href:"#","class":this.options.buttonClass+" new-"+e.className,"data-type":c,text:e.title,click:this.onButtonClick})));this.$btns.children().length===0&&this.$el.addClass("hidden"),this.$el.dropArea(),this.$el.bind("drop",this.onDrop),this.instance.$wrapper.bind("mouseover",this.show),this.instance.$wrapper.bind("mouseout",this.hide),this.$el.addClass("sir-trevor-item-ready")},show:function(c){c.type=="drag"?(this.$p.text(this.options.dropText),this.$btns.hide()):(this.$p.text(this.options.addText),this.$btns.show());var d=c?c.originalEvent.pageY-this.instance.$wrapper.offset().top:0;if(this.instance.blocks.length>0){var e=!1,f=this.instance.$wrapper,g="."+this.instance.options.baseCSSClass+"-block",h=function(b,c){b=a(b);var f=b.position().top-35,g=b.position().top+b.outerHeight(!0)-35;f<=d&&d<g&&(e=b)};b.each(f.find(g),b.bind(h,this)),e?e.before(this.$el):d>0?f.find(g).last().after(this.$el):f.find(g).first().before(this.$el)}this.$el.addClass("sir-trevor-item-ready")},hide:function(a){this.$el.removeClass("sir-trevor-item-ready")},onDrop:function(c){h(c);var d=a(c.target),e=c.originalEvent.dataTransfer.getData("text/plain"),f=a("#"+e);!b.isUndefined(e)&&!b.isEmpty(f)&&d.after(f)},remove:function(){this.$el.remove()},onButtonClick:function(b){h(b);var c=a(b.target);if(c.hasClass("inactive"))return alert("You cannot create any more blocks of this type"),!1;this.instance.createBlock(c.attr("data-type"),{})}});var R=d.FormatBar=function(a,c){this.instance=c,this.options=b.extend({},d.DEFAULTS.formatBar,a||{}),this.className=this.instance.options.baseCSSClass+"-"+this.options.baseCSSClass,this._bindFunctions()};b.extend(R.prototype,f,{bound:["onFormatButtonClick"],render:function(){var b=a("<div>",{"class":this.className});this.instance.$wrapper.prepend(b),this.$el=b;var c=this.instance.formatters,e,f;for(e in c)d.Formatters.hasOwnProperty(e)&&(f=d.Formatters[e],a("<button>",{"class":"format-button "+f.className,text:f.title,"data-type":e,"data-cmd":f.cmd,click:this.onFormatButtonClick}).appendTo(this.$el));this.$el.find("button").length===0&&this.$el.addClass("hidden"),this.$el.hide(),this.$el.bind("mouseout",h),this.$el.bind("mouseover",h),this.instance.$wrapper.bind("click",this.onWrapperClick)},show:function(a){this.$el.css({top:a.position().top}),this.$el.show(),this.$el.addClass("sir-trevor-item-ready")},onWrapperClick:function(b){var c=a(b.target),d=c.parent();c.hasClass(this.className)||d.hasClass(this.className)||c.hasClass("text-block")||d.hasClass("text-block")||this.hide()},hide:function(){this.$el.hide(),this.$el.removeClass("sir-trevor-item-ready")},remove:function(){this.$el.remove()},onFormatButtonClick:function(c){h(c);var e=a(c.target),f=d.Formatters[e.attr("data-type")];!b.isUndefined(f.onClick)&&b.isFunction(f.onClick)?f.onClick():document.execCommand(e.attr("data-cmd"),!1,f.param),this.$el.addClass("sir-trevor-item-ready")}});var S=d.Editor=function(a){this.blockTypes={},this.formatters={},this.blockCounts={},this.blocks=[],this.options=b.extend({},d.DEFAULTS,a||{}),this.ID=b.uniqueId(this.options.baseCSSClass+"-"),this._ensureAndSetElements()&&(this.marker=new d.Marker(this.options.marker,this),this.formatBar=new d.FormatBar(this.options.formatBar,this),this._setBlocksAndFormatters(),this._bindFunctions(),this.from_json(),this.build(),d.instances.push(this),d.bindFormSubmit(this.$form))};b.extend(S.prototype,f,{bound:["onFormSubmit"],initialize:function(){},build:function(){this.$el.hide(),this.marker.render(),this.formatBar.render(),this.options.blockStore.data.length===0?this.createBlock(this.options.defaultType):b.each(this.options.blockStore.data,b.bind(function(a){this.createBlock(a.type,a.data)},this)),this.$wrapper.addClass("sir-trevor-ready")},createBlock:function(a,c){a=b.capitalize(a);if(this._blockTypeAvailable(a)){var e=d.BlockTypes[a],f=b.isUndefined(this.blockCounts[a])?0:this.blockCounts[a],g=this.blocks.length,h=this._getBlockTypeLimit(a);if(f>h||this.options.blockLimit!==0&&g>=this.options.blockLimit)return!1;var i=new d.Block(this,e,c||{});b.isUndefined(this.blockCounts[a])&&(this.blockCounts[a]=0),this.blocks.push(i),f++,this.blockCounts[a]=f,this.options.blockLimit!==0&&this.blocks.length>=this.options.blockLimit&&this.marker.$el.addClass("hidden"),f>=h&&this.marker.$el.find('[data-type="'+a+'"]').addClass("inactive").attr("title","You have reached the limit for this type of block"),f>1&&this.$wrapper.addClass("reorderable")}},removeBlock:function(a){a.remove(),this.blockCounts[a.type]=this.blockCounts[a.type]-1,this.blocks=b.reject(this.blocks,function(b){return b.blockID==a.blockID}),b.isUndefined(this.blocks)&&(this.blocks=[]),this.formatBar.hide(),this.blocks.length<=1&&this.$wrapper.removeClass("reorderable")},onFormSubmit:function(){var c,e,f,g=0;this.options.blockStore.data=[];var h=function(c,e){c=a(c);var f=b.find(this.blocks,function(a){return a.blockID==c.attr("id")});if(!b.isUndefined(f)||!b.isEmpty(f)||typeof f==d.Block)if(f.validate()){var h=f.save();b.isEmpty(h.data)||this.options.blockStore.data.push(h)}else g++};return b.each(this.$wrapper.find("."+this.options.baseCSSClass+"-block"),b.bind(h,this)),this.$el.val(this.options.blockStore.data.length===0?"":this.to_json()),g},to_json:function(){return JSON.stringify(this.options.blockStore)},from_json:function(){var a=this.$el.val();this.options.blockStore={data:[]};if(a.length>0)try{var c=JSON.parse(a);!b.isUndefined(c.data)&&b.isArray(c.data)&&!b.isEmpty(c.data)&&(this.options.blockStore=c)}catch(d){console.log("Sorry there has been a problem with parsing the JSON"),console.log(d)}},_getBlockTypeLimit:function(a){return this._blockTypeAvailable(a)?b.isUndefined(this.options.blockTypeLimits[a])?this.blockTypes[a].limit:this.options.blockTypeLimits[a]:0},_blockTypeAvailable:function(a){return!b.isUndefined(this.blockTypes[a])},_formatterAvailable:function(a){return!b.isUndefined(this.formatters[a])},_ensureAndSetElements:function(){return b.isUndefined(this.options.el)||b.isEmpty(this.options.el)?!1:(this.$el=this.options.el,this.el=this.options.el[0],this.$form=this.$el.parents("form"),this.$el.wrap(a("<div>",{id:this.ID,"class":this.options.baseCSSClass+" "+this.options.baseCSSClass+"_dragleave",dropzone:"copy link move"})),this.$wrapper=this.$form.find("#"+this.ID),!0)},_setBlocksAndFormatters:function(){this.blockTypes=g(b.isUndefined(this.options.blockTypes)?d.BlockTypes:this.options.blockTypes),this.formatters=g(b.isUndefined(this.options.formatters)?d.Formatters:this.options.formatters)},_toMarkdown:function(a,c){var e;e=a.replace(/\n/mg,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/g,"[$2]($1)").replace(/<\/?b>/g,"**").replace(/<\/?STRONG>/g,"**").replace(/<\/?i>/g,"_").replace(/<\/?EM>/g,"_");var f,g;for(f in this.formatters)d.Formatters.hasOwnProperty(f)&&(g=d.Formatters[f],!b.isUndefined(g.toMarkdown)&&b.isFunction(g.toMarkdown)&&(e=g.toMarkdown(e)));var h;return d.BlockTypes.hasOwnProperty(c)&&(h=d.BlockTypes[c],!b.isUndefined(h.toMarkdown)&&b.isFunction(h.toMarkdown)&&(e=h.toMarkdown(e))),e=e.replace(/([^<>]+)(<div>)/g,"$1\n\n$2").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n\n").replace(/<\/p>/g,"\n\n\n\n").replace(/<(.)?br(.)?>/g,"\n\n").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/<\/?[^>]+(>|$)/g,""),e},_toHTML:function(a,c){var e=a,f,g;for(f in this.formatters)d.Formatters.hasOwnProperty(f)&&(g=d.Formatters[f],!b.isUndefined(g.toHTML)&&b.isFunction(g.toHTML)&&(e=g.toHTML(e)));var h;return d.BlockTypes.hasOwnProperty(c)&&(h=d.BlockTypes[c],!b.isUndefined(h.toHTML)&&b.isFunction(h.toHTML)&&(e=h.toHTML(e))),e=e.replace(/^\> (.+)$/mg,"$1").replace(/\n\n/g,"<br>").replace(/\[(.+)\]\((.+)\)/g,"<a href='$2'>$1</a>").replace(/(?:_)([^*|_]+)(?:_)/mg,"<i>$1</i>").replace(/(?:\*\*)([^*|_]+)(?:\*\*)/mg,"<b>$1</b>"),e}}),d.bindFormSubmit=function(a){e||(a.bind("submit",this.onFormSubmit),e=!0)},d.onFormSubmit=function(a){var c=0;b.each(d.instances,function(a,b){c+=a.onFormSubmit()}),c>0&&a.preventDefault()}})(jQuery,_);