// Sir Trevor, v0.0.1

(function(a,b){function f(a){var c={};return b.each(a,function(d,e){c[b.isArray(a)?d:e]=!0}),c}function g(a){a.preventDefault(),a.stopPropagation()}function h(a){return a.which==17||a.which==224}function i(a,b,c){var d=a.offset().left-b,e=a.offset().top-b,f=d+a.width()+2*b,g=e+a.height()+2*b,h=c.pageX,i=c.pageY;return h>d&&h<f&&i>e&&i<g}function j(a){return a.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}var c=this,d;d=c.SirTrevor={},d.DEFAULTS={baseCSSClass:"sir-trevor",blockStore:{data:[]},defaultType:"TextBlock",spinner:{lines:9,length:3,width:2,radius:3,color:"#000",speed:1.4,trail:57,shadow:!1},marker:{baseCSSClass:"marker",buttonClass:"button",addText:"Click to add:",dropText:"Drop to place content"},formatBar:{baseCSSClass:"formatting-control"}},d.BlockTypes={},d.Formatters={};var e={bound:[],_bindFunctions:function(){var a=[];a.push(this),a.join(this.bound),b.bindAll.apply(this,a)}};Array.prototype.remove=function(a,b){var c=this.slice((b||a)+1||this.length);return this.length=a<0?this.length+a:a,this.push.apply(this,c)};var k=a({});a.subscribe=function(){k.on.apply(k,arguments)},a.unsubscribe=function(){k.off.apply(k,arguments)},a.publish=function(){k.trigger.apply(k,arguments)},function(a,b,c){function d(a){var b={x:a.offsetLeft,y:a.offsetTop};while(a=a.offsetParent)b.x+=a.offsetLeft,b.y+=a.offsetTop;return b}function e(a){for(var b=1;b<arguments.length;b++){var d=arguments[b];for(var e in d)a[e]===c&&(a[e]=d[e])}return a}function f(a,b){for(var c in b)a.style[g(a,c)||c]=b[c];return a}function g(a,b){var d=a.style,e,f;if(d[b]!==c)return b;b=b.charAt(0).toUpperCase()+b.slice(1);for(f=0;f<k.length;f++){e=k[f]+b;if(d[e]!==c)return e}}function h(a,b,c,d){var e=["opacity",b,~~(a*100),c,d].join("-"),f=.01+c/d*100,g=Math.max(1-(1-a)/b*(100-f),a),h=m.substring(0,m.indexOf("Animation")).toLowerCase(),i=h&&"-"+h+"-"||"";return l[e]||(n.insertRule("@"+i+"keyframes "+e+"{"+"0%{opacity:"+g+"}"+f+"%{opacity:"+a+"}"+(f+.01)+"%{opacity:1}"+(f+b)%100+"%{opacity:"+a+"}"+"100%{opacity:"+g+"}"+"}",0),l[e]=1),e}function i(a,b,c){return c&&!c.parentNode&&i(a,c),a.insertBefore(b,c||null),a}function j(a,c){var d=b.createElement(a||"div"),e;for(e in c)d[e]=c[e];return d}var k=["webkit","Moz","ms","O"],l={},m,n=function(){var a=j("style");return i(b.getElementsByTagName("head")[0],a),a.sheet||a.styleSheet}(),o=function r(a){if(!this.spin)return new r(a);this.opts=e(a||{},r.defaults,p)},p=o.defaults={lines:12,length:7,width:5,radius:10,color:"#000",speed:1,trail:100,opacity:.25,fps:20},q=o.prototype={spin:function(a){this.stop();var b=this,c=b.el=f(j(),{position:"relative"}),e,g;a&&(g=d(i(a,c,a.firstChild)),e=d(c),f(c,{left:(a.offsetWidth>>1)-e.x+g.x+"px",top:(a.offsetHeight>>1)-e.y+g.y+"px"})),c.setAttribute("aria-role","progressbar"),b.lines(c,b.opts);if(!m){var h=b.opts,k=0,l=h.fps,n=l/h.speed,o=(1-h.opacity)/(n*h.trail/100),p=n/h.lines;(function q(){k++;for(var a=h.lines;a;a--){var d=Math.max(1-(k+a*p)%n*o,h.opacity);b.opacity(c,h.lines-a,d,h)}b.timeout=b.el&&setTimeout(q,~~(1e3/l))})()}return b},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=c),this}};q.lines=function(a,b){function c(a,c){return f(j(),{position:"absolute",width:b.length+b.width+"px",height:b.width+"px",background:a,boxShadow:c,transformOrigin:"left",transform:"rotate("+~~(360/b.lines*d)+"deg) translate("+b.radius+"px"+",0)",borderRadius:(b.width>>1)+"px"})}var d=0,e;for(;d<b.lines;d++)e=f(j(),{position:"absolute",top:1+~(b.width/2)+"px",transform:"translate3d(0,0,0)",opacity:b.opacity,animation:m&&h(b.opacity,b.trail,d,b.lines)+" "+1/b.speed+"s linear infinite"}),b.shadow&&i(e,f(c("#000","0 0 4px #000"),{top:"2px"})),i(a,i(e,c(b.color,"0 0 1px rgba(0,0,0,.1)")));return a},q.opacity=function(a,b,c){b<a.childNodes.length&&(a.childNodes[b].style.opacity=c)},function(){var a=f(j("group"),{behavior:"url(#default#VML)"}),b;if(!g(a,"transform")&&a.adj){for(b=4;b--;)n.addRule(["group","roundrect","fill","stroke"][b],"behavior:url(#default#VML)");q.lines=function(a,b){function c(a,c,g){i(h,i(f(d(),{rotation:360/b.lines*a+"deg",left:~~c}),i(f(j("roundrect",{arcsize:1}),{width:e,height:b.width,left:b.radius,top:-b.width>>1,filter:g}),j("fill",{color:b.color,opacity:b.opacity}),j("stroke",{opacity:0}))))}function d(){return f(j("group",{coordsize:g+" "+g,coordorigin:-e+" "+ -e}),{width:g,height:g})}var e=b.length+b.width,g=2*e,h=d(),k=~(b.length+b.radius+b.width)+"px",l;if(b.shadow)for(l=1;l<=b.lines;l++)c(l,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(l=1;l<=b.lines;l++)c(l);return i(f(a,{margin:k+" 0 0 "+k,zoom:1}),h)},q.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&b+d<e.childNodes.length&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}}else m=g(a,"animation")}(),a.Spinner=o}(window,document);var l=d.BlockType=function(a){this.instances={},this.instanceCount=0,this._configure(a||{}),this.blockTypeID=b.uniqueId(this.className+"-"),this.initialize.apply(this,arguments)},m=["className","toolbarEnabled","dropEnabled","title","limit","editorHTML","dropzoneHTML","validate","loadData","toData","onDrop","onContentPasted","onBlockRender","beforeBlockRender","onBlockActivated","toMarkdown","toHTML"];b.extend(l.prototype,{initialize:function(){},loadData:function(a,b){},validate:function(a){},toData:function(a){var b=a.$el,c=b.data("block"),d;a.$(".text-block").length>0&&(d=a.$(".text-block").html(),d.length>0&&(c.data.text=a.instance._toMarkdown(d,a.type)))},onBlockRender:function(a){},beforeBlockRender:function(a){},onBlockActivated:function(a){},onDrop:function(a){},onContentPasted:function(a,b){},_configure:function(a){this.options&&(a=b.extend({},this.options,a));for(var c=0,d=m.length;c<d;c++){var e=m[c];a[e]&&(this[e]=a[e])}this.options=a},blockType:function(){var a="";for(var b in d.BlockTypes)d.BlockTypes[b]==this&&(a=b);return a}});var n=d.Block=function(a,c,d){this.blockID=b.uniqueId(c.blockTypeID+"_block-"),this.instance=a,this.blockType=c,this.data=d,this.type=this.blockType.blockType(),this.errors=[],this._setElement(),this._bindFunctions(),this.render()};b.extend(n.prototype,e,{bound:["onDeleteClick","onContentPasted","onMouseOverAbove","onMouseOverBelow"],regexs:{url:/^((http[s]?|ftp):\/)?\/?([^:\/\s]+)((\/\w+)*\/)([\w\-\.]+[^#?\s]+)(.*)?(#[\w\-]+)?$/m,video:/http[s]?:\/\/(?:www.)?(?:(vimeo).com\/(.*))|(?:(youtu(?:be)?).(?:be|com)\/(?:watch\?v=)?([^&]*)(?:&(?:.))?)/},$:function(a){return this.$el.find(a)},render:function(){this._super("beforeBlockRender"),this.$block=block=a("<div>",{"class":this.instance.options.baseCSSClass+"-block",id:this.blockID,"data-type":this.type,html:this.el}),this.instance.marker.hide(),this.instance.marker.$el.before(block),!b.isUndefined(this.data)&&!b.isEmpty(this.data)&&this.loadData(),this.save(),block.addClass("block-ready"),block.append(a("<span>",{"class":"handle",draggable:!0})),block.append(a("<span>",{"class":"delete"})),block.bind("click",g).bind("drop",g).bind("mouseover",g).bind("mouseout",g).bind("dragleave",g).bind("mouseover",function(b){a(this).siblings().removeClass("active"),a(this).addClass("active")}).bind("mouseout",function(b){a(this).removeClass("active")});var c;for(var e in this.instance.formatters)if(this.instance.formatters.hasOwnProperty(e)){c=d.Formatters[e];if(!b.isUndefined(c.keyCode)){var f=!1;block.on("keyup",".text-block",function(a){if(a.which==17||a.which==224)f=!1}).on("keydown",".text-block",{formatter:c},function(a){if(a.which==17||a.which==224)f=!0;a.which==a.data.formatter.keyCode&&f===!0&&(document.execCommand(a.data.formatter.cmd,!1,!0),a.preventDefault())})}}block.find(".paste-block").bind("click",function(){a(this).select()}).bind("paste",this.onContentPasted),!this.blockType.dropEnabled,block.find(".delete").bind("click",this.onDeleteClick),block.find(".text-block").length>0&&(document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBrOnReturn",!1,!0));if(b.isEmpty(this.data)){var h=block.find('[contenteditable="true"], input');h.length>0&&!block.dropEnabled&&h[0].focus()}this._super("onBlockRender")},remove:function(){this.$el.parent().remove()},loadData:function(){this._super("loadData",this.data)},validate:function(){this.errors=[];var a=this._super("validate");return a},save:function(){var a=this.$el.data("block");return b.isUndefined(a)?this.$el.data("block",this.to_json(this.data)):this._super("toData"),this.$el.data("block")},to_json:function(a){return{type:this.type,data:a}},onMouseOverAbove:function(b){var c=a(b.target).parents("."+this.instance.options.baseCSSClass+"-block");this.instance.marker.$el.after(c),this.instance.marker.$el.show()},onMouseOverBelow:function(b){var c=a(b.target).parents("."+this.instance.options.baseCSSClass+"-block");this.instance.marker.$el.before(c),this.instance.marker.$el.show()},onDeleteClick:function(a){confirm("Are you sure you wish to delete this content?")&&(this.instance.removeBlock(this),g(a))},onContentPasted:function(a){var c=function(a){this._super("onContentPasted",a)};b.delay(b.bind(c,this,a),100)},onContentDrop:function(){},parseUrlInput:function(a){var b=a.match(this.regexs.url)},_setElement:function(){var c=b.isFunction(this.blockType.editorHTML)?this.blockType.editorHTML():this.blockType.editorHTML,d=a("<div>",{"class":"block_editor",html:"<div class='block-above'></div>"+c+"<div class='block-below'></div>"});this.$el=d,this.el=this.$el[0]},_super:function(a,b){return this.blockType[a](this,b)}});var o=d.Formatter=function(a){this.formatId=b.uniqueId("format-"),this._configure(a||{}),this.className=d.DEFAULTS.baseCSSClass+"-format-"+this.options.className,this.initialize.apply(this,arguments)},p=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];b.extend(o.prototype,{initialize:function(){},_configure:function(a){this.options&&(a=b.extend({},this.options,a));for(var c=0,d=p.length;c<d;c++){var e=p[c];a[e]&&(this[e]=a[e])}this.options=a}}),d.BlockTypes.BlockQuote=new d.BlockType({title:"Quote",className:"block-quote",toolbarEnabled:!0,dropEnabled:!1,limit:0,editorHTML:function(){return b.template('<blockquote class="text-block <%= className %>" contenteditable="true"></blockquote><div class="input text"><label>Credit</label><input data-maxlength="140" name="cite" class="input-string" type="text" /></div>',this)},loadData:function(a,b){a.$(".text-block").html(a.instance._toHTML(b.text,a.type)),a.$("input").val(b.cite)},toData:function(a){var b=a.$el,c=b.data("block"),d;d=a.$(".text-block").html(),c.data.text=a.instance._toMarkdown(d,a.type),c.data.cite=a.$("input").val()},toMarkdown:function(a){return a.replace(/^(.+)$/mg,"> $1")}});var q='<div class="text-block <%= className %>" contenteditable="true"></div>';d.BlockTypes.OrderedList=new d.BlockType({title:"Ordered List",className:"ordered-list",toolbarEnabled:!0,dropEnabled:!1,limit:0,editorHTML:function(){return b.template(q,this)},onBlockRender:function(c){c.$(".text-block").bind("click",function(){a(this).html().length===0&&document.execCommand("insertOrderedList",!1,!1)}),b.isEmpty(c.data)&&c.$(".text-block").focus().click()},loadData:function(a,b){a.$(".text-block").html("<ol>"+a.instance._toHTML(b.text,a.type)+"</ol>")},toMarkdown:function(a){return a.replace(/<\/li>/mg,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/mg," 1. $1")},toHTML:function(a){return a.replace(/^ 1. (.+)$/mg,"<li>$1</li>")}});var q='<div class="<%= className %>" contenteditable="true"></div>';d.BlockTypes.TextBlock=new d.BlockType({title:"Text",className:"text-block",toolbarEnabled:!0,dropEnabled:!1,limit:0,editorHTML:function(){return b.template(q,this)},validate:function(a){return console.log(a.$el.html().length),a.$el.html().length===0?(a.errors.push("You must enter some content"),!1):!0},loadData:function(a,b){a.$(".text-block").html(a.instance._toHTML(b.text,a.type))},onBlockRender:function(a){},onContentPasted:function(a,b){console.log("Content pasted")},onDrop:function(a){console.log("Drop")}});var q='<div class="text-block <%= className %>" contenteditable="true"></div>';d.BlockTypes.UnorderedList=new d.BlockType({title:"Unordered List",className:"unordered-list",toolbarEnabled:!0,dropEnabled:!1,limit:0,editorHTML:function(){return b.template(q,this)},onBlockRender:function(c){c.$(".text-block").bind("click",function(){a(this).html().length===0&&document.execCommand("insertUnorderedList",!1,!1)}),b.isEmpty(c.data)&&c.$(".text-block").focus().click()},loadData:function(a,b){a.$(".text-block").html("<ul>"+a.instance._toHTML(b.text,a.type)+"</ul>")},toMarkdown:function(a){return a.replace(/<\/li>/mg,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/mg," - $1")},toHTML:function(a){return a.replace(/^ - (.+)$/mg,"<li>$1</li>")}}),d.Formatters.Bold=new d.Formatter({title:"B",className:"bold",cmd:"bold",keyCode:66}),d.Formatters.Italic=new d.Formatter({title:"I",className:"italic",cmd:"italic",keyCode:73}),d.Formatters.Underline=new d.Formatter({title:"U",className:"underline",cmd:"underline"}),d.Formatters.Link=new d.Formatter({title:"Link",className:"link",cmd:"CreateLink",onClick:function(){var a=prompt("Enter a link"),b=/(ftp|http|https):\/\/./;a.length>0&&(b.test(a)||(a="http://"+a),document.execCommand(this.cmd,!1,a))}}),d.Formatters.Unlink=new d.Formatter({title:"Unlink",className:"link",cmd:"unlink"}),d.Formatters.Heading1=new d.Formatter({title:"H1",className:"heading h1",cmd:"formatBlock",param:"H1",toMarkdown:function(a){return a.replace(/<h1>([^*|_]+)<\/h1>/mg,"#$1#\n")},toHTML:function(a){return a.replace(/(?:#)([^*|_]+)(?:#)/mg,"<h1>$1</h1>")}}),d.Formatters.Heading2=new d.Formatter({title:"H2",className:"heading h2",cmd:"formatBlock",param:"H2",toMarkdown:function(a){return a.replace(/<h2>([^*|_]+)<\/h2>/mg,"##$1##\n")},toHTML:function(a){return a.replace(/(?:##)([^*|_]+)(?:##)/mg,"<h2>$1</h2>")}});var r=d.Marker=function(a,c){this.instance=c,this.options=b.extend({},d.DEFAULTS.marker,a||{}),this._bindFunctions()};b.extend(r.prototype,e,{bound:["onButtonClick","show","hide"],render:function(){var b=a("<span>",{"class":this.instance.options.baseCSSClass+"-"+this.options.baseCSSClass,html:"<p>"+this.options.addText+'</p><div class="buttons"></div>'});this.instance.$wrapper.append(b),this.$el=b,this.$btns=this.$el.find(".buttons"),this.$p=this.$el.find("p");var c,e;for(c in this.instance.blockTypes)d.BlockTypes.hasOwnProperty(c)&&(e=d.BlockTypes[c],e.toolbarEnabled&&this.$btns.append(a("<a>",{href:"#","class":this.options.buttonClass+" new-"+e.className,"data-type":c,text:e.title,click:this.onButtonClick})))},remove:function(){},show:function(){this.$el.show()},hide:function(){this.$el.hide()},onButtonClick:function(b){g(b);var c=a(b.target);this.instance.createBlock(c.attr("data-type"),{})}});var s=d.FormatBar=function(a,c){this.instance=c,this.options=b.extend({},d.DEFAULTS.formatBar,a||{}),this.className=this.instance.options.baseCSSClass+"-"+this.options.baseCSSClass,this._bindFunctions()};b.extend(s.prototype,e,{bound:["onFormatButtonClick"],render:function(){var b=a("<div>",{"class":this.className});this.instance.$wrapper.before(b),this.$el=b;var c=this.instance.formatters,e,f;for(e in c)d.Formatters.hasOwnProperty(e)&&(f=d.Formatters[e],a("<button>",{"class":"format-button "+f.className,text:f.title,"data-type":e,"data-cmd":f.cmd,click:this.onFormatButtonClick}).appendTo(this.$el))},show:function(){},hide:function(){},onFormatButtonClick:function(c){g(c);var e=a(c.target),f=d.Formatters[e.attr("data-type")];!b.isUndefined(f.onClick)&&b.isFunction(f.onClick)?f.onClick():document.execCommand(e.attr("data-cmd"),!1,f.param)}});var t=d.Editor=function(a){this.blockTypes={},this.formatters={},this.blockCounts={},this.blocks=[],this.options=b.extend({},d.DEFAULTS,a||{}),this.ID=b.uniqueId(this.options.baseCSSClass+"-"),this._ensureAndSetElements()&&(this.marker=new d.Marker(this.options.marker,this),this.formatBar=new d.FormatBar(this.options.formatBar,this),this._setBlocksAndFormatters(),this._bindFunctions(),this.from_json(),this.build())};b.extend(t.prototype,e,{bound:["onFormSubmit"],initialize:function(){},build:function(){this.marker.render(),this.formatBar.render(),this.options.blockStore.data.length===0?this.createBlock(this.options.defaultType):b.each(this.options.blockStore.data,b.bind(function(a){this.createBlock(a.type,a.data)},this)),this.attach()},attach:function(){this.$form.on("submit",this.onFormSubmit)},createBlock:function(a,c){if(this._blockTypeAvailable(a)){var e=d.BlockTypes[a],f=b.isUndefined(this.blockCounts[a])?0:this.blockCounts[a];if(f>e.limit)return!1;f+1==e.limit&&this.marker.find('[data-type="'+a+'"]').addClass("inactive").attr("title","You have reached the limit for this type of block");var g=new d.Block(this,e,c||{});b.isUndefined(this.blockCounts[a])&&(this.blockCounts[a]=0),this.blocks.push(g),this.blockCounts[a]=f+1}},removeBlock:function(a){a.remove(),this.blockCounts[a.type]=this.blockCounts[a.type]-1,this.blocks=b.reject(this.blocks,function(b){return b.blockID==a.blockID}),b.isUndefined(this.blocks)&&(this.blocks=[])},onFormSubmit:function(c){c.preventDefault();var e,f,g;this.options.blockStore.data=[];var h=function(c,e){c=a(c);var f=b.find(this.blocks,function(a){return a.blockID==c.attr("id")});if(b.isUndefined(f)||b.isEmpty(f)||typeof f!=d.Block){var g=f.save();console.log(g),b.isEmpty(g)||this.options.blockStore.data.push(g)}};return b.each(this.$wrapper.find("."+this.options.baseCSSClass+"-block"),b.bind(h,this)),this.$el.val(this.options.blockStore.data.length===0?"":this.to_json()),!1},to_json:function(){return JSON.stringify(this.options.blockStore)},from_json:function(){var a=this.$el.val();a.length>0?this.options.blockStore=JSON.parse(a):this.options.blockStore.data=[]},_blockTypeAvailable:function(a){return!b.isUndefined(this.blockTypes[a])},_formatterAvailable:function(a){return!b.isUndefined(this.formatters[a])},_ensureAndSetElements:function(){return b.isUndefined(this.options.el)||b.isEmpty(this.options.el)?!1:(this.$el=this.options.el,this.el=this.options.el[0],this.$form=this.$el.parents("form"),this.$el.wrap(a("<div>",{"class":this.options.baseCSSClass})).wrap(a("<div>",{"class":this.options.baseCSSClass+"_dragleave"})).wrap(a("<div>",{id:this.ID,"class":this.options.baseCSSClass+"_container",style:"padding: 20px;",dropzone:"copy link move"})),this.$wrapper=this.$form.find("#"+this.ID),!0)},_setBlocksAndFormatters:function(){this.blockTypes=f(b.isUndefined(this.options.blockTypes)?d.BlockTypes:this.options.blockTypes),this.formatters=f(b.isUndefined(this.options.formatters)?d.Formatters:this.options.formatters)},_toMarkdown:function(a,c){var e;e=a.replace(/\n/mg,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/g,"[$2]($1)").replace(/<\/?b>/g,"**").replace(/<\/?STRONG>/g,"**").replace(/<\/?i>/g,"_").replace(/<\/?EM>/g,"_");var f,g;for(f in this.formatters)d.Formatters.hasOwnProperty(f)&&(g=d.Formatters[f],!b.isUndefined(g.toMarkdown)&&b.isFunction(g.toMarkdown)&&(e=g.toMarkdown(e)));var h;return d.BlockTypes.hasOwnProperty(c)&&(h=d.BlockTypes[c],!b.isUndefined(h.toMarkdown)&&b.isFunction(h.toMarkdown)&&(e=h.toMarkdown(e))),e=e.replace(/([^<>]+)(<div>)/g,"$1\n\n$2").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n\n").replace(/<\/p>/g,"\n\n\n\n").replace(/<(.)?br(.)?>/g,"\n\n").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/<\/?[^>]+(>|$)/g,""),e},_toHTML:function(a,c){var e=a,f,g;for(f in this.formatters)d.Formatters.hasOwnProperty(f)&&(g=d.Formatters[f],!b.isUndefined(g.toHTML)&&b.isFunction(g.toHTML)&&(e=g.toHTML(e)));var h;return d.BlockTypes.hasOwnProperty(c)&&(h=d.BlockTypes[c],!b.isUndefined(h.toHTML)&&b.isFunction(h.toHTML)&&(e=h.toHTML(e))),e=e.replace(/^\> (.+)$/mg,"$1").replace(/\n\n/g,"<br>").replace(/\[(.+)\]\((.+)\)/g,"<a href='$2'>$1</a>").replace(/(?:\*\*)([^*|_]+)(?:\*\*)/mg,"<b>$1</b>").replace(/(?:_)([^*|_]+)(?:_)/mg,"<i>$1</i>"),e}})})(jQuery,_);