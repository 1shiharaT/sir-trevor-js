// Sir Trevor, v0.2.2
// made with love by Made by Many
(function(e,t){function c(e){var n={};return t.each(e,function(r,i){n[t.isArray(e)?r:i]=!0}),n}function h(e){e.preventDefault(),e.stopPropagation()}function p(e){return e.which==17||e.which==224}function d(e,t,n){var r=e.offset().left-t,i=e.offset().top-t,s=r+e.width()+2*t,o=i+e.height()+2*t,u=n.pageX,a=n.pageY;return u>r&&u<s&&a>i&&a<o}function m(e){return e.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}var n=this,r,i=[],s=i.push,o=i.slice,u=i.splice;r=n.SirTrevor={},r.DEBUG=!1,r.SKIP_VALIDATION=!1,r.DEFAULTS={baseCSSClass:"sir-trevor",errorClass:"error",defaultType:"Text",spinner:{className:"spinner",lines:9,length:8,width:3,radius:6,color:"#000",speed:1.4,trail:57,shadow:!1,left:"50%",top:"50%"},marker:{baseCSSClass:"marker",buttonClass:"button",addText:"Click to add:",dropText:"Drop to place content"},formatBar:{baseCSSClass:"formatting-control"},blockLimit:0,blockTypeLimits:{},required:[],uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/"},r.Blocks={},r.Formatters={},r.instances=[];var a=!1,f={bound:[],_bindFunctions:function(){var e=[];e.push(this),e.join(this.bound),t.bindAll.apply(this,e)}},l={tagName:"div",className:"sir-trevor__view",attributes:{},$:function(e){return this.$el.find(e)},render:function(){return this},_ensureElement:function(){if(!this.el){var n=t.extend({},t.result(this,"attributes"));this.id&&(n.id=this.id),this.className&&(n["class"]=this.className);var r=e("<"+this.tagName+">").attr(n);this._setElement(r)}else this._setElement(this.el)},_setElement:function(t){return this.$el=t instanceof jQuery?t:e(t),this.el=this.$el[0],this}};(function(e){function t(e){h(e)}function n(e){e.originalEvent.dataTransfer.dropEffect="copy",h(e)}function r(e){h(e)}e.fn.dropArea=function(){return this.bind("dragenter",t).bind("dragover",n).bind("dragleave",r),this},e.fn.noDropArea=function(){return this.unbind("dragenter").unbind("dragover").unbind("dragleave"),this}})(jQuery);var v=function(e,n){var r=this,i;e&&t.has(e,"constructor")?i=e.constructor:i=function(){return r.apply(this,arguments)},t.extend(i,r,n);var s=function(){this.constructor=i};return s.prototype=r.prototype,i.prototype=new s,e&&t.extend(i.prototype,e),i.__super__=r.prototype,i};r.log=function(e){!t.isUndefined(console)&&r.DEBUG&&console.log(e)};var g=/\s+/,y=function(e,t,n,r){if(!n)return!0;if(typeof n=="object"){for(var i in n)e[t].apply(e,[i,n[i]].concat(r));return!1}if(g.test(n)){var s=n.split(g);for(var o=0,u=s.length;o<u;o++)e[t].apply(e,[s[o]].concat(r));return!1}return!0},b=function(e,t){var n,r=-1,i=e.length,s=t[0],o=t[1],u=t[2];switch(t.length){case 0:while(++r<i)(n=e[r]).callback.call(n.ctx);return;case 1:while(++r<i)(n=e[r]).callback.call(n.ctx,s);return;case 2:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o);return;case 3:while(++r<i)(n=e[r]).callback.call(n.ctx,s,o,u);return;default:while(++r<i)(n=e[r]).callback.apply(n.ctx,t)}},w=r.Events={on:function(e,t,n){if(!y(this,"on",e,[t,n])||!t)return this;this._events||(this._events={});var r=this._events[e]||(this._events[e]=[]);return r.push({callback:t,context:n,ctx:n||this}),this},once:function(e,n,r){if(!y(this,"once",e,[n,r])||!n)return this;var i=this,s=t.once(function(){i.off(e,s),n.apply(this,arguments)});return s._callback=n,this.on(e,s,r)},off:function(e,n,r){var i,s,o,u,a,f,l,c;if(!this._events||!y(this,"off",e,[n,r]))return this;if(!e&&!n&&!r)return this._events={},this;u=e?[e]:t.keys(this._events);for(a=0,f=u.length;a<f;a++){e=u[a];if(o=this._events[e]){this._events[e]=i=[];if(n||r)for(l=0,c=o.length;l<c;l++)s=o[l],(n&&n!==s.callback&&n!==s.callback._callback||r&&r!==s.context)&&i.push(s);i.length||delete this._events[e]}}return this},trigger:function(e){if(!this._events)return this;var t=o.call(arguments,1);if(!y(this,"trigger",e,t))return this;var n=this._events[e],r=this._events.all;return n&&b(n,t),r&&b(r,arguments),this},stopListening:function(e,t,n){var r=this._listeners;if(!r)return this;var i=!t&&!n;typeof t=="object"&&(n=this),e&&((r={})[e._listenerId]=e);for(var s in r)r[s].off(t,n,this),i&&delete this._listeners[s];return this}},E={listenTo:"on",listenToOnce:"once"};t.each(E,function(e,n){w[n]=function(n,r,i){var s=this._listeners||(this._listeners={}),o=n._listenerId||(n._listenerId=t.uniqueId("l"));return s[o]=n,typeof r=="object"&&(i=this),n[e](r,i,this),this}}),w.bind=w.on,w.unbind=w.off;var S=e(r);r.subscribe=r.on=function(){S.on.apply(S,arguments)},r.unsubscribe=r.off=function(){S.off.apply(S,arguments)},r.publish=r.trigger=function(){S.trigger.apply(S,arguments)},r.subscribeAll=function(e){t.each(e,function(e){S.on.apply(S,arguments)})},function(e,t,n){function r(e,n){var r=t.createElement(e||"div"),i;for(i in n)r[i]=n[i];return r}function i(e){for(var t=1,n=arguments.length;t<n;t++)e.appendChild(arguments[t]);return e}function s(e,t,n,r){var i=["opacity",t,~~(e*100),n,r].join("-"),s=.01+n/r*100,o=Math.max(1-(1-e)/t*(100-s),e),u=h.substring(0,h.indexOf("Animation")).toLowerCase(),a=u&&"-"+u+"-"||"";return c[i]||(p.insertRule("@"+a+"keyframes "+i+"{"+"0%{opacity:"+o+"}"+s+"%{opacity:"+e+"}"+(s+.01)+"%{opacity:1}"+(s+t)%100+"%{opacity:"+e+"}"+"100%{opacity:"+o+"}"+"}",0),c[i]=1),i}function o(e,t){var r=e.style,i,s;if(r[t]!==n)return t;t=t.charAt(0).toUpperCase()+t.slice(1);for(s=0;s<l.length;s++){i=l[s]+t;if(r[i]!==n)return i}}function u(e,t){for(var n in t)e.style[o(e,n)||n]=t[n];return e}function a(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var i in r)e[i]===n&&(e[i]=r[i])}return e}function f(e){var t={x:e.offsetLeft,y:e.offsetTop};while(e=e.offsetParent)t.x+=e.offsetLeft,t.y+=e.offsetTop;return t}var l=["webkit","Moz","ms","O"],c={},h,p=function(){var e=r("style");return i(t.getElementsByTagName("head")[0],e),e.sheet||e.styleSheet}(),d={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto"},v=function m(e){if(!this.spin)return new m(e);this.opts=a(e||{},m.defaults,d)};v.defaults={},a(v.prototype,{spin:function(e){this.stop();var t=this,n=t.opts,i=t.el=u(r(0,{className:n.className}),{position:"relative",zIndex:n.zIndex}),s=n.radius+n.length+n.width,o,a;e&&(e.insertBefore(i,e.firstChild||null),a=f(e),o=f(i),u(i,{left:(n.left=="auto"?a.x-o.x+(e.offsetWidth>>1):n.left+s)+"px",top:(n.top=="auto"?a.y-o.y+(e.offsetHeight>>1):n.top+s)+"px"})),i.setAttribute("aria-role","progressbar"),t.lines(i,t.opts);if(!h){var l=0,c=n.fps,p=c/n.speed,d=(1-n.opacity)/(p*n.trail/100),v=p/n.lines;!function m(){l++;for(var e=n.lines;e;e--){var r=Math.max(1-(l+e*v)%p*d,n.opacity);t.opacity(i,n.lines-e,r,n)}t.timeout=t.el&&setTimeout(m,~~(1e3/c))}()}return t},stop:function(){var e=this.el;return e&&(clearTimeout(this.timeout),e.parentNode&&e.parentNode.removeChild(e),this.el=n),this},lines:function(e,t){function n(e,n){return u(r(),{position:"absolute",width:t.length+t.width+"px",height:t.width+"px",background:e,boxShadow:n,transformOrigin:"left",transform:"rotate("+~~(360/t.lines*o+t.rotate)+"deg) translate("+t.radius+"px"+",0)",borderRadius:(t.width>>1)+"px"})}var o=0,a;for(;o<t.lines;o++)a=u(r(),{position:"absolute",top:1+~(t.width/2)+"px",transform:t.hwaccel?"translate3d(0,0,0)":"",opacity:t.opacity,animation:h&&s(t.opacity,t.trail,o,t.lines)+" "+1/t.speed+"s linear infinite"}),t.shadow&&i(a,u(n("#000","0 0 4px #000"),{top:"2px"})),i(e,i(a,n(t.color,"0 0 1px rgba(0,0,0,.1)")));return e},opacity:function(e,t,n){t<e.childNodes.length&&(e.childNodes[t].style.opacity=n)}}),!function(){function e(e,t){return r("<"+e+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',t)}var t=u(r("group"),{behavior:"url(#default#VML)"});!o(t,"transform")&&t.adj?(p.addRule(".spin-vml","behavior:url(#default#VML)"),v.prototype.lines=function(t,n){function r(){return u(e("group",{coordsize:a+" "+a,coordorigin:-o+" "+ -o}),{width:a,height:a})}function s(t,s,a){i(l,i(u(r(),{rotation:360/n.lines*t+"deg",left:~~s}),i(u(e("roundrect",{arcsize:1}),{width:o,height:n.width,left:n.radius,top:-n.width>>1,filter:a}),e("fill",{color:n.color,opacity:n.opacity}),e("stroke",{opacity:0}))))}var o=n.length+n.width,a=2*o,f=-(n.width+n.length)*2+"px",l=u(r(),{position:"absolute",top:f,left:f}),c;if(n.shadow)for(c=1;c<=n.lines;c++)s(c,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(c=1;c<=n.lines;c++)s(c);return i(t,l)},v.prototype.opacity=function(e,t,n,r){var i=e.firstChild;r=r.shadow&&r.lines||0,i&&t+r<i.childNodes.length&&(i=i.childNodes[t+r],i=i&&i.firstChild,i=i&&i.firstChild,i&&(i.opacity=n))}):h=o(t,"animation")}(),e.Spinner=v}(window,document),function(e){e.fn.limit_chars=function(){if(this.length===0)return;this.attr("maxlength")&&(this.attr("data-maxlength",this.attr("maxlength")),this.removeAttr("maxlength")),this.parents(".extended_input").length===0&&(count=this.chars()<this.attr("data-maxlength")?this.chars():"<em>"+this.chars()+"</em>",this.wrap(e("<div>",{"class":"extended_input"})).after(e("<span>",{"class":"count",html:count+" of "+this.attr("data-maxlength")})),this.bind("keydown keyup paste",function(t){count=e(this).chars()<e(this).attr("data-maxlength")?e(this).chars():"<em>"+e(this).chars()+"</em>",e(this).parent().find(".count").html(count+" of "+e(this).attr("data-maxlength"))}))},e.fn.chars=function(){return count=this.attr("contenteditable")!==undefined?this.text().length:this.val().length,count},e.fn.too_long=function(){return this.chars()>this.attr("data-maxlength")}}(jQuery),r.blockStore=function(e,t,n){var r;n=n||{};switch(e){case"create":var i=n.data||{};t.dataStore={type:t.type.toLowerCase(),data:i};break;case"save":n.data&&(t.dataStore.data=n.data,r=t.dataStore);break;case"read":r=t.dataStore}if(r)return r},r.editorStore=function(e,n,r){var i;r=r||{};switch(e){case"create":var s=t.trim(n.$el.val());n.dataStore={data:[]};if(s.length>0)try{var o=JSON.parse(s);t.isUndefined(o.data)||(n.dataStore=o)}catch(u){console.log("Sorry there has been a problem with parsing the JSON"),console.log(u)}break;case"reset":n.dataStore={data:[]};break;case"add":r.data&&(n.dataStore.data.push(r.data),i=n.dataStore);break;case"save":n.$el.val(n.dataStore.data.length>0?JSON.stringify(n.dataStore):"");break;case"read":i=n.dataStore}if(i)return i};var x=function(){this.intialize()};t.extend(x.prototype,{intialize:function(){this.submitBtn=e("input[type='submit']");var n=[];t.each(this.submitBtn,function(t){n.push(e(t).attr("value"))}),this.submitBtnTitles=n,this.canSubmit=!0,this.globalUploadCount=0,this._bindEvents()},setSubmitButton:function(e,t){this.submitBtn.attr("value",t)},resetSubmitButton:function(){t.each(this.submitBtn,t.bind(function(t,n){e(t).attr("value",this.submitBtnTitles[n])},this))},onUploadStart:function(e){this.globalUploadCount++,r.log("onUploadStart called "+this.globalUploadCount),this.globalUploadCount===1&&this._disableSubmitButton()},onUploadStop:function(e){this.globalUploadCount=this.globalUploadCount<=0?0:this.globalUploadCount-1,r.log("onUploadStop called "+this.globalUploadCount),this.globalUploadCount===0&&this._enableSubmitButton()},onError:function(e){r.log("onError called"),this.canSubmit=!1},_disableSubmitButton:function(e){this.setSubmitButton(null,e||"Please wait..."),this.submitBtn.attr("disabled","disabled").addClass("disabled")},_enableSubmitButton:function(){this.resetSubmitButton(),this.submitBtn.removeAttr("disabled").removeClass("disabled")},_bindEvents:function(){r.subscribe("disableSubmitButton",t.bind(this._disableSubmitButton,this)),r.subscribe("enableSubmitButton",t.bind(this._enableSubmitButton,this)),r.subscribe("setSubmitButton",t.bind(this.setSubmitButton,this)),r.subscribe("resetSubmitButton",t.bind(this.resetSubmitButton,this)),r.subscribe("onError",t.bind(this.onError,this)),r.subscribe("onUploadStart",t.bind(this.onUploadStart,this)),r.subscribe("onUploadStop",t.bind(this.onUploadStop,this))}}),r.submittable=function(){new x},r.fileUploader=function(n,i,s,o){r.publish("onUploadStart");var u=[n.instance.ID,(new Date).getTime(),"raw"].join("-"),a=new FormData;a.append("attachment[name]",i.name),a.append("attachment[file]",i),a.append("attachment[uid]",u);var f=function(e){!t.isUndefined(s)&&t.isFunction(s)&&(r.log("Upload callback called"),r.publish("onUploadStop"),t.bind(s,n)(e))},l=function(e,i,s){!t.isUndefined(o)&&t.isFunction(o)&&(r.log("Upload callback error called"),r.publish("onUploadError"),t.bind(o,n)(i))};e.ajax({url:n.instance.options.uploadUrl,data:a,cache:!1,contentType:!1,processData:!1,type:"POST",success:f,error:l})};var T=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;t.mixin({isURI:function(e){return T.test(e)},capitalize:function(e){return e.charAt(0).toUpperCase()+e.substring(1).toLowerCase()},trim:function(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}});var N=r.Block=function(e,n){this.instance=e,this.type=this._getBlockType(),this.store("create",this,{data:n}),this.uploadsCount=0,this.blockID=t.uniqueId(this.className+"-"),this._setBaseElements(),this._bindFunctions(),this.initialize.apply(this,arguments)},C=["className","toolbarEnabled","formattingEnabled","dropEnabled","title","limit","editorHTML","dropzoneHTML","validate","loadData","toData","onDrop","onContentPasted","onBlockRender","beforeBlockRender","setTextLimit","toMarkdown","toHTML"];t.extend(N.prototype,f,{bound:["_handleDrop","_handleContentPaste","onBlockFocus","onBlockBlur","onDrop","onDragStart","onDragEnd"],$:function(e){return this.$el.find(e)},$$:function(e){return this.$editor.find(e)},className:"",title:"",limit:0,editorHTML:"<div></div>",dropzoneHTML:'<div class="dropzone"><p>Drop content here</p></div>',toolbarEnabled:!0,dropEnabled:!1,formattingEnabled:!0,initialize:function(){},loadData:function(e){},onBlockRender:function(){},beforeBlockRender:function(){},setTextLimit:function(){},toMarkdown:function(e){return e},toHTML:function(e){return e},store:function(){return r.blockStore.apply(this,arguments)},render:function(){this.beforeBlockRender(),this.dropEnabled&&this._initDragDrop();var n=this.getData();!t.isUndefined(n)&&!t.isEmpty(n)&&this._loadData(),this.save(),this.$el.append(e("<span>",{"class":"st-block__reorder",draggable:!0})),this.$el.append(e("<span>",{"class":"st-block__remove"})),this.$el.bind("drop",h).bind("mouseover",h).bind("mouseout",h).bind("dragleave",h).bind("mouseover",function(t){e(this).siblings().removeClass("active"),e(this).addClass("active")}).bind("mouseout",function(t){e(this).removeClass("active")}).bind("dragover",function(e){e.preventDefault()}),this._initPaste(),this.$(".st-block__remove").bind("click",this.onDeleteClick);if(this.$$(".text-block").length>0)return document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBrOnReturn",!1,!0),this.$$(".text-block").bind("paste",this._handleContentPaste).bind("focus",this.onBlockFocus).bind("blur",this.onBlockBlur),this._initFormatting(),this;if(t.isEmpty(n.data)&&this.instance.blocks.length>0){var r=this.$$('[contenteditable="true"], input');r.length>0&&!this.dropEnabled&&r[0].focus()}this._initReordering(),this.$el.addClass("st-item-ready"),this.setTextLimit(),this.onBlockRender()},remove:function(){this.$el.remove()},save:function(){return this.toData(),this.store("read",this)},getData:function(){return this.store("read",this).data},setData:function(e){r.log("Setting data for block "+this.blockID),this.store("save",this,{data:e})},loading:function(){t.isUndefined(this.spinner)||this.ready(),this.$el.addClass("loading")},ready:function(){this.$el.removeClass("loading"),t.isUndefined(this.spinner)||(this.spinner.stop(),delete this.spinner)},validate:function(){this._beforeValidate();var n=this.$$(".required, [data-maxlength]"),r=0;return t.each(n,t.bind(function(t){t=e(t);var n=t.attr("contenteditable")?t.text():t.val(),i=t.attr("data-maxlength")&&t.too_long(),s=t.hasClass("required");if(s&&n.length===0||i)t.addClass("st-error"),r++},this)),r>0&&this.$el.addClass("st-block--with-errors"),r===0},toData:function(){r.log("toData for "+this.blockID);var n=this.$el,i={};if(this.$$(".text-block").length>0){var s=this.$$(".text-block").html();s.length>0&&(i.text=this.instance._toMarkdown(s,this.type))}var o=!t.isUndefined(i.text)||this.$$(".text-block").length===0;this.$$('input[type="text"]').not(".paste-block").length>0&&this.$$('input[type="text"]').each(function(t,n){n=e(n),n.val().length>0&&o&&(i[n.attr("name")]=n.val())}),this.$$("select").each(function(t,n){n=e(n),n.val().length>0&&o&&(i[n.attr("name")]=n.val())}),this.$$('input[type="file"]').each(function(t,n){n=e(n),i.file=n.data("json")}),t.isEmpty(i)||this.setData(i)},onDrop:function(e){},onDragStart:function(t){var n=e(t.target);t.originalEvent.dataTransfer.setDragImage(n.parent()[0],13,25),t.originalEvent.dataTransfer.setData("Text",n.parent().attr("id")),n.parent().addClass("dragging")},onDragEnd:function(t){var n=e(t.target);n.parent().removeClass("dragging")},onDeleteClick:function(e){confirm("Are you sure you wish to delete this content?")&&h(e)},onContentPasted:function(e){var t=this.$$(".text-block");t.length>0},onBlockFocus:function(e){this.$el.addClass("focussed")},onBlockBlur:function(e){this.$el.removeClass("focussed")},uploader:function(e,t){r.fileUploader(this,e,t)},_loadData:function(){r.log("loadData for "+this.blockID),this.loading(),this.dropEnabled&&(this.$dropzone.hide(),this.$editor.show()),r.publish("editor/block/loadData"),this.loadData(this.getData()),this.ready()},_beforeValidate:function(){this.errors=[];var e="st-error";this.$el.removeClass("st-block--with-errors"),this.$("."+e).removeClass(e),this.$(".error-marker").remove()},_handleContentPaste:function(e){var n=function(e){this.onContentPasted(e)};t.delay(t.bind(n,this,e),100)},_handleDrop:function(n){n.preventDefault(),n=n.originalEvent,r.publish("editor/block/handleDrop");var i=e(n.target),s=n.dataTransfer.types,o,u=[];this.$dropzone.removeClass("drag-enter"),t.isUndefined(s)||(t.include(s,"Files")||t.include(s,"text/plain")||t.include(s,"text/uri-list"))&&this.onDrop(n.dataTransfer)},_setBaseElements:function(){var n=t.isFunction(this.editorHTML)?this.editorHTML():this.editorHTML,r=e("<div>",{"class":"st-block__inner "+this._getBlockClass(),html:n});this.$el=e("<div>",{"class":"st-block",id:this.blockID,"data-type":this.type,"data-instance":this.instance.ID,html:r}),this.el=this.$el[0],this.$editor=r},_getBlockType:function(){var e="";for(var t in r.Blocks)r.Blocks[t].prototype==Object.getPrototypeOf(this)&&(e=t);return e},_getBlockClass:function(){return"st-block--"+this.className},_initDragDrop:function(){r.log("Adding drag and drop capabilities for block "+this.blockID),this.$dropzone=e("<div>",{html:this.dropzoneHTML,"class":"dropzone "+this._getBlockClass()}),this.$el.append(this.$dropzone),this.$editor.hide(),this.$dropzone.bind("drop",this._handleDrop).bind("dragenter",function(t){h(t),e(this).addClass("drag-enter")}).bind("dragover",function(t){t.originalEvent.dataTransfer.dropEffect="copy",h(t),e(this).addClass("drag-enter")}).bind("dragleave",function(t){h(t),e(this).removeClass("drag-enter")})},_initReordering:function(){this.$(".st-block__reorder").bind("dragstart",this.onDragStart).bind("dragend",this.onDragEnd)},_initFormatting:function(){var e},_initPaste:function(){this.$(".paste-block").bind("click",function(){e(this).select()}).bind("paste",this._handleContentPaste).bind("submit",this._handleContentPaste)},_initTextLimits:function(){this.$$("input[maxlength!=-1][maxlength!=524288][maxlength!=2147483647]").limit_chars()}}),N.extend=v;var k=r.Formatter=function(e){this.formatId=t.uniqueId("format-"),this._configure(e||{}),this.initialize.apply(this,arguments)},L=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];t.extend(k.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(e){return e},toHTML:function(e){return e},initialize:function(){},_configure:function(e){this.options&&(e=t.extend({},this.options,e));for(var n=0,r=L.length;n<r;n++){var i=L[n];e[i]&&(this[i]=e[i])}this.options=e},_bindToBlock:function(e){var t=this,n=!1;e.on("keyup",".text-block",function(e){if(e.which==17||e.which==224)n=!1}).on("keydown",".text-block",{formatter:t},function(e){if(e.which==17||e.which==224)n=!0;e.which==e.data.formatter.keyCode&&n===!0&&(document.execCommand(e.data.formatter.cmd,!1,!0),e.preventDefault())})}}),k.extend=v,r.Blocks.Quote=r.Block.extend({title:"Quote",className:"quote",limit:0,editorHTML:function(){return t.template('<blockquote class="required text-block <%= className %>" contenteditable="true"></blockquote><div class="input text"><label>Credit</label><input maxlength="140" name="cite" class="input-string required" type="text" /></div>',this)},loadData:function(e){this.$$(".text-block").html(this.instance._toHTML(e.text,this.type)),this.$$("input").val(e.cite)},toMarkdown:function(e){return e.replace(/^(.+)$/mg,"> $1")}});var A='<p>Drop images here</p><div class="input submit"><input type="file" multiple="multiple" /></div><button>...or choose file(s)</button>';r.Blocks.Gallery=r.Block.extend({title:"Gallery",className:"gallery",dropEnabled:!0,editorHTML:'<div class="gallery-items"><p>Gallery Contents:</p><ul></ul></div>',dropzoneHTML:A,loadData:function(e){t.isArray(e)&&(t.each(e,t.bind(function(e){this.renderGalleryThumb(e)},this)),this.$dropzone.show())},renderGalleryThumb:function(n){if(t.isUndefined(n.data.file))return!1;var r=e("<img>",{src:n.data.file.thumb.url}),i=e("<li>",{id:t.uniqueId("gallery-item"),"class":"gallery-item",html:r});i.append(e("<span>",{"class":"delete",click:t.bind(function(t){h(t),confirm("Are you sure you wish to delete this image?")&&(e(t.target).parent().remove(),this.reindexData())},this)})),i.data("block",n),this.$$("ul").append(i),i.dropArea().bind("dragstart",t.bind(function(t){var n=e(t.target);t.originalEvent.dataTransfer.setData("Text",n.parent().attr("id")),n.parent().addClass("dragging")},this)).bind("drag",t.bind(function(e){},this)).bind("dragend",t.bind(function(t){var n=e(t.target);n.parent().removeClass("dragging")},this)).bind("dragover",t.bind(function(t){var n=e(t.target);n.parents("li").addClass("dragover")},this)).bind("dragleave",t.bind(function(t){var n=e(t.target);n.parents("li").removeClass("dragover")},this)).bind("drop",t.bind(function(t){var n=e(t.target),r=n.parent();n=n.hasClass("gallery-item")?n:r,this.$$("ul li.dragover").removeClass("dragover");var i=e("#"+t.originalEvent.dataTransfer.getData("text/plain"));if(i.attr("id")===n.attr("id"))return!1;i.length>0&&i.hasClass("gallery-item")&&n.before(i),this.reindexData()},this))},onBlockRender:function(){this.$dropzone.find("button").bind("click",h),this.$dropzone.find("input").on("change",t.bind(function(e){this.onDrop(e.currentTarget)},this))},reindexData:function(){var n=this.getData();n=[],t.each(this.$$("li.gallery-item"),function(t){t=e(t),n.push(t.data("block"))}),this.setData(n)},onDrop:function(e){if(e.files.length>0){var n=e.files.length,r,i=typeof URL!="undefined"?URL:typeof webkitURL!="undefined"?webkitURL:null;this.loading();while(n--)r=e.files[n],/image/.test(r.type)&&(this.uploadsCount+=1,this.$editor.show(),this.uploader(r,function(e){this.uploadsCount-=1;var n=this.getData();e={type:"image",data:e},t.isArray(n)||(n=[]),n.push(e),this.setData(n),this.renderGalleryThumb(e),this.uploadsCount===0&&this.ready()}))}}});var A='<p>Drop image here</p><div class="input submit"><input type="file" /></div><button>...or choose a file</button>';r.Blocks.Image=r.Block.extend({title:"Image",className:"image",dropEnabled:!0,dropzoneHTML:A,loadData:function(t){this.$editor.html(e("<img>",{src:t.file.url}))},onBlockRender:function(){this.$dropzone.find("button").bind("click",h),this.$dropzone.find("input").on("change",t.bind(function(e){this.onDrop(e.currentTarget)},this))},onDrop:function(t){var n=t.files[0],i=typeof URL!="undefined"?URL:typeof webkitURL!="undefined"?webkitURL:null;/image/.test(n.type)&&(this.loading(),this.$dropzone.hide(),this.$editor.html(e("<img>",{src:i.createObjectURL(n)})),this.$editor.show(),r.publish("setSubmitButton",["Please wait..."]),this.uploader(n,function(e){this.setData(e),this.ready()},function(e){alert("Error!")}))}}),r.Blocks.Text=r.Block.extend({title:"Text",className:"text",limit:0,editorHTML:'<div class="required text-block" contenteditable="true"></div>',loadData:function(e){this.$$(".text-block").html(this.instance._toHTML(e.text,this.type))}});var O='<p>Drop tweet link here</p><div class="input text"><label>or paste URL:</label><input type="text" class="paste-block"></div>',M='<div class="tweet"><img src="<%= user.profile_image_url %>" class="tweet-avatar"><div class="tweet-body"><p class="tweet-user"><a href="http://twitter.com/#!/<%= user.screen_name %>" class="tweet-user">@<%= user.screen_name %></a> on Twitter</p><p class="tweet-text"><%= text %></p><time><%= created_at %></time></div></div>';r.Blocks.Tweet=r.Block.extend({title:"Tweet",className:"tweet",dropEnabled:!0,dropzoneHTML:O,loadData:function(e){this.$editor.html(t.template(M,e))},onContentPasted:function(t){var n=e(t.target),r=n.val();this.handleTwitterDropPaste(r)},handleTwitterDropPaste:function(n){if(t.isURI(n)&&n.indexOf("twitter")!=-1&&n.indexOf("status")!=-1){var r=n.match(/[^\/]+$/);if(!t.isEmpty(r)){this.loading(),r=r[0];var i=function(e){var t={user:{profile_image_url:e.user.profile_image_url,profile_image_url_https:e.user.profile_image_url_https,screen_name:e.user.screen_name,name:e.user.name},text:e.text,created_at:e.created_at,status_url:n};this.setData(t),this._loadData(),this.ready()},s=function(){this.ready()};e.ajax({url:"http://api.twitter.com/1/statuses/show/"+r+".json",dataType:"JSONP",success:t.bind(i,this),error:t.bind(s,this)})}}},onDrop:function(e){var t=e.getData("text/plain");this.handleTwitterDropPaste(t)}});var _='<div class="text-block <%= className %>" contenteditable="true"></div>';r.Blocks.Ul=r.Block.extend({title:"List",className:"list",editorHTML:function(){return t.template(_,this)},onBlockRender:function(){this.$$(".text-block").bind("click",function(){e(this).html().length===0&&document.execCommand("insertUnorderedList",!1,!1)}),t.isEmpty(this.data)&&this.$$(".text-block").focus().click()},loadData:function(e){this.$$(".text-block").html("<ul>"+this.instance._toHTML(e.text,this.type)+"</ul>")},toMarkdown:function(e){return e.replace(/<\/li>/mg,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/mg," - $1")},toHTML:function(e){return e=e.replace(/^ - (.+)$/mg,"<li>$1</li>").replace(/\n/mg,""),e="<ul>"+e+"</ul>",e}});var D='<p>Drop video link here</p><div class="input text"><label>or paste URL:</label><input type="text" class="paste-block"></div>',P=/http[s]?:\/\/(?:www.)?(?:(vimeo).com\/(.*))|(?:(youtu(?:be)?).(?:be|com)\/(?:watch\?v=)?([^&]*)(?:&(?:.))?)/;r.Blocks.Video=r.Block.extend({title:"Video",className:"video",dropEnabled:!0,dropzoneHTML:D,loadData:function(e){e.source=="youtube"||e.source=="youtu"?this.$editor.html('<iframe src="'+window.location.protocol+"//www.youtube.com/embed/"+e.remote_id+'" width="580" height="320" frameborder="0" allowfullscreen></iframe>'):e.source=="vimeo"&&this.$editor.html('<iframe src="'+window.location.protocol+"//player.vimeo.com/video/"+e.remote_id+'?title=0&byline=0" width="580" height="320" frameborder="0"></iframe>')},onContentPasted:function(t){var n=e(t.target),r=n.val();this.handleDropPaste(r)},handleDropPaste:function(e){if(t.isURI(e))if(e.indexOf("youtu")!=-1||e.indexOf("vimeo")!=-1){var n={},r=e.match(P);r[3]!==undefined?(n.source=r[3],n.remote_id=r[4]):r[1]!==undefined&&(n.source=r[1],n.remote_id=r[2]),n.source=="youtu"&&(n.source="youtube"),this.setData(n),this._loadData()}},onDrop:function(e){var t=e.getData("text/plain");this.handleDropPaste(t)}});var H=r.Formatter.extend({title:"B",className:"bold",cmd:"bold",keyCode:66}),B=r.Formatter.extend({title:"I",className:"italic",cmd:"italic",keyCode:73}),j=r.Formatter.extend({title:"U",className:"underline",cmd:"underline"}),F=r.Formatter.extend({title:"Link",className:"link",cmd:"CreateLink",onClick:function(){var e=prompt("Enter a link"),t=/(ftp|http|https):\/\/./;e&&e.length>0&&(t.test(e)||(e="http://"+e),document.execCommand(this.cmd,!1,e))}}),I=r.Formatter.extend({title:"Unlink",className:"link",cmd:"unlink"});r.Formatters.Bold=new H,r.Formatters.Italic=new B,r.Formatters.Link=new F,r.Formatters.Unlink=new I;var q=r.BlockControl=function(e,t){this.type=e,this.instance_scope=t,this._ensureElement(),this.initialize()};t.extend(q.prototype,f,l,w,{tagName:"a",className:"st-block-control",attributes:function(){return{"data-type":this.type}},initialize:function(){this.block_type=r.Blocks[this.type].prototype,this.can_be_rendered=this.block_type.toolbarEnabled},render:function(){return this.$el.text(this.block_type.title),this}});var R=r.BlockControls=function(e,t){this.instance_scope=t,this.available_types=e||[],this._ensureElement(),this.initialize()};t.extend(R.prototype,f,l,w,{className:"st-block-controls",initialize:function(){for(block_type in this.available_types)if(r.Blocks.hasOwnProperty(block_type)){var e=new r.BlockControl(block_type,this.instance_scope);e.can_be_rendered&&this.$el.append(e.render().$el)}this.$el.delegate("a","click",t.bind(this.handleButtonClick,this))},handleButtonClick:function(e){e.preventDefault(),this.trigger("createBlock",e.target.dataset.type)}});var U=r.FormatBar=function(e,n){this.instance=n,this.options=t.extend({},r.DEFAULTS.formatBar,e||{}),this.className=this.instance.baseCSS(this.options.baseCSSClass),this.clicked=!1,this._bindFunctions()};t.extend(U.prototype,f,{bound:["onFormatButtonClick"],render:function(){var n=e("<div>",{"class":this.className});this.instance.$wrapper.prepend(n),this.$el=n;var i=this.instance.formatters,s,o;for(s in i)r.Formatters.hasOwnProperty(s)&&(o=r.Formatters[s],e("<button>",{"class":this.instance.baseCSS("format-button"),text:o.title,"data-type":s,"data-cmd":o.cmd,click:this.onFormatButtonClick}).appendTo(this.$el));var u=t.throttle(t.bind(this.handleDocumentScroll,this),150);e(document).bind("scroll",u),this.$el.find("button").length===0&&this.$el.addClass("hidden"),this.show()},handleDocumentScroll:function(){var t=this.instance.$outer.height(),n=this.instance.$outer.offset().top,r=e(document).scrollTop();this.$el.hasClass("fixed")&&(n=this.$el.offset().top),r>5&&r>=n?(this.$el.addClass("fixed").css({width:this.instance.$wrapper.width()}),this.instance.$wrapper.css({"padding-top":"104px"})):(this.$el.removeClass("fixed").css({width:"100%"}),this.instance.$wrapper.css({"padding-top":"16px"}))},hide:function(){this.$el.removeClass(this.instance.baseCSS("item-ready"))},show:function(){this.$el.addClass(this.instance.baseCSS("item-ready"))},remove:function(){this.$el.remove()},onFormatButtonClick:function(n){h(n);var i=e(n.target),s=r.Formatters[i.attr("data-type")];!t.isUndefined(s.onClick)&&t.isFunction(s.onClick)?s.onClick():document.execCommand(i.attr("data-cmd"),!1,s.param),this.show()}});var z=r.Editor=function(e){r.log("Init SirTrevor.Editor"),this.blockTypes={},this.formatters={},this.blockCounts={},this.blocks=[],this.errors=[],this.cachedDomBlocks=[],this.options=t.extend({},r.DEFAULTS,e||{}),this.ID=t.uniqueId("st-editor-"),this._ensureAndSetElements()&&(this.formatBar=new r.FormatBar(this.options.formatBar,this),!t.isUndefined(this.options.onEditorRender)&&t.isFunction(this.options.onEditorRender)&&(this.onEditorRender=this.options.onEditorRender),this._setRequired(),this._setBlocksAndFormatters(),this._bindFunctions(),this.block_controls=new r.BlockControls(this.blockTypes,this.ID),this.listenTo(this.block_controls,"createBlock",this.createBlock),this.store("create",this),this.build(),r.instances.push(this),r.bindFormSubmit(this.$form))};t.extend(z.prototype,f,w,{bound:["onFormSubmit"],initialize:function(){},build:function(){this.$el.hide(),this.formatBar.render(),this.$outer.append(this.block_controls.render().$el);var e=this.store("read",this);e.data.length===0?this.createBlock(this.options.defaultType):t.each(e.data,t.bind(function(e){r.log("Creating: ",e),this.createBlock(e.type,e.data)},this)),this.$wrapper.addClass("sir-trevor-ready"),t.isUndefined(this.onEditorRender)||this.onEditorRender()},store:function(){return r.editorStore.apply(this,arguments)},createBlock:function(e,n){e=t.capitalize(e);if(this._blockTypeAvailable(e)){var i=r.Blocks[e],s=t.isUndefined(this.blockCounts[e])?0:this.blockCounts[e],o=this.blocks.length,u=this._getBlockTypeLimit(e);if(u!==0&&s>u||this.options.blockLimit!==0&&o>=this.options.blockLimit)return r.log("Block Limit reached for type "+e),!1;var a=new i(this,n||{});this.$wrapper.append(a.render().$el),t.isUndefined(this.blockCounts[e])&&(this.blockCounts[e]=0),this.blocks.push(a),s++,this.blockCounts[e]=s,this.options.blockLimit!==0&&this.blocks.length>=this.options.blockLimit,u!==0&&s>=u&&r.log("Block Limit reached for type "+e+" setting state as inactive"),r.publish("editor/block/createBlock"),r.log("Block created of type "+e),this.cachedDomBlocks=this.$wrapper.find("."+this.baseCSS("block"))}else r.log("Block type not available "+e)},removeBlock:function(e){e.remove(),this.blockCounts[e.type]=this.blockCounts[e.type]-1,this.blocks=t.reject(this.blocks,function(t){return t.blockID==e.blockID}),t.isUndefined(this.blocks)&&(this.blocks=[]),r.publish("editor/block/removeBlock"),this.cachedDomBlocks=this.$wrapper.find("."+this.baseCSS("block")),this._getBlockTypeLimit(e.type)>this.blockCounts[e.type]&&r.log("Removing block limit for "+e.type)},performValidations:function(e,n){var i=0;!r.SKIP_VALIDATION&&n?e.validate()||(r.log("Block "+e.blockID+" failed validation"),++i):e._beforeValidate();var s=e.save();return t.isEmpty(s.data)||(r.log("Adding data for block "+e.blockID+" to block store"),this.store("add",this,{data:s})),i},onFormSubmit:function(n){n=n===!1?!1:!0,r.log("Handling form submission for Editor "+this.ID);var i,s,o,u=0;this.removeErrors(),this.store("reset",this);var a=function(i,s){i=e(i);var o=t.find(this.blocks,function(e){return e.blockID==i.attr("id")});if(!t.isUndefined(o)||!t.isEmpty(o)||typeof o==r.Block)u+=this.performValidations(o,n)};return t.each(this.$wrapper.find("."+this.options.baseCSSClass+"-block"),t.bind(a,this)),this.required&&!r.SKIP_VALIDATION&&n&&t.each(this.required,t.bind(function(e){if(this._blockTypeAvailable(e))if(t.isUndefined(this.blockCounts[e])||this.blockCounts[e]===0)this.errors.push({text:"You must have a block of type "+e}),r.log("Failed validation on required block type "+e),u++;else{var n=t.filter(this.blocks,function(n){return n.type==e&&!t.isEmpty(n.getData())});n.length===0&&(this.errors.push({text:"A required block type "+e+" is empty"}),u++,r.log("A required block type "+e+" is empty"))}},this)),this.store("save",this),u>0&&this.renderErrors(),u},renderErrors:function(){if(this.errors.length>0){t.isUndefined(this.$errors)&&(this.$errors=e("<div>",{"class":this.baseCSS("errors"),html:"<p>You have the following errors: </p><ul></ul>"}),this.$outer.prepend(this.$errors));var n=this.$errors.find("ul");t.each(this.errors,t.bind(function(t){n.append(e("<li>",{"class":this.baseCSS("error-msg"),html:t.text}))},this)),this.$errors.show()}},removeErrors:function(){this.errors.length>0&&(this.$errors.find("ul").html(""),this.$errors.hide(),this.errors=[])},_getBlockTypeLimit:function(e){return this._blockTypeAvailable(e)?t.isUndefined(this.options.blockTypeLimits[e])?r.Blocks[e].prototype.limit:this.options.blockTypeLimits[e]:0},_blockTypeAvailable:function(e){return!t.isUndefined(this.blockTypes[e])},_formatterAvailable:function(e){return!t.isUndefined(this.formatters[e])},_ensureAndSetElements:function(){if(t.isUndefined(this.options.el)||t.isEmpty(this.options.el))return r.log("You must provide an el"),!1;this.$el=this.options.el,this.el=this.options.el[0],this.$form=this.$el.parents("form");var n=e("<div>").attr({id:this.ID,"class":"st-outer",dropzone:"copy link move"}),i=e("<div>").attr({"class":"st-blocks"});return this.$el.wrap(n).wrap(i),this.$outer=n,this.$wrapper=i,!0},_setBlocksAndFormatters:function(){this.blockTypes=c(t.isUndefined(this.options.blockTypes)?r.Blocks:this.options.blockTypes),this.formatters=c(t.isUndefined(this.options.formatters)?r.Formatters:this.options.formatters)},_setRequired:function(){this.required=t.isArray(this.options.required)&&!t.isEmpty(this.options.required)?this.options.required:!1},_toMarkdown:function(e,n){var i;i=e.replace(/\n/mg,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/g,"[$2]($1)").replace(/<\/?b>/g,"**").replace(/<\/?STRONG>/g,"**").replace(/<\/?i>/g,"_").replace(/<\/?EM>/g,"_");var s,o;for(s in this.formatters)r.Formatters.hasOwnProperty(s)&&(o=r.Formatters[s],!t.isUndefined(o.toMarkdown)&&t.isFunction(o.toMarkdown)&&(i=o.toMarkdown(i)));i=i.replace(/([^<>]+)(<div>)/g,"$1\n\n$2").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n\n").replace(/<\/p>/g,"\n\n\n\n").replace(/<(.)?br(.)?>/g,"\n\n").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">");var u;return r.Blocks.hasOwnProperty(n)&&(u=r.Blocks[n],!t.isUndefined(u.prototype.toMarkdown)&&t.isFunction(u.prototype.toMarkdown)&&(i=u.prototype.toMarkdown(i))),i=i.replace(/<\/?[^>]+(>|$)/g,""),i},_toHTML:function(e,n){var i=e,s,o;for(s in this.formatters)r.Formatters.hasOwnProperty(s)&&(o=r.Formatters[s],!t.isUndefined(o.toHTML)&&t.isFunction(o.toHTML)&&(i=o.toHTML(i)));var u;return r.Blocks.hasOwnProperty(n)&&(u=r.Blocks[n],!t.isUndefined(u.prototype.toHTML)&&t.isFunction(u.prototype.toHTML)&&(i=u.prototype.toHTML(i))),i=i.replace(/^\> (.+)$/mg,"$1").replace(/\n\n/g,"<br>").replace(/\[([^\]]+)\]\(([^\)]+)\)/g,"<a href='$2'>$1</a>").replace(/(?:_)([^*|_(http)]+)(?:_)/g,"<i>$1</i>").replace(/(?:\*\*)([^*|_]+)(?:\*\*)/g,"<b>$1</b>"),i},baseCSS:function(e){return this.options.baseCSSClass+"-"+e}}),r.bindFormSubmit=function(e){a||(r.submittable(),e.bind("submit",this.onFormSubmit),a=!0)},r.onBeforeSubmit=function(e){var n=0;return t.each(r.instances,function(t,r){n+=t.onFormSubmit(e)}),r.log("Total errors: "+n),n},r.onFormSubmit=function(e){var t=r.onBeforeSubmit();t>0&&(r.publish("onError"),e.preventDefault())},r.runOnAllInstances=function(e){t.has(r.Editor.prototype,e)?([].unshift.call(arguments,r.instances),t.invoke.apply(t,arguments)):r.log("method doesn't exist")}})(jQuery,_);