(function($,_){function flattern(obj){var x={};return _.each(obj,function(a,b){x[_.isArray(obj)?a:b]=!0}),x}function halt(ev){ev.preventDefault(),ev.stopPropagation()}var SirTrevor,root=this,array=[];array.push;var slice=array.slice;array.splice,SirTrevor=root.SirTrevor={},SirTrevor.DEBUG=!1,SirTrevor.SKIP_VALIDATION=!1,SirTrevor.DEFAULTS={baseCSSClass:"sir-trevor",errorClass:"error",defaultType:"Text",spinner:{className:"spinner",lines:9,length:8,width:3,radius:6,color:"#000",speed:1.4,trail:57,shadow:!1,left:"50%",top:"50%"},marker:{baseCSSClass:"marker",buttonClass:"button",addText:"Click to add:",dropText:"Drop to place content"},formatBar:{baseCSSClass:"formatting-control"},blockLimit:0,blockTypeLimits:{},required:[],uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/"},SirTrevor.Blocks={},SirTrevor.Formatters={},SirTrevor.instances=[];var formBound=!1,FunctionBind={bound:[],_bindFunctions:function(){var args=[];args.push(this),args.join(this.bound),_.bindAll.apply(this,args)}},Renderable={tagName:"div",className:"sir-trevor__view",attributes:{},$:function(selector){return this.$el.find(selector)},render:function(){return this},_ensureElement:function(){if(this.el)this._setElement(this.el);else{var attrs=_.extend({},_.result(this,"attributes"));this.id&&(attrs.id=this.id),this.className&&(attrs["class"]=this.className);var $el=$("<"+this.tagName+">").attr(attrs);this._setElement($el)}},_setElement:function(element){return this.$el=element instanceof jQuery?element:$(element),this.el=this.$el[0],this}};(function($){function dragEnter(e){halt(e)}function dragOver(e){e.originalEvent.dataTransfer.dropEffect="copy",halt(e)}function dragLeave(e){halt(e)}$.fn.dropArea=function(){return this.bind("dragenter",dragEnter).bind("dragover",dragOver).bind("dragleave",dragLeave),this},$.fn.noDropArea=function(){return this.unbind("dragenter").unbind("dragover").unbind("dragleave"),this}})(jQuery);var extend=function(protoProps,staticProps){var child,parent=this;child=protoProps&&_.has(protoProps,"constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&_.extend(child.prototype,protoProps),child.__super__=parent.prototype,child};SirTrevor.log=function(message){!_.isUndefined(console)&&SirTrevor.DEBUG&&console.log(message)};var eventSplitter=/\s+/,eventsApi=function(obj,action,name,rest){if(!name)return!0;if("object"==typeof name){for(var key in name)obj[action].apply(obj,[key,name[key]].concat(rest));return!1}if(eventSplitter.test(name)){for(var names=name.split(eventSplitter),i=0,l=names.length;l>i;i++)obj[action].apply(obj,[names[i]].concat(rest));return!1}return!0},triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:for(;l>++i;)(ev=events[i]).callback.call(ev.ctx);return;case 1:for(;l>++i;)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:for(;l>++i;)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:for(;l>++i;)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:for(;l>++i;)(ev=events[i]).callback.apply(ev.ctx,args)}},Events=SirTrevor.Events={on:function(name,callback,context){if(!eventsApi(this,"on",name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);return events.push({callback:callback,context:context,ctx:context||this}),this},once:function(name,callback,context){if(!eventsApi(this,"once",name,[callback,context])||!callback)return this;var self=this,once=_.once(function(){self.off(name,once),callback.apply(this,arguments)});return once._callback=callback,this.on(name,once,context)},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,"off",name,[callback,context]))return this;if(!name&&!callback&&!context)return this._events={},this;for(names=name?[name]:_.keys(this._events),i=0,l=names.length;l>i;i++)if(name=names[i],events=this._events[name]){if(this._events[name]=retain=[],callback||context)for(j=0,k=events.length;k>j;j++)ev=events[j],(callback&&callback!==ev.callback&&callback!==ev.callback._callback||context&&context!==ev.context)&&retain.push(ev);retain.length||delete this._events[name]}return this},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,"trigger",name,args))return this;var events=this._events[name],allEvents=this._events.all;return events&&triggerEvents(events,args),allEvents&&triggerEvents(allEvents,arguments),this},stopListening:function(obj,name,callback){var listeners=this._listeners;if(!listeners)return this;var deleteListener=!name&&!callback;"object"==typeof name&&(callback=this),obj&&((listeners={})[obj._listenerId]=obj);for(var id in listeners)listeners[id].off(name,callback,this),deleteListener&&delete this._listeners[id];return this}},listenMethods={listenTo:"on",listenToOnce:"once"};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeners=this._listeners||(this._listeners={}),id=obj._listenerId||(obj._listenerId=_.uniqueId("l"));return listeners[id]=obj,"object"==typeof name&&(callback=this),obj[implementation](name,callback,this),this}}),Events.bind=Events.on,Events.unbind=Events.off;var o=$(SirTrevor);SirTrevor.subscribe=SirTrevor.on=function(){o.on.apply(o,arguments)},SirTrevor.unsubscribe=SirTrevor.off=function(){o.off.apply(o,arguments)},SirTrevor.publish=SirTrevor.trigger=function(){o.trigger.apply(o,arguments)},SirTrevor.subscribeAll=function(subscriptions){_.each(subscriptions,function(){o.on.apply(o,arguments)})},function(a,b,c){function g(a,c){var e,d=b.createElement(a||"div");for(e in c)d[e]=c[e];return d}function h(a){for(var b=1,c=arguments.length;c>b;b++)a.appendChild(arguments[b]);return a}function j(a,b,c,d){var g=["opacity",b,~~(100*a),c,d].join("-"),h=.01+100*(c/d),j=Math.max(1-(1-a)/b*(100-h),a),k=f.substring(0,f.indexOf("Animation")).toLowerCase(),l=k&&"-"+k+"-"||"";return e[g]||(i.insertRule("@"+l+"keyframes "+g+"{"+"0%{opacity:"+j+"}"+h+"%{opacity:"+a+"}"+(h+.01)+"%{opacity:1}"+(h+b)%100+"%{opacity:"+a+"}"+"100%{opacity:"+j+"}"+"}",0),e[g]=1),g}function k(a,b){var f,g,e=a.style;if(e[b]!==c)return b;for(b=b.charAt(0).toUpperCase()+b.slice(1),g=0;d.length>g;g++)if(f=d[g]+b,e[f]!==c)return f}function l(a,b){for(var c in b)a.style[k(a,c)||c]=b[c];return a}function m(a){for(var b=1;arguments.length>b;b++){var d=arguments[b];for(var e in d)a[e]===c&&(a[e]=d[e])}return a}function n(a){for(var b={x:a.offsetLeft,y:a.offsetTop};a=a.offsetParent;)b.x+=a.offsetLeft,b.y+=a.offsetTop;return b}var f,d=["webkit","Moz","ms","O"],e={},i=function(){var a=g("style");return h(b.getElementsByTagName("head")[0],a),a.sheet||a.styleSheet}(),o={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto"},p=function q(a){return this.spin?(this.opts=m(a||{},q.defaults,o),void 0):new q(a)};p.defaults={},m(p.prototype,{spin:function(a){this.stop();var h,i,b=this,c=b.opts,d=b.el=l(g(0,{className:c.className}),{position:"relative",zIndex:c.zIndex}),e=c.radius+c.length+c.width;if(a&&(a.insertBefore(d,a.firstChild||null),i=n(a),h=n(d),l(d,{left:("auto"==c.left?i.x-h.x+(a.offsetWidth>>1):c.left+e)+"px",top:("auto"==c.top?i.y-h.y+(a.offsetHeight>>1):c.top+e)+"px"})),d.setAttribute("aria-role","progressbar"),b.lines(d,b.opts),!f){var j=0,k=c.fps,m=k/c.speed,o=(1-c.opacity)/(m*c.trail/100),p=m/c.lines;!function q(){j++;for(var a=c.lines;a;a--){var e=Math.max(1-(j+a*p)%m*o,c.opacity);b.opacity(d,c.lines-a,e,c)}b.timeout=b.el&&setTimeout(q,~~(1e3/k))}()}return b},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=c),this},lines:function(a,b){function e(a,d){return l(g(),{position:"absolute",width:b.length+b.width+"px",height:b.width+"px",background:a,boxShadow:d,transformOrigin:"left",transform:"rotate("+~~(360/b.lines*c+b.rotate)+"deg) translate("+b.radius+"px"+",0)",borderRadius:(b.width>>1)+"px"})}for(var d,c=0;b.lines>c;c++)d=l(g(),{position:"absolute",top:1+~(b.width/2)+"px",transform:b.hwaccel?"translate3d(0,0,0)":"",opacity:b.opacity,animation:f&&j(b.opacity,b.trail,c,b.lines)+" "+1/b.speed+"s linear infinite"}),b.shadow&&h(d,l(e("#000","0 0 4px #000"),{top:"2px"})),h(a,h(d,e(b.color,"0 0 1px rgba(0,0,0,.1)")));return a},opacity:function(a,b,c){a.childNodes.length>b&&(a.childNodes[b].style.opacity=c)}}),!function(){function a(a,b){return g("<"+a+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',b)}var b=l(g("group"),{behavior:"url(#default#VML)"});!k(b,"transform")&&b.adj?(i.addRule(".spin-vml","behavior:url(#default#VML)"),p.prototype.lines=function(b,c){function f(){return l(a("group",{coordsize:e+" "+e,coordorigin:-d+" "+-d}),{width:e,height:e})}function k(b,e,g){h(i,h(l(f(),{rotation:360/c.lines*b+"deg",left:~~e}),h(l(a("roundrect",{arcsize:1}),{width:d,height:c.width,left:c.radius,top:-c.width>>1,filter:g}),a("fill",{color:c.color,opacity:c.opacity}),a("stroke",{opacity:0}))))}var j,d=c.length+c.width,e=2*d,g=2*-(c.width+c.length)+"px",i=l(f(),{position:"absolute",top:g,left:g});if(c.shadow)for(j=1;c.lines>=j;j++)k(j,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(j=1;c.lines>=j;j++)k(j);return h(b,i)},p.prototype.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&e.childNodes.length>b+d&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}):f=k(b,"animation")}(),a.Spinner=p}(window,document),function($){$.fn.limit_chars=function(){0!==this.length&&(this.attr("maxlength")&&(this.attr("data-maxlength",this.attr("maxlength")),this.removeAttr("maxlength")),0===this.parents(".extended_input").length&&(count=this.chars()<this.attr("data-maxlength")?this.chars():"<em>"+this.chars()+"</em>",this.wrap($("<div>",{"class":"extended_input"})).after($("<span>",{"class":"count",html:count+" of "+this.attr("data-maxlength")})),this.bind("keydown keyup paste",function(){count=$(this).chars()<$(this).attr("data-maxlength")?$(this).chars():"<em>"+$(this).chars()+"</em>",$(this).parent().find(".count").html(count+" of "+$(this).attr("data-maxlength"))})))},$.fn.chars=function(){return count=void 0!==this.attr("contenteditable")?this.text().length:this.val().length},$.fn.too_long=function(){return this.chars()>this.attr("data-maxlength")}}(jQuery),SirTrevor.blockStore=function(method,block,options){var resp;switch(options=options||{},method){case"create":var data=options.data||{};block.dataStore={type:block.type.toLowerCase(),data:data};break;case"save":options.data&&(block.dataStore.data=options.data,resp=block.dataStore);break;case"read":resp=block.dataStore}return resp?resp:void 0},SirTrevor.editorStore=function(method,editor,options){var resp;switch(options=options||{},method){case"create":var content=_.trim(editor.$el.val());if(editor.dataStore={data:[]},content.length>0)try{var str=JSON.parse(content);_.isUndefined(str.data)||(editor.dataStore=str)}catch(e){console.log("Sorry there has been a problem with parsing the JSON"),console.log(e)}break;case"reset":editor.dataStore={data:[]};break;case"add":options.data&&(editor.dataStore.data.push(options.data),resp=editor.dataStore);break;case"save":editor.$el.val(editor.dataStore.data.length>0?JSON.stringify(editor.dataStore):"");break;case"read":resp=editor.dataStore}return resp?resp:void 0};var Submittable=function(){this.intialize()};_.extend(Submittable.prototype,{intialize:function(){this.submitBtn=$("input[type='submit']");var btnTitles=[];_.each(this.submitBtn,function(btn){btnTitles.push($(btn).attr("value"))}),this.submitBtnTitles=btnTitles,this.canSubmit=!0,this.globalUploadCount=0,this._bindEvents()},setSubmitButton:function(e,message){this.submitBtn.attr("value",message)},resetSubmitButton:function(){_.each(this.submitBtn,_.bind(function(item,index){$(item).attr("value",this.submitBtnTitles[index])},this))},onUploadStart:function(){this.globalUploadCount++,SirTrevor.log("onUploadStart called "+this.globalUploadCount),1===this.globalUploadCount&&this._disableSubmitButton()},onUploadStop:function(){this.globalUploadCount=0>=this.globalUploadCount?0:this.globalUploadCount-1,SirTrevor.log("onUploadStop called "+this.globalUploadCount),0===this.globalUploadCount&&this._enableSubmitButton()},onError:function(){SirTrevor.log("onError called"),this.canSubmit=!1},_disableSubmitButton:function(message){this.setSubmitButton(null,message||"Please wait..."),this.submitBtn.attr("disabled","disabled").addClass("disabled")},_enableSubmitButton:function(){this.resetSubmitButton(),this.submitBtn.removeAttr("disabled").removeClass("disabled")},_bindEvents:function(){SirTrevor.subscribe("disableSubmitButton",_.bind(this._disableSubmitButton,this)),SirTrevor.subscribe("enableSubmitButton",_.bind(this._enableSubmitButton,this)),SirTrevor.subscribe("setSubmitButton",_.bind(this.setSubmitButton,this)),SirTrevor.subscribe("resetSubmitButton",_.bind(this.resetSubmitButton,this)),SirTrevor.subscribe("onError",_.bind(this.onError,this)),SirTrevor.subscribe("onUploadStart",_.bind(this.onUploadStart,this)),SirTrevor.subscribe("onUploadStop",_.bind(this.onUploadStop,this))}}),SirTrevor.submittable=function(){new Submittable},SirTrevor.fileUploader=function(block,file,success,error){SirTrevor.publish("onUploadStart");var uid=[block.instance.ID,(new Date).getTime(),"raw"].join("-"),data=new FormData;data.append("attachment[name]",file.name),data.append("attachment[file]",file),data.append("attachment[uid]",uid);var callbackSuccess=function(data){!_.isUndefined(success)&&_.isFunction(success)&&(SirTrevor.log("Upload callback called"),SirTrevor.publish("onUploadStop"),_.bind(success,block)(data))},callbackError=function(jqXHR,status){!_.isUndefined(error)&&_.isFunction(error)&&(SirTrevor.log("Upload callback error called"),SirTrevor.publish("onUploadError"),_.bind(error,block)(status))};$.ajax({url:block.instance.options.uploadUrl,data:data,cache:!1,contentType:!1,processData:!1,type:"POST",success:callbackSuccess,error:callbackError})};var url_regex=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;_.mixin({isURI:function(string){return url_regex.test(string)},capitalize:function(string){return string.charAt(0).toUpperCase()+string.substring(1).toLowerCase()},trim:function(string){return string.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}});var Block=SirTrevor.Block=function(instance,data){this.instance=instance,this.type=this._getBlockType(),this.store("create",this,{data:data}),this.uploadsCount=0,this.blockID=_.uniqueId(this.className+"-"),this._setBaseElements(),this._bindFunctions(),this.initialize.apply(this,arguments)};_.extend(Block.prototype,FunctionBind,{bound:["_handleDrop","_handleContentPaste","onBlockFocus","onBlockBlur","onDrop","onDragStart","onDragEnd"],$:function(selector){return this.$el.find(selector)},$$:function(selector){return this.$editor.find(selector)},className:"",title:"",limit:0,editorHTML:"<div></div>",dropzoneHTML:'<div class="dropzone"><p>Drop content here</p></div>',toolbarEnabled:!0,dropEnabled:!1,formattingEnabled:!0,initialize:function(){},loadData:function(){},onBlockRender:function(){},beforeBlockRender:function(){},setTextLimit:function(){},toMarkdown:function(markdown){return markdown},toHTML:function(html){return html},store:function(){return SirTrevor.blockStore.apply(this,arguments)},render:function(){this.beforeBlockRender(),this.dropEnabled&&this._initDragDrop();var currentData=this.getData();if(_.isUndefined(currentData)||_.isEmpty(currentData)||this._loadData(),this.save(),this.$el.append($("<span>",{"class":"st-block__reorder",draggable:!0})),this.$el.append($("<span>",{"class":"st-block__remove"})),this.$el.bind("drop",halt).bind("mouseover",halt).bind("mouseout",halt).bind("dragleave",halt).bind("mouseover",function(){$(this).siblings().removeClass("active"),$(this).addClass("active")}).bind("mouseout",function(){$(this).removeClass("active")}).bind("dragover",function(ev){ev.preventDefault()}),this._initPaste(),this.$(".st-block__remove").bind("click",this.onDeleteClick),this.$$(".text-block").length>0)return document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBrOnReturn",!1,!0),this.$$(".text-block").bind("paste",this._handleContentPaste).bind("focus",this.onBlockFocus).bind("blur",this.onBlockBlur),this._initFormatting(),this;if(_.isEmpty(currentData.data)&&this.instance.blocks.length>0){var inputs=this.$$('[contenteditable="true"], input');inputs.length>0&&!this.dropEnabled&&inputs[0].focus()}this._initReordering(),this.$el.addClass("st-item-ready"),this.setTextLimit(),this.onBlockRender()},remove:function(){this.$el.remove()},save:function(){return this.toData(),this.store("read",this)},getData:function(){return this.store("read",this).data},setData:function(data){SirTrevor.log("Setting data for block "+this.blockID),this.store("save",this,{data:data})},loading:function(){_.isUndefined(this.spinner)||this.ready(),this.$el.addClass("loading")},ready:function(){this.$el.removeClass("loading"),_.isUndefined(this.spinner)||(this.spinner.stop(),delete this.spinner)},validate:function(){this._beforeValidate();var fields=this.$$(".required, [data-maxlength]"),errors=0;return _.each(fields,_.bind(function(field){field=$(field);var content=field.attr("contenteditable")?field.text():field.val(),too_long=field.attr("data-maxlength")&&field.too_long(),required=field.hasClass("required");(required&&0===content.length||too_long)&&(field.addClass("st-error"),errors++)},this)),errors>0&&this.$el.addClass("st-block--with-errors"),0===errors},toData:function(){SirTrevor.log("toData for "+this.blockID);var dataObj=(this.$el,{});if(this.$$(".text-block").length>0){var content=this.$$(".text-block").html();content.length>0&&(dataObj.text=this.instance._toMarkdown(content,this.type))}var hasTextAndData=!_.isUndefined(dataObj.text)||0===this.$$(".text-block").length;this.$$('input[type="text"]').not(".paste-block").length>0&&this.$$('input[type="text"]').each(function(index,input){input=$(input),input.val().length>0&&hasTextAndData&&(dataObj[input.attr("name")]=input.val())}),this.$$("select").each(function(index,input){input=$(input),input.val().length>0&&hasTextAndData&&(dataObj[input.attr("name")]=input.val())}),this.$$('input[type="file"]').each(function(index,input){input=$(input),dataObj.file=input.data("json")}),_.isEmpty(dataObj)||this.setData(dataObj)},onDrop:function(){},onDragStart:function(ev){var item=$(ev.target);ev.originalEvent.dataTransfer.setDragImage(item.parent()[0],13,25),ev.originalEvent.dataTransfer.setData("Text",item.parent().attr("id")),item.parent().addClass("dragging")},onDragEnd:function(ev){var item=$(ev.target);item.parent().removeClass("dragging")},onDeleteClick:function(ev){confirm("Are you sure you wish to delete this content?")&&halt(ev)},onContentPasted:function(){var textBlock=this.$$(".text-block");textBlock.length>0},onBlockFocus:function(){this.$el.addClass("focussed")},onBlockBlur:function(){this.$el.removeClass("focussed")},uploader:function(file,callback){SirTrevor.fileUploader(this,file,callback)},_loadData:function(){SirTrevor.log("loadData for "+this.blockID),this.loading(),this.dropEnabled&&(this.$dropzone.hide(),this.$editor.show()),SirTrevor.publish("editor/block/loadData"),this.loadData(this.getData()),this.ready()},_beforeValidate:function(){this.errors=[];var errorClass="st-error";this.$el.removeClass("st-block--with-errors"),this.$("."+errorClass).removeClass(errorClass),this.$(".error-marker").remove()},_handleContentPaste:function(ev){var timed=function(ev){this.onContentPasted(ev)};_.delay(_.bind(timed,this,ev),100)},_handleDrop:function(e){e.preventDefault(),e=e.originalEvent,SirTrevor.publish("editor/block/handleDrop");var types=($(e.target),e.dataTransfer.types);this.$dropzone.removeClass("drag-enter"),_.isUndefined(types)||(_.include(types,"Files")||_.include(types,"text/plain")||_.include(types,"text/uri-list"))&&this.onDrop(e.dataTransfer)},_setBaseElements:function(){var el=_.isFunction(this.editorHTML)?this.editorHTML():this.editorHTML,editor=$("<div>",{"class":"st-block__inner "+this._getBlockClass(),html:el});this.$el=$("<div>",{"class":"st-block",id:this.blockID,"data-type":this.type,"data-instance":this.instance.ID,html:editor}),this.el=this.$el[0],this.$editor=editor},_getBlockType:function(){var objName="";for(var block in SirTrevor.Blocks)SirTrevor.Blocks[block].prototype==Object.getPrototypeOf(this)&&(objName=block);return objName},_getBlockClass:function(){return"st-block--"+this.className},_initDragDrop:function(){SirTrevor.log("Adding drag and drop capabilities for block "+this.blockID),this.$dropzone=$("<div>",{html:this.dropzoneHTML,"class":"dropzone "+this._getBlockClass()}),this.$el.append(this.$dropzone),this.$editor.hide(),this.$dropzone.bind("drop",this._handleDrop).bind("dragenter",function(e){halt(e),$(this).addClass("drag-enter")}).bind("dragover",function(e){e.originalEvent.dataTransfer.dropEffect="copy",halt(e),$(this).addClass("drag-enter")}).bind("dragleave",function(e){halt(e),$(this).removeClass("drag-enter")})},_initReordering:function(){this.$(".st-block__reorder").bind("dragstart",this.onDragStart).bind("dragend",this.onDragEnd)},_initFormatting:function(){},_initPaste:function(){this.$(".paste-block").bind("click",function(){$(this).select()}).bind("paste",this._handleContentPaste).bind("submit",this._handleContentPaste)},_initTextLimits:function(){this.$$("input[maxlength!=-1][maxlength!=524288][maxlength!=2147483647]").limit_chars()}}),Block.extend=extend;var Format=SirTrevor.Formatter=function(options){this.formatId=_.uniqueId("format-"),this._configure(options||{}),this.initialize.apply(this,arguments)},formatOptions=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];_.extend(Format.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(markdown){return markdown},toHTML:function(html){return html},initialize:function(){},_configure:function(options){this.options&&(options=_.extend({},this.options,options));for(var i=0,l=formatOptions.length;l>i;i++){var attr=formatOptions[i];options[attr]&&(this[attr]=options[attr])}this.options=options},_bindToBlock:function(block){var formatter=this,ctrlDown=!1;block.on("keyup",".text-block",function(ev){(17==ev.which||224==ev.which)&&(ctrlDown=!1)}).on("keydown",".text-block",{formatter:formatter},function(ev){(17==ev.which||224==ev.which)&&(ctrlDown=!0),ev.which==ev.data.formatter.keyCode&&ctrlDown===!0&&(document.execCommand(ev.data.formatter.cmd,!1,!0),ev.preventDefault())})}}),Format.extend=extend,SirTrevor.Blocks.Quote=SirTrevor.Block.extend({title:"Quote",className:"quote",limit:0,editorHTML:function(){return _.template('<blockquote class="required text-block <%= className %>" contenteditable="true"></blockquote><div class="input text"><label>Credit</label><input maxlength="140" name="cite" class="input-string required" type="text" /></div>',this)},loadData:function(data){this.$$(".text-block").html(this.instance._toHTML(data.text,this.type)),this.$$("input").val(data.cite)},toMarkdown:function(markdown){return markdown.replace(/^(.+)$/gm,"> $1")}});var dropzone_templ='<p>Drop images here</p><div class="input submit"><input type="file" multiple="multiple" /></div><button>...or choose file(s)</button>';SirTrevor.Blocks.Gallery=SirTrevor.Block.extend({title:"Gallery",className:"gallery",dropEnabled:!0,editorHTML:'<div class="gallery-items"><p>Gallery Contents:</p><ul></ul></div>',dropzoneHTML:dropzone_templ,loadData:function(data){_.isArray(data)&&(_.each(data,_.bind(function(item){this.renderGalleryThumb(item)},this)),this.$dropzone.show())},renderGalleryThumb:function(item){if(_.isUndefined(item.data.file))return!1;var img=$("<img>",{src:item.data.file.thumb.url}),list=$("<li>",{id:_.uniqueId("gallery-item"),"class":"gallery-item",html:img});list.append($("<span>",{"class":"delete",click:_.bind(function(e){halt(e),confirm("Are you sure you wish to delete this image?")&&($(e.target).parent().remove(),this.reindexData())},this)})),list.data("block",item),this.$$("ul").append(list),list.dropArea().bind("dragstart",_.bind(function(ev){var item=$(ev.target);ev.originalEvent.dataTransfer.setData("Text",item.parent().attr("id")),item.parent().addClass("dragging")},this)).bind("drag",_.bind(function(){},this)).bind("dragend",_.bind(function(ev){var item=$(ev.target);item.parent().removeClass("dragging")},this)).bind("dragover",_.bind(function(ev){var item=$(ev.target);item.parents("li").addClass("dragover")},this)).bind("dragleave",_.bind(function(ev){var item=$(ev.target);item.parents("li").removeClass("dragover")},this)).bind("drop",_.bind(function(ev){var item=$(ev.target),parent=item.parent();item=item.hasClass("gallery-item")?item:parent,this.$$("ul li.dragover").removeClass("dragover");var target=$("#"+ev.originalEvent.dataTransfer.getData("text/plain"));return target.attr("id")===item.attr("id")?!1:(target.length>0&&target.hasClass("gallery-item")&&item.before(target),this.reindexData(),void 0)},this))},onBlockRender:function(){this.$dropzone.find("button").bind("click",halt),this.$dropzone.find("input").on("change",_.bind(function(ev){this.onDrop(ev.currentTarget)},this))},reindexData:function(){var dataStruct=this.getData();dataStruct=[],_.each(this.$$("li.gallery-item"),function(li){li=$(li),dataStruct.push(li.data("block"))}),this.setData(dataStruct)},onDrop:function(transferData){if(transferData.files.length>0){var file,l=transferData.files.length;for(this.loading();l--;)file=transferData.files[l],/image/.test(file.type)&&(this.uploadsCount+=1,this.$editor.show(),this.uploader(file,function(data){this.uploadsCount-=1;var dataStruct=this.getData();data={type:"image",data:data},_.isArray(dataStruct)||(dataStruct=[]),dataStruct.push(data),this.setData(dataStruct),this.renderGalleryThumb(data),0===this.uploadsCount&&this.ready()}))}}});var dropzone_templ='<p>Drop image here</p><div class="input submit"><input type="file" /></div><button>...or choose a file</button>';SirTrevor.Blocks.Image=SirTrevor.Block.extend({title:"Image",className:"image",dropEnabled:!0,dropzoneHTML:dropzone_templ,loadData:function(data){this.$editor.html($("<img>",{src:data.file.url}))},onBlockRender:function(){this.$dropzone.find("button").bind("click",halt),this.$dropzone.find("input").on("change",_.bind(function(ev){this.onDrop(ev.currentTarget)},this))},onDrop:function(transferData){var file=transferData.files[0],urlAPI="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;/image/.test(file.type)&&(this.loading(),this.$dropzone.hide(),this.$editor.html($("<img>",{src:urlAPI.createObjectURL(file)})),this.$editor.show(),SirTrevor.publish("setSubmitButton",["Please wait..."]),this.uploader(file,function(data){this.setData(data),this.ready()},function(){alert("Error!")}))}}),SirTrevor.Blocks.Text=SirTrevor.Block.extend({title:"Text",className:"text",limit:0,editorHTML:'<div class="required text-block" contenteditable="true"></div>',loadData:function(data){this.$$(".text-block").html(this.instance._toHTML(data.text,this.type))}});var t_template='<p>Drop tweet link here</p><div class="input text"><label>or paste URL:</label><input type="text" class="paste-block"></div>',tweet_template='<div class="tweet"><img src="<%= user.profile_image_url %>" class="tweet-avatar"><div class="tweet-body"><p class="tweet-user"><a href="http://twitter.com/#!/<%= user.screen_name %>" class="tweet-user">@<%= user.screen_name %></a> on Twitter</p><p class="tweet-text"><%= text %></p><time><%= created_at %></time></div></div>';SirTrevor.Blocks.Tweet=SirTrevor.Block.extend({title:"Tweet",className:"tweet",dropEnabled:!0,dropzoneHTML:t_template,loadData:function(data){this.$editor.html(_.template(tweet_template,data))},onContentPasted:function(event){var input=$(event.target),val=input.val();this.handleTwitterDropPaste(val)},handleTwitterDropPaste:function(url){if(_.isURI(url)&&-1!=url.indexOf("twitter")&&-1!=url.indexOf("status")){var tweetID=url.match(/[^\/]+$/);if(!_.isEmpty(tweetID)){this.loading(),tweetID=tweetID[0];var tweetCallbackSuccess=function(data){var obj={user:{profile_image_url:data.user.profile_image_url,profile_image_url_https:data.user.profile_image_url_https,screen_name:data.user.screen_name,name:data.user.name},text:data.text,created_at:data.created_at,status_url:url};this.setData(obj),this._loadData(),this.ready()},tweetCallbackFail=function(){this.ready()};$.ajax({url:"http://api.twitter.com/1/statuses/show/"+tweetID+".json",dataType:"JSONP",success:_.bind(tweetCallbackSuccess,this),error:_.bind(tweetCallbackFail,this)})}}},onDrop:function(transferData){var url=transferData.getData("text/plain");this.handleTwitterDropPaste(url)}});var template='<div class="text-block <%= className %>" contenteditable="true"></div>';SirTrevor.Blocks.Ul=SirTrevor.Block.extend({title:"List",className:"list",editorHTML:function(){return _.template(template,this)},onBlockRender:function(){this.$$(".text-block").bind("click",function(){0===$(this).html().length&&document.execCommand("insertUnorderedList",!1,!1)}),_.isEmpty(this.data)&&this.$$(".text-block").focus().click()},loadData:function(data){this.$$(".text-block").html("<ul>"+this.instance._toHTML(data.text,this.type)+"</ul>")},toMarkdown:function(markdown){return markdown.replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1")},toHTML:function(html){return html=html.replace(/^ - (.+)$/gm,"<li>$1</li>").replace(/\n/gm,""),html="<ul>"+html+"</ul>"}});var video_drop_template='<p>Drop video link here</p><div class="input text"><label>or paste URL:</label><input type="text" class="paste-block"></div>',video_regex=/http[s]?:\/\/(?:www.)?(?:(vimeo).com\/(.*))|(?:(youtu(?:be)?).(?:be|com)\/(?:watch\?v=)?([^&]*)(?:&(?:.))?)/;SirTrevor.Blocks.Video=SirTrevor.Block.extend({title:"Video",className:"video",dropEnabled:!0,dropzoneHTML:video_drop_template,loadData:function(data){"youtube"==data.source||"youtu"==data.source?this.$editor.html('<iframe src="'+window.location.protocol+"//www.youtube.com/embed/"+data.remote_id+'" width="580" height="320" frameborder="0" allowfullscreen></iframe>'):"vimeo"==data.source&&this.$editor.html('<iframe src="'+window.location.protocol+"//player.vimeo.com/video/"+data.remote_id+'?title=0&byline=0" width="580" height="320" frameborder="0"></iframe>')},onContentPasted:function(event){var input=$(event.target),val=input.val();this.handleDropPaste(val)},handleDropPaste:function(url){if(_.isURI(url)&&(-1!=url.indexOf("youtu")||-1!=url.indexOf("vimeo"))){var data={},videos=url.match(video_regex);void 0!==videos[3]?(data.source=videos[3],data.remote_id=videos[4]):void 0!==videos[1]&&(data.source=videos[1],data.remote_id=videos[2]),"youtu"==data.source&&(data.source="youtube"),this.setData(data),this._loadData()}},onDrop:function(transferData){var url=transferData.getData("text/plain");this.handleDropPaste(url)}});var Bold=SirTrevor.Formatter.extend({title:"B",className:"bold",cmd:"bold",keyCode:66}),Italic=SirTrevor.Formatter.extend({title:"I",className:"italic",cmd:"italic",keyCode:73});SirTrevor.Formatter.extend({title:"U",className:"underline",cmd:"underline"});var Link=SirTrevor.Formatter.extend({title:"Link",className:"link",cmd:"CreateLink",onClick:function(){var link=prompt("Enter a link"),link_regex=/(ftp|http|https):\/\/./;link&&link.length>0&&(link_regex.test(link)||(link="http://"+link),document.execCommand(this.cmd,!1,link))}}),UnLink=SirTrevor.Formatter.extend({title:"Unlink",className:"link",cmd:"unlink"});SirTrevor.Formatters.Bold=new Bold,SirTrevor.Formatters.Italic=new Italic,SirTrevor.Formatters.Link=new Link,SirTrevor.Formatters.Unlink=new UnLink;
var BlockControl=SirTrevor.BlockControl=function(type,instance_scope){this.type=type,this.instance_scope=instance_scope,this._ensureElement(),this.initialize()};_.extend(BlockControl.prototype,FunctionBind,Renderable,Events,{tagName:"a",className:"st-block-control",attributes:function(){return{"data-type":this.type}},initialize:function(){this.block_type=SirTrevor.Blocks[this.type].prototype,this.can_be_rendered=this.block_type.toolbarEnabled},render:function(){return this.$el.text(this.block_type.title),this}});var BlockControls=SirTrevor.BlockControls=function(available_types,instance_scope){this.instance_scope=instance_scope,this.available_types=available_types||[],this._ensureElement(),this.initialize()};_.extend(BlockControls.prototype,FunctionBind,Renderable,Events,{className:"st-block-controls",initialize:function(){for(block_type in this.available_types)if(SirTrevor.Blocks.hasOwnProperty(block_type)){var block_control=new SirTrevor.BlockControl(block_type,this.instance_scope);block_control.can_be_rendered&&this.$el.append(block_control.render().$el)}this.$el.delegate("a","click",_.bind(this.handleButtonClick,this))},handleButtonClick:function(e){e.preventDefault(),this.trigger("createBlock",e.target.dataset.type)}});var FormatBar=SirTrevor.FormatBar=function(options,editorInstance){this.instance=editorInstance,this.options=_.extend({},SirTrevor.DEFAULTS.formatBar,options||{}),this.className=this.instance.baseCSS(this.options.baseCSSClass),this.clicked=!1,this._bindFunctions()};_.extend(FormatBar.prototype,FunctionBind,{bound:["onFormatButtonClick"],render:function(){var bar=$("<div>",{"class":this.className});this.instance.$wrapper.prepend(bar),this.$el=bar;var formatName,format,formats=this.instance.formatters;for(formatName in formats)SirTrevor.Formatters.hasOwnProperty(formatName)&&(format=SirTrevor.Formatters[formatName],$("<button>",{"class":this.instance.baseCSS("format-button"),text:format.title,"data-type":formatName,"data-cmd":format.cmd,click:this.onFormatButtonClick}).appendTo(this.$el));var throttled_scroll=_.throttle(_.bind(this.handleDocumentScroll,this),150);$(document).bind("scroll",throttled_scroll),0===this.$el.find("button").length&&this.$el.addClass("hidden"),this.show()},handleDocumentScroll:function(){var instance_offset=(this.instance.$outer.height(),this.instance.$outer.offset().top),viewport_top=$(document).scrollTop();this.$el.hasClass("fixed")&&(instance_offset=this.$el.offset().top),viewport_top>5&&viewport_top>=instance_offset?(this.$el.addClass("fixed").css({width:this.instance.$wrapper.width()}),this.instance.$wrapper.css({"padding-top":"104px"})):(this.$el.removeClass("fixed").css({width:"100%"}),this.instance.$wrapper.css({"padding-top":"16px"}))},hide:function(){this.$el.removeClass(this.instance.baseCSS("item-ready"))},show:function(){this.$el.addClass(this.instance.baseCSS("item-ready"))},remove:function(){this.$el.remove()},onFormatButtonClick:function(ev){halt(ev);var btn=$(ev.target),format=SirTrevor.Formatters[btn.attr("data-type")];!_.isUndefined(format.onClick)&&_.isFunction(format.onClick)?format.onClick():document.execCommand(btn.attr("data-cmd"),!1,format.param),this.show()}});var SirTrevorEditor=SirTrevor.Editor=function(options){SirTrevor.log("Init SirTrevor.Editor"),this.blockTypes={},this.formatters={},this.blockCounts={},this.blocks=[],this.errors=[],this.cachedDomBlocks=[],this.options=_.extend({},SirTrevor.DEFAULTS,options||{}),this.ID=_.uniqueId("st-editor-"),this._ensureAndSetElements()&&(this.formatBar=new SirTrevor.FormatBar(this.options.formatBar,this),!_.isUndefined(this.options.onEditorRender)&&_.isFunction(this.options.onEditorRender)&&(this.onEditorRender=this.options.onEditorRender),this._setRequired(),this._setBlocksAndFormatters(),this._bindFunctions(),this.block_controls=new SirTrevor.BlockControls(this.blockTypes,this.ID),this.listenTo(this.block_controls,"createBlock",this.createBlock),this.store("create",this),this.build(),SirTrevor.instances.push(this),SirTrevor.bindFormSubmit(this.$form))};_.extend(SirTrevorEditor.prototype,FunctionBind,Events,{bound:["onFormSubmit"],initialize:function(){},build:function(){this.$el.hide(),this.formatBar.render(),this.$outer.append(this.block_controls.render().$el);var store=this.store("read",this);0===store.data.length?this.createBlock(this.options.defaultType):_.each(store.data,_.bind(function(block){SirTrevor.log("Creating: ",block),this.createBlock(block.type,block.data)},this)),this.$wrapper.addClass("sir-trevor-ready"),_.isUndefined(this.onEditorRender)||this.onEditorRender()},store:function(){return SirTrevor.editorStore.apply(this,arguments)},createBlock:function(type,data){if(type=_.capitalize(type),this._blockTypeAvailable(type)){var blockType=SirTrevor.Blocks[type],currentBlockCount=_.isUndefined(this.blockCounts[type])?0:this.blockCounts[type],totalBlockCounts=this.blocks.length,blockTypeLimit=this._getBlockTypeLimit(type);if(0!==blockTypeLimit&&currentBlockCount>blockTypeLimit||0!==this.options.blockLimit&&totalBlockCounts>=this.options.blockLimit)return SirTrevor.log("Block Limit reached for type "+type),!1;var block=new blockType(this,data||{});this.$wrapper.append(block.render().$el),_.isUndefined(this.blockCounts[type])&&(this.blockCounts[type]=0),this.blocks.push(block),currentBlockCount++,this.blockCounts[type]=currentBlockCount,0!==this.options.blockLimit&&this.blocks.length>=this.options.blockLimit,0!==blockTypeLimit&&currentBlockCount>=blockTypeLimit&&SirTrevor.log("Block Limit reached for type "+type+" setting state as inactive"),SirTrevor.publish("editor/block/createBlock"),SirTrevor.log("Block created of type "+type),this.cachedDomBlocks=this.$wrapper.find("."+this.baseCSS("block"))}else SirTrevor.log("Block type not available "+type)},removeBlock:function(block){block.remove(),this.blockCounts[block.type]=this.blockCounts[block.type]-1,this.blocks=_.reject(this.blocks,function(item){return item.blockID==block.blockID}),_.isUndefined(this.blocks)&&(this.blocks=[]),SirTrevor.publish("editor/block/removeBlock"),this.cachedDomBlocks=this.$wrapper.find("."+this.baseCSS("block")),this._getBlockTypeLimit(block.type)>this.blockCounts[block.type]&&SirTrevor.log("Removing block limit for "+block.type)},performValidations:function(_block,should_validate){var errors=0;!SirTrevor.SKIP_VALIDATION&&should_validate?_block.validate()||(SirTrevor.log("Block "+_block.blockID+" failed validation"),++errors):_block._beforeValidate();var store=_block.save();return _.isEmpty(store.data)||(SirTrevor.log("Adding data for block "+_block.blockID+" to block store"),this.store("add",this,{data:store})),errors},onFormSubmit:function(should_validate){should_validate=should_validate===!1?!1:!0,SirTrevor.log("Handling form submission for Editor "+this.ID);var errors=0;this.removeErrors(),this.store("reset",this);var blockIterator=function(block){block=$(block);var _block=_.find(this.blocks,function(b){return b.blockID==block.attr("id")});_.isUndefined(_block)&&_.isEmpty(_block)&&typeof _block!=SirTrevor.Block||(errors+=this.performValidations(_block,should_validate))};return _.each(this.$wrapper.find("."+this.options.baseCSSClass+"-block"),_.bind(blockIterator,this)),this.required&&!SirTrevor.SKIP_VALIDATION&&should_validate&&_.each(this.required,_.bind(function(type){if(this._blockTypeAvailable(type))if(_.isUndefined(this.blockCounts[type])||0===this.blockCounts[type])this.errors.push({text:"You must have a block of type "+type}),SirTrevor.log("Failed validation on required block type "+type),errors++;else{var blocks=_.filter(this.blocks,function(b){return b.type==type&&!_.isEmpty(b.getData())});0===blocks.length&&(this.errors.push({text:"A required block type "+type+" is empty"}),errors++,SirTrevor.log("A required block type "+type+" is empty"))}},this)),this.store("save",this),errors>0&&this.renderErrors(),errors},renderErrors:function(){if(this.errors.length>0){_.isUndefined(this.$errors)&&(this.$errors=$("<div>",{"class":this.baseCSS("errors"),html:"<p>You have the following errors: </p><ul></ul>"}),this.$outer.prepend(this.$errors));var list=this.$errors.find("ul");_.each(this.errors,_.bind(function(error){list.append($("<li>",{"class":this.baseCSS("error-msg"),html:error.text}))},this)),this.$errors.show()}},removeErrors:function(){this.errors.length>0&&(this.$errors.find("ul").html(""),this.$errors.hide(),this.errors=[])},_getBlockTypeLimit:function(t){return this._blockTypeAvailable(t)?_.isUndefined(this.options.blockTypeLimits[t])?SirTrevor.Blocks[t].prototype.limit:this.options.blockTypeLimits[t]:0},_blockTypeAvailable:function(t){return!_.isUndefined(this.blockTypes[t])},_formatterAvailable:function(f){return!_.isUndefined(this.formatters[f])},_ensureAndSetElements:function(){if(_.isUndefined(this.options.el)||_.isEmpty(this.options.el))return SirTrevor.log("You must provide an el"),!1;this.$el=this.options.el,this.el=this.options.el[0],this.$form=this.$el.parents("form");var $outer=$("<div>").attr({id:this.ID,"class":"st-outer",dropzone:"copy link move"}),$wrapper=$("<div>").attr({"class":"st-blocks"});return this.$el.wrap($outer).wrap($wrapper),this.$outer=this.$form.find("#"+this.ID),this.$wrapper=this.$form.find(".st-blocks"),console.log(this.$outer),!0},_setBlocksAndFormatters:function(){this.blockTypes=flattern(_.isUndefined(this.options.blockTypes)?SirTrevor.Blocks:this.options.blockTypes),this.formatters=flattern(_.isUndefined(this.options.formatters)?SirTrevor.Formatters:this.options.formatters)},_setRequired:function(){this.required=_.isArray(this.options.required)&&!_.isEmpty(this.options.required)?this.options.required:!1},_toMarkdown:function(content,type){var markdown;markdown=content.replace(/\n/gm,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/g,"[$2]($1)").replace(/<\/?b>/g,"**").replace(/<\/?STRONG>/g,"**").replace(/<\/?i>/g,"_").replace(/<\/?EM>/g,"_");var formatName,format;for(formatName in this.formatters)SirTrevor.Formatters.hasOwnProperty(formatName)&&(format=SirTrevor.Formatters[formatName],!_.isUndefined(format.toMarkdown)&&_.isFunction(format.toMarkdown)&&(markdown=format.toMarkdown(markdown)));markdown=markdown.replace(/([^<>]+)(<div>)/g,"$1\n\n$2").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n\n").replace(/<\/p>/g,"\n\n\n\n").replace(/<(.)?br(.)?>/g,"\n\n").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">");var block;return SirTrevor.Blocks.hasOwnProperty(type)&&(block=SirTrevor.Blocks[type],!_.isUndefined(block.prototype.toMarkdown)&&_.isFunction(block.prototype.toMarkdown)&&(markdown=block.prototype.toMarkdown(markdown))),markdown=markdown.replace(/<\/?[^>]+(>|$)/g,"")},_toHTML:function(markdown,type){var formatName,format,html=markdown;for(formatName in this.formatters)SirTrevor.Formatters.hasOwnProperty(formatName)&&(format=SirTrevor.Formatters[formatName],!_.isUndefined(format.toHTML)&&_.isFunction(format.toHTML)&&(html=format.toHTML(html)));var block;return SirTrevor.Blocks.hasOwnProperty(type)&&(block=SirTrevor.Blocks[type],!_.isUndefined(block.prototype.toHTML)&&_.isFunction(block.prototype.toHTML)&&(html=block.prototype.toHTML(html))),html=html.replace(/^\> (.+)$/gm,"$1").replace(/\n\n/g,"<br>").replace(/\[([^\]]+)\]\(([^\)]+)\)/g,"<a href='$2'>$1</a>").replace(/(?:_)([^*|_(http)]+)(?:_)/g,"<i>$1</i>").replace(/(?:\*\*)([^*|_]+)(?:\*\*)/g,"<b>$1</b>")},baseCSS:function(additional){return this.options.baseCSSClass+"-"+additional}}),SirTrevor.bindFormSubmit=function(form){formBound||(SirTrevor.submittable(),form.bind("submit",this.onFormSubmit),formBound=!0)},SirTrevor.onBeforeSubmit=function(should_validate){var errors=0;return _.each(SirTrevor.instances,function(inst){errors+=inst.onFormSubmit(should_validate)}),SirTrevor.log("Total errors: "+errors),errors},SirTrevor.onFormSubmit=function(ev){var errors=SirTrevor.onBeforeSubmit();errors>0&&(SirTrevor.publish("onError"),ev.preventDefault())},SirTrevor.runOnAllInstances=function(method){_.has(SirTrevor.Editor.prototype,method)?([].unshift.call(arguments,SirTrevor.instances),_.invoke.apply(_,arguments)):SirTrevor.log("method doesn't exist")}})(jQuery,_);