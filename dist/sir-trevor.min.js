(function($,_){function flattern(obj){var x={};return _.each(obj,function(a,b){x[_.isArray(obj)?a:b]=!0}),x}function halt(ev){ev.preventDefault(),ev.stopPropagation()}function toSlug(string){return string.toLowerCase().replace(/[^\w ]+/g,"").replace(/ +/g,"-")}var SirTrevor,root=this,array=[];array.push;var slice=array.slice;array.splice,SirTrevor=root.SirTrevor={},SirTrevor.DEBUG=!0,SirTrevor.SKIP_VALIDATION=!1,SirTrevor.DEFAULTS={baseCSSClass:"sir-trevor",errorClass:"error",defaultType:"Text",spinner:{className:"spinner",lines:9,length:8,width:3,radius:6,color:"#000",speed:1.4,trail:57,shadow:!1,left:"50%",top:"50%"},marker:{baseCSSClass:"marker",buttonClass:"button",addText:"Click to add:",dropText:"Drop to place content"},formatBar:{baseCSSClass:"formatting-control"},blockLimit:0,blockTypeLimits:{},required:[],uploadUrl:"/attachments",baseImageUrl:"/sir-trevor-uploads/"},SirTrevor.Blocks={},SirTrevor.Formatters={},SirTrevor.instances=[];var formBound=!1,FunctionBind={bound:[],_bindFunctions:function(){var args=[];args.push(this),args.join(this.bound),_.bindAll.apply(this,args)}},Renderable={tagName:"div",className:"sir-trevor__view",attributes:{},$:function(selector){return this.$el.find(selector)},render:function(){return this},_ensureElement:function(){if(this.el)this._setElement(this.el);else{var attrs=_.extend({},_.result(this,"attributes"));this.id&&(attrs.id=this.id),this.className&&(attrs["class"]=this.className);var $el=$("<"+this.tagName+">").attr(attrs);this._setElement($el)}},_setElement:function(element){return this.$el=element instanceof jQuery?element:$(element),this.el=this.$el[0],this}};(function($){function dragEnter(e){halt(e)}function dragOver(e){e.originalEvent.dataTransfer.dropEffect="copy",halt(e)}function dragLeave(e){halt(e)}$.fn.dropArea=function(){return this.bind("dragenter",dragEnter).bind("dragover",dragOver).bind("dragleave",dragLeave),this},$.fn.noDropArea=function(){return this.unbind("dragenter").unbind("dragover").unbind("dragleave"),this}})(jQuery);var extend=function(protoProps,staticProps){var child,parent=this;child=protoProps&&_.has(protoProps,"constructor")?protoProps.constructor:function(){return parent.apply(this,arguments)},_.extend(child,parent,staticProps);var Surrogate=function(){this.constructor=child};return Surrogate.prototype=parent.prototype,child.prototype=new Surrogate,protoProps&&_.extend(child.prototype,protoProps),child.__super__=parent.prototype,child};SirTrevor.log=function(message){!_.isUndefined(console)&&SirTrevor.DEBUG&&console.log(message)};var eventSplitter=/\s+/,eventsApi=function(obj,action,name,rest){if(!name)return!0;if("object"==typeof name){for(var key in name)obj[action].apply(obj,[key,name[key]].concat(rest));return!1}if(eventSplitter.test(name)){for(var names=name.split(eventSplitter),i=0,l=names.length;l>i;i++)obj[action].apply(obj,[names[i]].concat(rest));return!1}return!0},triggerEvents=function(events,args){var ev,i=-1,l=events.length,a1=args[0],a2=args[1],a3=args[2];switch(args.length){case 0:for(;l>++i;)(ev=events[i]).callback.call(ev.ctx);return;case 1:for(;l>++i;)(ev=events[i]).callback.call(ev.ctx,a1);return;case 2:for(;l>++i;)(ev=events[i]).callback.call(ev.ctx,a1,a2);return;case 3:for(;l>++i;)(ev=events[i]).callback.call(ev.ctx,a1,a2,a3);return;default:for(;l>++i;)(ev=events[i]).callback.apply(ev.ctx,args)}},Events=SirTrevor.Events={on:function(name,callback,context){if(!eventsApi(this,"on",name,[callback,context])||!callback)return this;this._events||(this._events={});var events=this._events[name]||(this._events[name]=[]);return events.push({callback:callback,context:context,ctx:context||this}),this},once:function(name,callback,context){if(!eventsApi(this,"once",name,[callback,context])||!callback)return this;var self=this,once=_.once(function(){self.off(name,once),callback.apply(this,arguments)});return once._callback=callback,this.on(name,once,context)},off:function(name,callback,context){var retain,ev,events,names,i,l,j,k;if(!this._events||!eventsApi(this,"off",name,[callback,context]))return this;if(!name&&!callback&&!context)return this._events={},this;for(names=name?[name]:_.keys(this._events),i=0,l=names.length;l>i;i++)if(name=names[i],events=this._events[name]){if(this._events[name]=retain=[],callback||context)for(j=0,k=events.length;k>j;j++)ev=events[j],(callback&&callback!==ev.callback&&callback!==ev.callback._callback||context&&context!==ev.context)&&retain.push(ev);retain.length||delete this._events[name]}return this},trigger:function(name){if(!this._events)return this;var args=slice.call(arguments,1);if(!eventsApi(this,"trigger",name,args))return this;var events=this._events[name],allEvents=this._events.all;return events&&triggerEvents(events,args),allEvents&&triggerEvents(allEvents,arguments),this},stopListening:function(obj,name,callback){var listeners=this._listeners;if(!listeners)return this;var deleteListener=!name&&!callback;"object"==typeof name&&(callback=this),obj&&((listeners={})[obj._listenerId]=obj);for(var id in listeners)listeners[id].off(name,callback,this),deleteListener&&delete this._listeners[id];return this}},listenMethods={listenTo:"on",listenToOnce:"once"};_.each(listenMethods,function(implementation,method){Events[method]=function(obj,name,callback){var listeners=this._listeners||(this._listeners={}),id=obj._listenerId||(obj._listenerId=_.uniqueId("l"));return listeners[id]=obj,"object"==typeof name&&(callback=this),obj[implementation](name,callback,this),this}}),Events.bind=Events.on,Events.unbind=Events.off;var o=$(SirTrevor);SirTrevor.subscribe=SirTrevor.on=function(){o.on.apply(o,arguments)},SirTrevor.unsubscribe=SirTrevor.off=function(){o.off.apply(o,arguments)},SirTrevor.publish=SirTrevor.trigger=function(){o.trigger.apply(o,arguments)},SirTrevor.subscribeAll=function(subscriptions){_.each(subscriptions,function(){o.on.apply(o,arguments)})},function(a,b,c){function g(a,c){var e,d=b.createElement(a||"div");for(e in c)d[e]=c[e];return d}function h(a){for(var b=1,c=arguments.length;c>b;b++)a.appendChild(arguments[b]);return a}function j(a,b,c,d){var g=["opacity",b,~~(100*a),c,d].join("-"),h=.01+100*(c/d),j=Math.max(1-(1-a)/b*(100-h),a),k=f.substring(0,f.indexOf("Animation")).toLowerCase(),l=k&&"-"+k+"-"||"";return e[g]||(i.insertRule("@"+l+"keyframes "+g+"{"+"0%{opacity:"+j+"}"+h+"%{opacity:"+a+"}"+(h+.01)+"%{opacity:1}"+(h+b)%100+"%{opacity:"+a+"}"+"100%{opacity:"+j+"}"+"}",0),e[g]=1),g}function k(a,b){var f,g,e=a.style;if(e[b]!==c)return b;for(b=b.charAt(0).toUpperCase()+b.slice(1),g=0;d.length>g;g++)if(f=d[g]+b,e[f]!==c)return f}function l(a,b){for(var c in b)a.style[k(a,c)||c]=b[c];return a}function m(a){for(var b=1;arguments.length>b;b++){var d=arguments[b];for(var e in d)a[e]===c&&(a[e]=d[e])}return a}function n(a){for(var b={x:a.offsetLeft,y:a.offsetTop};a=a.offsetParent;)b.x+=a.offsetLeft,b.y+=a.offsetTop;return b}var f,d=["webkit","Moz","ms","O"],e={},i=function(){var a=g("style");return h(b.getElementsByTagName("head")[0],a),a.sheet||a.styleSheet}(),o={lines:12,length:7,width:5,radius:10,rotate:0,color:"#000",speed:1,trail:100,opacity:.25,fps:20,zIndex:2e9,className:"spinner",top:"auto",left:"auto"},p=function q(a){return this.spin?(this.opts=m(a||{},q.defaults,o),void 0):new q(a)};p.defaults={},m(p.prototype,{spin:function(a){this.stop();var h,i,b=this,c=b.opts,d=b.el=l(g(0,{className:c.className}),{position:"relative",zIndex:c.zIndex}),e=c.radius+c.length+c.width;if(a&&(a.insertBefore(d,a.firstChild||null),i=n(a),h=n(d),l(d,{left:("auto"==c.left?i.x-h.x+(a.offsetWidth>>1):c.left+e)+"px",top:("auto"==c.top?i.y-h.y+(a.offsetHeight>>1):c.top+e)+"px"})),d.setAttribute("aria-role","progressbar"),b.lines(d,b.opts),!f){var j=0,k=c.fps,m=k/c.speed,o=(1-c.opacity)/(m*c.trail/100),p=m/c.lines;!function q(){j++;for(var a=c.lines;a;a--){var e=Math.max(1-(j+a*p)%m*o,c.opacity);b.opacity(d,c.lines-a,e,c)}b.timeout=b.el&&setTimeout(q,~~(1e3/k))}()}return b},stop:function(){var a=this.el;return a&&(clearTimeout(this.timeout),a.parentNode&&a.parentNode.removeChild(a),this.el=c),this},lines:function(a,b){function e(a,d){return l(g(),{position:"absolute",width:b.length+b.width+"px",height:b.width+"px",background:a,boxShadow:d,transformOrigin:"left",transform:"rotate("+~~(360/b.lines*c+b.rotate)+"deg) translate("+b.radius+"px"+",0)",borderRadius:(b.width>>1)+"px"})}for(var d,c=0;b.lines>c;c++)d=l(g(),{position:"absolute",top:1+~(b.width/2)+"px",transform:b.hwaccel?"translate3d(0,0,0)":"",opacity:b.opacity,animation:f&&j(b.opacity,b.trail,c,b.lines)+" "+1/b.speed+"s linear infinite"}),b.shadow&&h(d,l(e("#000","0 0 4px #000"),{top:"2px"})),h(a,h(d,e(b.color,"0 0 1px rgba(0,0,0,.1)")));return a},opacity:function(a,b,c){a.childNodes.length>b&&(a.childNodes[b].style.opacity=c)}}),!function(){function a(a,b){return g("<"+a+' xmlns="urn:schemas-microsoft.com:vml" class="spin-vml">',b)}var b=l(g("group"),{behavior:"url(#default#VML)"});!k(b,"transform")&&b.adj?(i.addRule(".spin-vml","behavior:url(#default#VML)"),p.prototype.lines=function(b,c){function f(){return l(a("group",{coordsize:e+" "+e,coordorigin:-d+" "+-d}),{width:e,height:e})}function k(b,e,g){h(i,h(l(f(),{rotation:360/c.lines*b+"deg",left:~~e}),h(l(a("roundrect",{arcsize:1}),{width:d,height:c.width,left:c.radius,top:-c.width>>1,filter:g}),a("fill",{color:c.color,opacity:c.opacity}),a("stroke",{opacity:0}))))}var j,d=c.length+c.width,e=2*d,g=2*-(c.width+c.length)+"px",i=l(f(),{position:"absolute",top:g,left:g});if(c.shadow)for(j=1;c.lines>=j;j++)k(j,-2,"progid:DXImageTransform.Microsoft.Blur(pixelradius=2,makeshadow=1,shadowopacity=.3)");for(j=1;c.lines>=j;j++)k(j);return h(b,i)},p.prototype.opacity=function(a,b,c,d){var e=a.firstChild;d=d.shadow&&d.lines||0,e&&e.childNodes.length>b+d&&(e=e.childNodes[b+d],e=e&&e.firstChild,e=e&&e.firstChild,e&&(e.opacity=c))}):f=k(b,"animation")}(),a.Spinner=p}(window,document),function($){$.fn.limit_chars=function(){0!==this.length&&(this.attr("maxlength")&&(this.attr("data-maxlength",this.attr("maxlength")),this.removeAttr("maxlength")),0===this.parents(".extended_input").length&&(count=this.chars()<this.attr("data-maxlength")?this.chars():"<em>"+this.chars()+"</em>",this.wrap($("<div>",{"class":"extended_input"})).after($("<span>",{"class":"count",html:count+" of "+this.attr("data-maxlength")})),this.bind("keydown keyup paste",function(){count=$(this).chars()<$(this).attr("data-maxlength")?$(this).chars():"<em>"+$(this).chars()+"</em>",$(this).parent().find(".count").html(count+" of "+$(this).attr("data-maxlength"))})))},$.fn.chars=function(){return count=void 0!==this.attr("contenteditable")?this.text().length:this.val().length},$.fn.too_long=function(){return this.chars()>this.attr("data-maxlength")}}(jQuery),SirTrevor.blockStore=function(method,block,options){var resp;switch(options=options||{},method){case"create":var data=options.data||{};block.dataStore={type:block.type.toLowerCase(),data:data};break;case"save":options.data&&(block.dataStore.data=options.data,resp=block.dataStore);break;case"read":resp=block.dataStore}return resp?resp:void 0},SirTrevor.editorStore=function(method,editor,options){var resp;switch(options=options||{},method){case"create":var content=_.trim(editor.$el.val());if(editor.dataStore={data:[]},content.length>0)try{var str=JSON.parse(content);_.isUndefined(str.data)||(editor.dataStore=str)}catch(e){console.log("Sorry there has been a problem with parsing the JSON"),console.log(e)}break;case"reset":editor.dataStore={data:[]};break;case"add":options.data&&(editor.dataStore.data.push(options.data),resp=editor.dataStore);break;case"save":editor.$el.val(editor.dataStore.data.length>0?JSON.stringify(editor.dataStore):"");break;case"read":resp=editor.dataStore}return resp?resp:void 0};var Submittable=function(){this.intialize()};_.extend(Submittable.prototype,{intialize:function(){this.submitBtn=$("input[type='submit']");var btnTitles=[];_.each(this.submitBtn,function(btn){btnTitles.push($(btn).attr("value"))}),this.submitBtnTitles=btnTitles,this.canSubmit=!0,this.globalUploadCount=0,this._bindEvents()},setSubmitButton:function(e,message){this.submitBtn.attr("value",message)},resetSubmitButton:function(){_.each(this.submitBtn,_.bind(function(item,index){$(item).attr("value",this.submitBtnTitles[index])},this))},onUploadStart:function(){this.globalUploadCount++,SirTrevor.log("onUploadStart called "+this.globalUploadCount),1===this.globalUploadCount&&this._disableSubmitButton()},onUploadStop:function(){this.globalUploadCount=0>=this.globalUploadCount?0:this.globalUploadCount-1,SirTrevor.log("onUploadStop called "+this.globalUploadCount),0===this.globalUploadCount&&this._enableSubmitButton()},onError:function(){SirTrevor.log("onError called"),this.canSubmit=!1},_disableSubmitButton:function(message){this.setSubmitButton(null,message||"Please wait..."),this.submitBtn.attr("disabled","disabled").addClass("disabled")},_enableSubmitButton:function(){this.resetSubmitButton(),this.submitBtn.removeAttr("disabled").removeClass("disabled")},_bindEvents:function(){SirTrevor.subscribe("disableSubmitButton",_.bind(this._disableSubmitButton,this)),SirTrevor.subscribe("enableSubmitButton",_.bind(this._enableSubmitButton,this)),SirTrevor.subscribe("setSubmitButton",_.bind(this.setSubmitButton,this)),SirTrevor.subscribe("resetSubmitButton",_.bind(this.resetSubmitButton,this)),SirTrevor.subscribe("onError",_.bind(this.onError,this)),SirTrevor.subscribe("onUploadStart",_.bind(this.onUploadStart,this)),SirTrevor.subscribe("onUploadStop",_.bind(this.onUploadStop,this))}}),SirTrevor.submittable=function(){new Submittable},SirTrevor.fileUploader=function(block,file,success,error){SirTrevor.publish("onUploadStart");var uid=[block.ID,(new Date).getTime(),"raw"].join("-"),data=new FormData;data.append("attachment[name]",file.name),data.append("attachment[file]",file),data.append("attachment[uid]",uid);var callbackSuccess=function(data){!_.isUndefined(success)&&_.isFunction(success)&&(SirTrevor.log("Upload callback called"),SirTrevor.publish("onUploadStop"),_.bind(success,block)(data))},callbackError=function(jqXHR,status){!_.isUndefined(error)&&_.isFunction(error)&&(SirTrevor.log("Upload callback error called"),SirTrevor.publish("onUploadError"),_.bind(error,block)(status))};$.ajax({url:SirTrevor.DEFAULTS.uploadUrl,data:data,cache:!1,contentType:!1,processData:!1,type:"POST",success:callbackSuccess,error:callbackError})};var url_regex=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/;_.mixin({isURI:function(string){return url_regex.test(string)},capitalize:function(string){return string.charAt(0).toUpperCase()+string.substring(1).toLowerCase()},trim:function(string){return string.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}}),SirTrevor.toHTML=function(markdown,type){var formatName,format,html=markdown;for(formatName in this.formatters)SirTrevor.Formatters.hasOwnProperty(formatName)&&(format=SirTrevor.Formatters[formatName],!_.isUndefined(format.toHTML)&&_.isFunction(format.toHTML)&&(html=format.toHTML(html)));var block;return SirTrevor.Blocks.hasOwnProperty(type)&&(block=SirTrevor.Blocks[type],!_.isUndefined(block.prototype.toHTML)&&_.isFunction(block.prototype.toHTML)&&(html=block.prototype.toHTML(html))),html=html.replace(/^\> (.+)$/gm,"$1").replace(/\n\n/g,"<br>").replace(/\[([^\]]+)\]\(([^\)]+)\)/g,"<a href='$2'>$1</a>").replace(/(?:_)([^*|_(http)]+)(?:_)/g,"<i>$1</i>").replace(/(?:\*\*)([^*|_]+)(?:\*\*)/g,"<b>$1</b>")},SirTrevor.toMarkdown=function(content,type){var markdown;markdown=content.replace(/\n/gm,"").replace(/<a.*?href=[""'](.*?)[""'].*?>(.*?)<\/a>/g,"[$2]($1)").replace(/<\/?b>/g,"**").replace(/<\/?STRONG>/g,"**").replace(/<\/?i>/g,"_").replace(/<\/?EM>/g,"_");var formatName,format;for(formatName in this.formatters)SirTrevor.Formatters.hasOwnProperty(formatName)&&(format=SirTrevor.Formatters[formatName],!_.isUndefined(format.toMarkdown)&&_.isFunction(format.toMarkdown)&&(markdown=format.toMarkdown(markdown)));markdown=markdown.replace(/([^<>]+)(<div>)/g,"$1\n\n$2").replace(/(?:<div>)([^<>]+)(?:<div>)/g,"$1\n\n").replace(/(?:<div>)(?:<br>)?([^<>]+)(?:<br>)?(?:<\/div>)/g,"$1\n\n").replace(/<\/p>/g,"\n\n\n\n").replace(/<(.)?br(.)?>/g,"\n\n").replace(/&nbsp;/g," ").replace(/&lt;/g,"<").replace(/&gt;/g,">");var block;return SirTrevor.Blocks.hasOwnProperty(type)&&(block=SirTrevor.Blocks[type],!_.isUndefined(block.prototype.toMarkdown)&&_.isFunction(block.prototype.toMarkdown)&&(markdown=block.prototype.toMarkdown(markdown))),markdown=markdown.replace(/<\/?[^>]+(>|$)/g,"")};var Block=SirTrevor.Block=function(data,instance_id){this.store("create",this,{data:data||{}}),this.blockID=_.uniqueId(this.className+"-"),this.instanceID=instance_id,this._ensureElement(),this._bindFunctions(),this.initialize.apply(this,arguments)},default_drop_options={uploadable:!1,pastable:!1,drop_html:'<div class="st-block__dropzone"><span class="st-icon"><%= icon_name() %></span><p>Drag <span><%= type %></span> here</p></div>',upload_html:'<div class="st-block__upload-container"><input type="file" type="st-file-upload" /><button class="st-upload-btn">...or choose a file</button></div>',paste_html:'<input type="text" placeholder="Or paste URL here" class="st-block__paste-input st-paste-block">'};_.extend(Block.prototype,FunctionBind,Events,Renderable,{bound:["_handleDrop","_handleContentPaste","onFocus","onBlur","onDrop","onDrag","onDragStart","onDragEnd"],className:"st-block",attributes:function(){return{id:this.blockID,"data-type":this.type,"data-instance":this.instanceID}},title:function(){return _.capitalize(this.type)},icon_name:function(){return this.type.toLowerCase()},blockCSSClass:function(){return this.blockCSSClass=toSlug(this.type),this.blockCSSClass},validationFailMsg:function(){return this.type+" block is invalid"},$$:function(selector){return this.$el.find(selector)},type:"",editorHTML:'<div class="st-block__editor"></div>',toolbarEnabled:!0,droppable:!1,formattable:!0,formattingEnabled:!0,uploadsCount:0,initialize:function(){},loadData:function(){},onBlockRender:function(){},beforeBlockRender:function(){},setTextLimit:function(){},toMarkdown:function(markdown){return markdown},toHTML:function(html){return html},store:function(){return SirTrevor.blockStore.apply(this,arguments)},_loadAndSetData:function(){var currentData=this.getData();_.isUndefined(currentData)||_.isEmpty(currentData)||this._loadData()},render:function(){this.beforeBlockRender();var editor_html=_.result(this,"editorHTML");return this.$el.append(editor_html).addClass("st-block--"+_.result(this,"blockCSSClass")),this.$editor=$(editor_html),this._loadAndSetData(),this.hasTextBlock&&this._initTextBlocks(),this.droppable&&this._initDroppable(),this.formattingEnabled&&this._initFormatting(),this._initUIComponents(),this._initPaste(),this.$el.addClass("st-item-ready"),this.save(),this.onBlockRender(),this},remove:function(){this.$el.remove()},save:function(){return this.toData(),this.store("read",this)},getData:function(){return this.store("read",this).data},setData:function(data){SirTrevor.log("Setting data for block "+this.blockID),this.store("save",this,{data:data})},loading:function(){_.isUndefined(this.spinner)||this.ready(),this.spinner=new Spinner(SirTrevor.DEFAULTS.spinner),this.spinner.spin(this.$el[0]),this.$el.addClass("st-loading")},ready:function(){this.$el.removeClass("st-loading"),_.isUndefined(this.spinner)||(this.spinner.stop(),delete this.spinner)},validate:function(){this._beforeValidate();var fields=this.$$(".st-required, [data-maxlength]"),errors=0;return _.each(fields,_.bind(function(field){field=$(field);var content=field.attr("contenteditable")?field.text():field.val(),too_long=field.attr("data-maxlength")&&field.too_long(),required=field.hasClass("st-required");(required&&0===content.length||too_long)&&(field.addClass("st-error"),errors++)},this)),errors>0&&this.$el.addClass("st-block--with-errors"),0===errors},toData:function(){SirTrevor.log("toData for "+this.blockID);var dataObj=(this.$el,{});if(this.$$(".st-text-block").length>0){var content=this.$$(".st-text-block").html();content.length>0&&(dataObj.text=SirTrevor.toMarkdown(content,this.type))}var hasTextAndData=!_.isUndefined(dataObj.text)||0===this.$$(".st-text-block").length;this.$$('input[type="text"]').not(".st-paste-block").length>0&&this.$$('input[type="text"]').each(function(index,input){input=$(input),input.val().length>0&&hasTextAndData&&(dataObj[input.attr("name")]=input.val())}),this.$$("select").each(function(index,input){input=$(input),input.val().length>0&&hasTextAndData&&(dataObj[input.attr("name")]=input.val())}),this.$$('input[type="file"]').each(function(index,input){input=$(input),dataObj.file=input.data("json")}),_.isEmpty(dataObj)||this.setData(dataObj)},focus:function(){this.$(".st-text-block").bind("focus",this.onFocus)},blur:function(){this.$(".st-text-block").bind("blur",this.onBlur)},onFocus:function(){this.$el.addClass("st-block--active")},onBlur:function(){},onDrop:function(){},onDrag:function(){},onDragStart:function(ev){var item=$(ev.target),block=item.parents(".st-block");ev.originalEvent.dataTransfer.setDragImage(block[0],0,0),ev.originalEvent.dataTransfer.setData("Text",block.attr("id")),block.addClass("st-block--dragging")},onDragEnd:function(ev){var item=$(ev.target),block=item.parents(".st-block");block.removeClass("st-block--dragging")},onDeleteClick:function(ev){confirm("Are you sure you wish to delete this content?")&&(this.remove(),this.trigger("removeBlock",this.blockID,this.type),halt(ev))},onContentPasted:function(){var textBlock=this.$$(".st-text-block");textBlock.length>0&&textBlock.html(SirTrevor.toHTML(SirTrevor.toMarkdown(textBlock.html(),this.type),this.type))},uploader:function(file,callback){SirTrevor.fileUploader(this,file,callback)},_loadData:function(){SirTrevor.log("loadData for "+this.blockID),this.loading(),this.dropEnabled&&this.$dropzone.hide(),SirTrevor.publish("editor/block/loadData"),this.loadData(this.getData()),this.ready()},_beforeValidate:function(){this.errors=[];var errorClass="st-error";this.$el.removeClass("st-block--with-errors"),this.$("."+errorClass).removeClass(errorClass)},_handleContentPaste:function(ev){var timed=function(ev){this.onContentPasted(ev)};_.delay(_.bind(timed,this,ev),100)},_handleDrop:function(e){e.preventDefault(),e=e.originalEvent,SirTrevor.publish("editor/block/handleDrop");var types=($(e.target),e.dataTransfer.types);this.$dropzone.removeClass("st-dropzone--dragover"),_.isUndefined(types)||(_.include(types,"Files")||_.include(types,"text/plain")||_.include(types,"text/uri-list"))&&this.onDrop(e.dataTransfer)},_getBlockClass:function(){return"st-block--"+this.className},_initDroppable:function(){SirTrevor.log("Adding drag and drop capabilities for block "+this.blockID);var drop_options=_.extend(default_drop_options,this.drop_options),drop_html=$(_.template(drop_options.drop_html,this));this.drop_options.pastable&&drop_html.append(drop_options.paste_html),this.drop_options.uploadable&&drop_html.append(drop_options.upload_html),this.$el.append(drop_html),this.$dropzone=drop_html,this.$dropzone.bind("drop",this._handleDrop).bind("dragenter",function(e){halt(e),$(this).addClass("st-dropzone--dragover")}).bind("dragover",function(e){e.originalEvent.dataTransfer.dropEffect="copy",halt(e),$(this).addClass("st-dropzone--dragover")}).bind("dragleave",function(e){halt(e),$(this).removeClass("st-dropzone--dragover")})},_initUIComponents:function(){var ui_element=$("<div>",{"class":"st-block__ui"});this.$el.append(ui_element),this.$ui=ui_element,this.$el.bind("mouseover",_.bind(function(){this.$el.toggleClass("st-block--over")},this)).bind("mouseout",_.bind(function(){this.$el.toggleClass("st-block--over")},this)),this.focus(),this.blur(),this._initReordering(),this._initDeletion()},_initReordering:function(){var reorder_element=$("<a>",{"class":"st-block__reorder st-icon",html:"reorder",draggable:"true"});this.$ui.append(reorder_element),reorder_element.bind("dragstart",this.onDragStart).bind("dragend",this.onDragEnd).bind("drag",this.onDrag),this.$el.bind("drop",halt).bind("mouseover",halt).bind("mouseout",halt).bind("dragleave",halt).bind("dragover",function(ev){ev.preventDefault()})},_initDeletion:function(){var delete_el=$("<a>",{"class":"st-block__remove st-icon",html:"delete"});this.$ui.append(delete_el),delete_el.bind("click",this.onDeleteClick)},_initFormatting:function(){var formatter;for(var name in SirTrevor.Formatters)SirTrevor.Formatters.hasOwnProperty(name)&&(formatter=SirTrevor.Formatters[name],_.isUndefined(formatter.keyCode)||formatter._bindToBlock(this.$el))},_initTextBlocks:function(){document.execCommand("styleWithCSS",!1,!1),document.execCommand("insertBrOnReturn",!1,!0),this.$$(".st-text-block").bind("paste",this._handleContentPaste)},hasTextBlock:function(){return this.$(".st-text-block").length>0},_initPaste:function(){this.$(".st-paste-block").bind("click",function(){$(this).select()}).bind("paste",this._handleContentPaste).bind("submit",this._handleContentPaste)}}),Block.extend=extend;var Format=SirTrevor.Formatter=function(options){this.formatId=_.uniqueId("format-"),this._configure(options||{}),this.initialize.apply(this,arguments)},formatOptions=["title","className","cmd","keyCode","param","onClick","toMarkdown","toHTML"];_.extend(Format.prototype,{title:"",className:"",cmd:null,keyCode:null,param:null,toMarkdown:function(markdown){return markdown},toHTML:function(html){return html},initialize:function(){},_configure:function(options){this.options&&(options=_.extend({},this.options,options));for(var i=0,l=formatOptions.length;l>i;i++){var attr=formatOptions[i];options[attr]&&(this[attr]=options[attr])}this.options=options},_bindToBlock:function(block){var formatter=this,ctrlDown=!1;block.on("keyup",".st-text-block",function(ev){(17==ev.which||224==ev.which)&&(ctrlDown=!1)}).on("keydown",".st-text-block",{formatter:formatter},function(ev){(17==ev.which||224==ev.which)&&(ctrlDown=!0),ev.which==ev.data.formatter.keyCode&&ctrlDown===!0&&(document.execCommand(ev.data.formatter.cmd,!1,!0),ev.preventDefault())})}}),Format.extend=extend,SirTrevor.Blocks.Quote=SirTrevor.Block.extend({type:"Quote",editorHTML:function(){return _.template('<blockquote class="st-required st-text-block <%= className %>" contenteditable="true"></blockquote>          <input maxlength="140" name="cite" placeholder="Credit" class="st-input-string st-required" type="text" />',this)},loadData:function(data){this.$$(".st-text-block").html(SirTrevor.toHTML(data.text,this.type)),this.$$("input").val(data.cite)},toMarkdown:function(markdown){return markdown.replace(/^(.+)$/gm,"> $1")}}),SirTrevor.Blocks.Gallery=SirTrevor.Block.extend({type:"Gallery",droppable:!0,drop_options:{uploadable:!0},editorHTML:'<div class="gallery-items"><p>Gallery Contents:</p><ul></ul></div>',loadData:function(data){_.isArray(data)&&(_.each(data,_.bind(function(item){this.renderGalleryThumb(item)},this)),this.$dropzone.show())},renderGalleryThumb:function(item){if(_.isUndefined(item.data.file))return!1;var img=$("<img>",{src:item.data.file.thumb.url}),list=$("<li>",{id:_.uniqueId("gallery-item"),"class":"gallery-item",html:img});list.append($("<span>",{"class":"delete",click:_.bind(function(e){halt(e),confirm("Are you sure you wish to delete this image?")&&($(e.target).parent().remove(),this.reindexData())},this)})),list.data("block",item),this.$$("ul").append(list),list.dropArea().bind("dragstart",_.bind(function(ev){var item=$(ev.target);ev.originalEvent.dataTransfer.setData("Text",item.parent().attr("id")),item.parent().addClass("dragging")},this)).bind("drag",_.bind(function(){},this)).bind("dragend",_.bind(function(ev){var item=$(ev.target);item.parent().removeClass("dragging")},this)).bind("dragover",_.bind(function(ev){var item=$(ev.target);item.parents("li").addClass("dragover")},this)).bind("dragleave",_.bind(function(ev){var item=$(ev.target);item.parents("li").removeClass("dragover")},this)).bind("drop",_.bind(function(ev){var item=$(ev.target),parent=item.parent();item=item.hasClass("gallery-item")?item:parent,this.$$("ul li.dragover").removeClass("dragover");var target=$("#"+ev.originalEvent.dataTransfer.getData("text/plain"));return target.attr("id")===item.attr("id")?!1:(target.length>0&&target.hasClass("gallery-item")&&item.before(target),this.reindexData(),void 0)},this))},onBlockRender:function(){this.$dropzone.find("button").bind("click",halt),this.$dropzone.find("input").on("change",_.bind(function(ev){this.onDrop(ev.currentTarget)},this))},reindexData:function(){var dataStruct=this.getData();dataStruct=[],_.each(this.$$("li.gallery-item"),function(li){li=$(li),dataStruct.push(li.data("block"))}),this.setData(dataStruct)},onDrop:function(transferData){if(transferData.files.length>0){var file,l=transferData.files.length;for(this.loading();l--;)file=transferData.files[l],/image/.test(file.type)&&(this.uploadsCount+=1,this.$editor.show(),this.uploader(file,function(data){this.uploadsCount-=1;var dataStruct=this.getData();data={type:"image",data:data},_.isArray(dataStruct)||(dataStruct=[]),dataStruct.push(data),this.setData(dataStruct),this.renderGalleryThumb(data),0===this.uploadsCount&&this.ready()}))}}}),SirTrevor.Blocks.Image=SirTrevor.Block.extend({type:"Image",droppable:!0,drop_options:{uploadable:!0},loadData:function(data){this.$editor.html($("<img>",{src:data.file.url}))},onBlockRender:function(){this.$dropzone.find("button").bind("click",halt),this.$dropzone.find("input").on("change",_.bind(function(ev){this.onDrop(ev.currentTarget)},this))},onDrop:function(transferData){var file=transferData.files[0],urlAPI="undefined"!=typeof URL?URL:"undefined"!=typeof webkitURL?webkitURL:null;/image/.test(file.type)&&(this.loading(),this.$dropzone.hide(),this.$editor.html($("<img>",{src:urlAPI.createObjectURL(file)})),this.$editor.show(),SirTrevor.publish("setSubmitButton",["Please wait..."]),this.uploader(file,function(data){this.setData(data),this.ready()},function(){alert("Error!")}))}}),SirTrevor.Blocks.Text=SirTrevor.Block.extend({type:"Text",editorHTML:'<div class="st-required st-text-block" contenteditable="true"></div>',loadData:function(data){this.$$(".st-text-block").html(SirTrevor.toHTML(data.text,this.type))}});var tweet_template='<div class="tweet"><img src="<%= user.profile_image_url %>" class="tweet-avatar"><div class="tweet-body"><p class="tweet-user"><a href="http://twitter.com/#!/<%= user.screen_name %>" class="tweet-user">@<%= user.screen_name %></a> on Twitter</p><p class="tweet-text"><%= text %></p><time><%= created_at %></time></div></div>';SirTrevor.Blocks.Tweet=SirTrevor.Block.extend({type:"Tweet",droppable:!0,drop_options:{pastable:!0},icon_name:function(){return"twitter"},loadData:function(data){this.$el.append(_.template(tweet_template,data))},onContentPasted:function(event){var input=$(event.target),val=input.val();this.handleTwitterDropPaste(val)},handleTwitterDropPaste:function(url){if(_.isURI(url)&&-1!=url.indexOf("twitter")&&-1!=url.indexOf("status")){var tweetID=url.match(/[^\/]+$/);if(!_.isEmpty(tweetID)){this.loading(),tweetID=tweetID[0];var tweetCallbackSuccess=function(data){var obj={user:{profile_image_url:data.user.profile_image_url,profile_image_url_https:data.user.profile_image_url_https,screen_name:data.user.screen_name,name:data.user.name},text:data.text,created_at:data.created_at,status_url:url};this.setData(obj),this._loadData(),this.ready()},tweetCallbackFail=function(){this.ready()};$.ajax({url:"http://api.twitter.com/1/statuses/show/"+tweetID+".json",dataType:"JSONP",success:_.bind(tweetCallbackSuccess,this),error:_.bind(tweetCallbackFail,this)})}}},onDrop:function(transferData){var url=transferData.getData("text/plain");this.handleTwitterDropPaste(url)}});var template='<div class="st-text-block" contenteditable="true"></div>';SirTrevor.Blocks.Ul=SirTrevor.Block.extend({type:"List",editorHTML:function(){return _.template(template,this)},onBlockRender:function(){this.$$(".st-text-block").bind("click",function(){0===$(this).html().length&&document.execCommand("insertUnorderedList",!1,!1)
}),_.isEmpty(this.data)&&this.$$(".st-text-block").focus().click()},loadData:function(data){this.$$(".st-text-block").html("<ul>"+SirTrevor.toHTML(data.text,this.type)+"</ul>")},toMarkdown:function(markdown){return markdown.replace(/<\/li>/gm,"\n").replace(/<\/?[^>]+(>|$)/g,"").replace(/^(.+)$/gm," - $1")},toHTML:function(html){return html=html.replace(/^ - (.+)$/gm,"<li>$1</li>").replace(/\n/gm,""),"<ul>"+html+"</ul>"}});var video_regex=/http[s]?:\/\/(?:www.)?(?:(vimeo).com\/(.*))|(?:(youtu(?:be)?).(?:be|com)\/(?:watch\?v=)?([^&]*)(?:&(?:.))?)/;SirTrevor.Blocks.Video=SirTrevor.Block.extend({type:"Video",droppable:!0,drop_options:{pastable:!0},loadData:function(data){"youtube"==data.source||"youtu"==data.source?this.$editor.html('<iframe src="'+window.location.protocol+"//www.youtube.com/embed/"+data.remote_id+'" width="580" height="320" frameborder="0" allowfullscreen></iframe>'):"vimeo"==data.source&&this.$editor.html('<iframe src="'+window.location.protocol+"//player.vimeo.com/video/"+data.remote_id+'?title=0&byline=0" width="580" height="320" frameborder="0"></iframe>')},onContentPasted:function(event){var input=$(event.target),val=input.val();this.handleDropPaste(val)},handleDropPaste:function(url){if(_.isURI(url)&&(-1!=url.indexOf("youtu")||-1!=url.indexOf("vimeo"))){var data={},videos=url.match(video_regex);void 0!==videos[3]?(data.source=videos[3],data.remote_id=videos[4]):void 0!==videos[1]&&(data.source=videos[1],data.remote_id=videos[2]),"youtu"==data.source&&(data.source="youtube"),this.setData(data),this._loadData()}},onDrop:function(transferData){var url=transferData.getData("text/plain");this.handleDropPaste(url)}});var Bold=SirTrevor.Formatter.extend({title:"B",className:"bold",cmd:"bold",keyCode:66}),Italic=SirTrevor.Formatter.extend({title:"I",className:"italic",cmd:"italic",keyCode:73});SirTrevor.Formatter.extend({title:"U",className:"underline",cmd:"underline"});var Link=SirTrevor.Formatter.extend({title:"Link",className:"link",cmd:"CreateLink",onClick:function(){var link=prompt("Enter a link"),link_regex=/(ftp|http|https):\/\/./;link&&link.length>0&&(link_regex.test(link)||(link="http://"+link),document.execCommand(this.cmd,!1,link))}}),UnLink=SirTrevor.Formatter.extend({title:"Unlink",className:"link",cmd:"unlink"});SirTrevor.Formatters.Bold=new Bold,SirTrevor.Formatters.Italic=new Italic,SirTrevor.Formatters.Link=new Link,SirTrevor.Formatters.Unlink=new UnLink;var BlockControl=SirTrevor.BlockControl=function(type,instance_scope){this.type=type,this.instance_scope=instance_scope,this._ensureElement(),this.initialize()};_.extend(BlockControl.prototype,FunctionBind,Renderable,Events,{tagName:"a",className:"st-block-control",attributes:function(){return{"data-type":this.type}},initialize:function(){this.block_type=SirTrevor.Blocks[this.type].prototype,this.can_be_rendered=this.block_type.toolbarEnabled},render:function(){return this.$el.html('<span class="st-icon">'+this.block_type.icon_name()+"</span>"+_.result(this.block_type,"title")),this}});var BlockControls=SirTrevor.BlockControls=function(available_types,instance_scope){this.instance_scope=instance_scope,this.available_types=available_types||[],this._ensureElement(),this._bindFunctions(),this.initialize()};_.extend(BlockControls.prototype,FunctionBind,Renderable,Events,{bound:["handleUIButtonClick","handleControlButtonClick"],className:"st-block-controls",initialize:function(){var block_controls_btn=$("<a>",{"class":"st-block-controls__activate-btn"});this.$el.append(block_controls_btn);var block_control_inner=$("<div>",{"class":"st-block-controls__inner"});this.$el.append(block_control_inner),this.$inner=block_control_inner;for(var block_type in this.available_types)if(SirTrevor.Blocks.hasOwnProperty(block_type)){var block_control=new SirTrevor.BlockControl(block_type,this.instance_scope);block_control.can_be_rendered&&this.$inner.append(block_control.render().$el)}block_controls_btn.bind("click",this.handleUIButtonClick),this.$el.delegate(".st-block-control","click",this.handleControlButtonClick)},toggleState:function(){this.$el.toggleClass("st-block-control--active")},handleUIButtonClick:function(){this.toggleState()},handleControlButtonClick:function(e){e.preventDefault(),this.trigger("createBlock",e.currentTarget.dataset.type),this.toggleState()}});var FloatingBlockControls=SirTrevor.FloatingBlockControls=function(wrapper){this.$wrapper=wrapper,this._ensureElement(),this._bindFunctions(),this.initialize()};_.extend(FloatingBlockControls.prototype,FunctionBind,Renderable,Events,{bound:["handleWrapperMouseOver","handleMouseOut"],className:"st-fl-block-controls",initialize:function(){this.$btn=$("<a>",{"class":"st-fl-block-controls__plus"}),this.$el.html(this.$btn).addClass("st-fl-block-controls--hidden"),this.$wrapper.bind("mouseover",this.handleWrapperMouseOver)},handleWrapperMouseOver:function(e){this.showAt(e.offsetY),this.$wrapper.unbind("mouseover"),this.$el.bind("mouseout",this.handleMouseOut)},handleMouseOut:function(){this.$wrapper.bind("mouseover",this.handleWrapperMouseOver),this.$el.addClass("st-fl-block-controls--hidden")},showAt:function(top){this.$el.css({top:top+"px"}).removeClass("st-fl-block-controls--hidden")}});var FormatBar=SirTrevor.FormatBar=function(options,editorInstance){this.instance=editorInstance,this.options=_.extend({},SirTrevor.DEFAULTS.formatBar,options||{}),this.className=this.instance.baseCSS(this.options.baseCSSClass),this.clicked=!1,this._bindFunctions()};_.extend(FormatBar.prototype,FunctionBind,{bound:["onFormatButtonClick"],render:function(){var bar=$("<div>",{"class":this.className});this.$el=bar;var formatName,format;for(formatName in SirTrevor.Formatters)SirTrevor.Formatters.hasOwnProperty(formatName)&&(format=SirTrevor.Formatters[formatName],$("<button>",{"class":this.instance.baseCSS("format-button"),text:format.title,"data-type":formatName,"data-cmd":format.cmd,click:this.onFormatButtonClick}).appendTo(this.$el));0===this.$el.find("button").length&&this.$el.addClass("hidden"),this.show()},handleDocumentScroll:function(){var instance_offset=(this.instance.$outer.height(),this.instance.$outer.offset().top),viewport_top=$(document).scrollTop();this.$el.hasClass("fixed")&&(instance_offset=this.$el.offset().top),viewport_top>5&&viewport_top>=instance_offset?(this.$el.addClass("fixed").css({width:this.instance.$wrapper.width()}),this.instance.$wrapper.css({"padding-top":"104px"})):(this.$el.removeClass("fixed").css({width:"100%"}),this.instance.$wrapper.css({"padding-top":"16px"}))},hide:function(){this.$el.removeClass(this.instance.baseCSS("item-ready"))},show:function(){this.$el.addClass(this.instance.baseCSS("item-ready"))},remove:function(){this.$el.remove()},onFormatButtonClick:function(ev){halt(ev);var btn=$(ev.target),format=SirTrevor.Formatters[btn.attr("data-type")];!_.isUndefined(format.onClick)&&_.isFunction(format.onClick)?format.onClick():document.execCommand(btn.attr("data-cmd"),!1,format.param),this.show()}});var SirTrevorEditor=SirTrevor.Editor=function(options){return SirTrevor.log("Init SirTrevor.Editor"),this.blockTypes={},this.blockCounts={},this.blocks=[],this.errors=[],this.options=_.extend({},SirTrevor.DEFAULTS,options||{}),this.ID=_.uniqueId("st-editor-"),this._ensureAndSetElements()?(this.formatBar=new SirTrevor.FormatBar(this.options.formatBar,this),!_.isUndefined(this.options.onEditorRender)&&_.isFunction(this.options.onEditorRender)&&(this.onEditorRender=this.options.onEditorRender),this._setRequired(),this._setBlocksTypes(),this._bindFunctions(),this.store("create",this),this.build(),SirTrevor.instances.push(this),SirTrevor.bindFormSubmit(this.$form),void 0):!1};_.extend(SirTrevorEditor.prototype,FunctionBind,Events,{bound:["onFormSubmit"],initialize:function(){},build:function(){this.$el.hide(),this.block_controls=new SirTrevor.BlockControls(this.blockTypes,this.ID),this.fl_block_controls=new SirTrevor.FloatingBlockControls(this.$wrapper),this.listenTo(this.block_controls,"createBlock",this.createBlock),this.formatBar.render(),this.$outer.prepend(this.fl_block_controls.render().$el),this.$outer.append(this.block_controls.render().$el);var store=this.store("read",this);0===store.data.length?this.createBlock(this.options.defaultType):_.each(store.data,_.bind(function(block){SirTrevor.log("Creating: ",block),this.createBlock(block.type,block.data)},this)),this.$wrapper.addClass("st-ready"),_.isUndefined(this.onEditorRender)||this.onEditorRender()},store:function(){return SirTrevor.editorStore.apply(this,arguments)},createBlock:function(type,data,place_before){if(type=_.capitalize(type),!this._isBlockTypeAvailable(type))return SirTrevor.log("Block type not available "+type),!1;if(!this._canAddBlockType(type))return SirTrevor.log("Block Limit reached for type "+type),!1;var block=new SirTrevor.Blocks[type](data,this.ID);_.isUndefined(place_before)?this.$wrapper.append(block.render().$el):place_before.before(block.render().$el),this.listenTo(block,"removeBlock",this.removeBlock),this.blocks.push(block),this._incrementBlockTypeCount(type),SirTrevor.publish("editor/block/createBlock"),SirTrevor.log("Block created of type "+type)},_incrementBlockTypeCount:function(type){this.blockCounts[type]=_.isUndefined(this.blockCounts[type])?0:this.blockCounts[type]+1},_getBlockTypeCount:function(type){return _.isUndefined(this.blockCounts[type])?0:this.blockCounts[type]},_canAddBlockType:function(type){var block_type_limit=this._getBlockTypeLimit(type);return!(0!==block_type_limit&&this._getBlockTypeCount(type)>block_type_limit)},removeBlock:function(block_id,type){this.blockCounts[type]=this.blockCounts[type]-1,this.blocks=_.reject(this.blocks,function(item){return item.blockID==block_id}),SirTrevor.publish("editor/block/removeBlock")},performValidations:function(block,should_validate){var errors=0;return block._beforeValidate(),!SirTrevor.SKIP_VALIDATION&&should_validate&&(block.validate()||(this.errors.push({text:_.result(block,"validationFailMsg")}),SirTrevor.log("Block "+block.blockID+" failed validation"),++errors)),errors},saveBlockStateToStore:function(block){var store=block.save();_.isEmpty(store.data)||(SirTrevor.log("Adding data for block "+block.blockID+" to block store"),this.store("add",this,{data:store}))},onFormSubmit:function(should_validate){return should_validate=should_validate===!1?!1:!0,SirTrevor.log("Handling form submission for Editor "+this.ID),this.removeErrors(),this.store("reset",this),this.validateBlocks(should_validate),this.validateBlockTypesExist(should_validate),this.renderErrors(),this.store("save",this),this.errors.length},validateBlocks:function(should_validate){if(!this.required&&SirTrevor.SKIP_VALIDATION&&!should_validate)return!1;var blockIterator=function(block){this.performValidations(block,should_validate),this.saveBlockStateToStore(block)};_.each(this.blocks,_.bind(blockIterator,this))},validateBlockTypesExist:function(should_validate){if(!this.required&&SirTrevor.SKIP_VALIDATION&&!should_validate)return!1;var blockTypeIterator=function(type){if(this._isBlockTypeAvailable(type))if(0===this._getBlockTypeCount(type))SirTrevor.log("Failed validation on required block type "+type),this.errors.push({text:"You must have a block of type "+type});else{var blocks=_.filter(this.blocks,function(b){return b.type==type&&!_.isEmpty(b.getData())});if(blocks.length>0)return!1;this.errors.push({text:"A required block type "+type+" is empty"}),SirTrevor.log("A required block type "+type+" is empty")}};_.each(this.required,_.bind(blockTypeIterator,this))},renderErrors:function(){if(0===this.errors.length)return!1;_.isUndefined(this.$errors)&&(this.$errors=$("<div>",{"class":"st-errors",html:"<p>You have the following errors: </p><ul></ul>"}),this.$outer.prepend(this.$errors));var str="";_.each(this.errors,function(error){str+='<li class="st-errors__msg">'+error.text+"</li>"}),this.$errors.find("ul").append(str),this.$errors.show()},removeErrors:function(){return 0===this.errors.length?!1:(this.$errors.hide(),this.$errors.find("ul").html(""),this.errors=[],void 0)},_getBlockTypeLimit:function(t){return this._isBlockTypeAvailable(t)?_.isUndefined(this.options.blockTypeLimits[t])?0:this.options.blockTypeLimits[t]:0},_isBlockTypeAvailable:function(t){return!_.isUndefined(this.blockTypes[t])},_ensureAndSetElements:function(){if(_.isUndefined(this.options.el)||_.isEmpty(this.options.el))return SirTrevor.log("You must provide an el"),!1;this.$el=this.options.el,this.el=this.options.el[0],this.$form=this.$el.parents("form");var $outer=$("<div>").attr({id:this.ID,"class":"st-outer",dropzone:"copy link move"}),$wrapper=$("<div>").attr({"class":"st-blocks"});return this.$el.wrap($outer).wrap($wrapper),this.$outer=this.$form.find("#"+this.ID),this.$wrapper=this.$form.find(".st-blocks"),!0},_setBlocksTypes:function(){this.blockTypes=flattern(_.isUndefined(this.options.blockTypes)?SirTrevor.Blocks:this.options.blockTypes)},_setRequired:function(){this.required=_.isArray(this.options.required)&&!_.isEmpty(this.options.required)?this.options.required:!1},baseCSS:function(additional){return this.options.baseCSSClass+"-"+additional}}),SirTrevor.bindFormSubmit=function(form){formBound||(SirTrevor.submittable(),form.bind("submit",this.onFormSubmit),formBound=!0)},SirTrevor.onBeforeSubmit=function(should_validate){var errors=0;return _.each(SirTrevor.instances,function(inst){errors+=inst.onFormSubmit(should_validate)}),SirTrevor.log("Total errors: "+errors),errors},SirTrevor.onFormSubmit=function(ev){var errors=SirTrevor.onBeforeSubmit();errors>0&&(SirTrevor.publish("onError"),ev.preventDefault())},SirTrevor.runOnAllInstances=function(method){_.has(SirTrevor.Editor.prototype,method)?([].unshift.call(arguments,SirTrevor.instances),_.invoke.apply(_,arguments)):SirTrevor.log("method doesn't exist")}})(jQuery,_);